<template>
  <div class="knowledge-content">
    <!-- 權限檢查 -->
    <template v-if="!isAuthenticated">
      <a-alert
        type="warning"
        message="請先登入"
        description="您需要登入後才能訪問知識庫。"
        show-icon
        closable
        style="margin-bottom: 24px"
      />
    </template>

    <!-- 主要內容 -->
    <template v-else>
      <!-- 錯誤提示 -->
      <a-alert
        v-if="error"
        type="error"
        :message="error"
        show-icon
        closable
        @close="handleClearError"
        style="margin-bottom: 24px"
      />

      <!-- 標籤頁導航 -->
      <a-tabs
        v-model:activeKey="activeTab"
        @change="handleTabChange"
        class="knowledge-tabs"
      >
        <a-tab-pane key="sop" tab="SOP" />
        <a-tab-pane key="faq" tab="FAQ" />
        <a-tab-pane key="resources" tab="資源中心" />
        <a-tab-pane key="attachments" tab="附件" />
      </a-tabs>

      <!-- 篩選器和操作區域 -->
      <a-card class="knowledge-toolbar-card" :bordered="false">
        <div class="toolbar-content">
          <!-- 第一行 -->
          <a-row :gutter="[16, 16]" class="toolbar-row">
            <a-col :xs="24" :sm="12" :md="6" :lg="4">
              <div class="toolbar-item">
                <span class="toolbar-label">搜尋</span>
                <SearchInput
                  v-model="filters.q"
                  placeholder="關鍵字"
                  @search="handleSearch"
                />
              </div>
            </a-col>

            <a-col :xs="24" :sm="12" :md="6" :lg="5">
              <div class="toolbar-item">
                <span class="toolbar-label">服務類型</span>
                <CustomSelect
                  v-model="filters.category"
                  placeholder="請選擇"
                  show-search
                  :filter-option="filterOption"
                  :suffix-icon="AppstoreOutlined"
                  @change="handleFilterChange"
                >
                  <a-select-option
                    v-for="service in services"
                    :key="getServiceId(service)"
                    :value="getServiceId(service)"
                  >
                    {{ getServiceName(service) }}
                  </a-select-option>
                </CustomSelect>
              </div>
            </a-col>

            <a-col :xs="24" :sm="12" :md="6" :lg="4">
              <div class="toolbar-item">
                <span class="toolbar-label">層級</span>
                <CustomSelect
                  v-model="filters.scope"
                  placeholder="請選擇"
                  :suffix-icon="BranchesOutlined"
                  @change="handleFilterChange"
                >
                  <a-select-option value="">全部</a-select-option>
                  <a-select-option value="service">服務層級</a-select-option>
                  <a-select-option value="task">任務層級</a-select-option>
                </CustomSelect>
              </div>
            </a-col>

            <a-col :xs="24" :sm="12" :md="6" :lg="7">
              <div class="toolbar-item">
                <span class="toolbar-label">客戶</span>
                <CustomSelect
                  v-model="filters.client"
                  placeholder="請選擇"
                  show-search
                  :filter-option="filterOption"
                  :suffix-icon="TeamOutlined"
                  @change="handleFilterChange"
                >
                  <a-select-option
                    v-for="client in clients"
                    :key="getClientId(client)"
                    :value="getClientId(client)"
                  >
                    {{ getClientName(client) }}
                  </a-select-option>
                </CustomSelect>
              </div>
            </a-col>

            <a-col :xs="24" :sm="12" :md="6" :lg="4">
              <div class="toolbar-item">
                <span class="toolbar-label">日期</span>
                <CustomDatePicker
                  v-model="datePicker"
                  picker="month"
                  format="YYYY-MM"
                  placeholder="選擇年月"
                  @change="handleDateChange"
                />
              </div>
            </a-col>
          </a-row>

          <!-- 第二行 -->
          <a-row :gutter="[16, 16]" class="toolbar-row" style="margin-top: 16px">
            <a-col :xs="24" :sm="12" :md="8" :lg="6">
              <div class="toolbar-item">
                <span class="toolbar-label">標籤</span>
                <CustomSelect
                  v-model="filters.tags"
                  mode="multiple"
                  placeholder="請選擇"
                  :suffix-icon="TagOutlined"
                  @change="handleFilterChange"
                >
                  <a-select-option
                    v-for="tag in tags"
                    :key="tag"
                    :value="tag"
                  >
                    {{ tag }}
                  </a-select-option>
                </CustomSelect>
              </div>
            </a-col>

            <a-col :xs="24" :sm="12" :md="8" :lg="4">
              <div class="toolbar-item">
                <a-button :icon="h(SettingOutlined)" @click="handleOpenTagManager" class="toolbar-button">
                  管理標籤
                </a-button>
              </div>
            </a-col>

            <a-col :xs="24" :sm="12" :md="8" :lg="6" :offset="lg >= 992 ? 8 : 0">
              <div class="toolbar-item toolbar-actions">
                <a-button
                  v-if="activeTab === 'sop'"
                  type="primary"
                  :icon="h(PlusOutlined)"
                  @click="handleAddSOP"
                  class="toolbar-button-primary"
                >
                  新增 SOP
                </a-button>
                <a-button
                  v-if="activeTab === 'faq'"
                  type="primary"
                  :icon="h(PlusOutlined)"
                  @click="handleAddFAQ"
                  class="toolbar-button-primary"
                >
                  新增 FAQ
                </a-button>
                <a-button
                  v-if="activeTab === 'resources'"
                  type="primary"
                  :icon="h(PlusOutlined)"
                  @click="handleAddDocument"
                  class="toolbar-button-primary"
                >
                  新增文檔
                </a-button>
                <a-button
                  v-if="activeTab === 'attachments'"
                  type="primary"
                  :icon="h(UploadOutlined)"
                  @click="handleUploadAttachment"
                  class="toolbar-button-primary"
                >
                  上傳附件
                </a-button>
              </div>
            </a-col>
          </a-row>
        </div>
      </a-card>

      <!-- 路由出口 -->
      <div class="knowledge-router-view">
        <router-view />
      </div>

      <!-- 標籤管理彈窗 -->
      <TagManagerModal
        v-model:visible="tagManagerVisible"
        :tags="tags"
        @update="handleTagsUpdate"
      />
    </template>
  </div>
</template>

<script setup>
import { ref, computed, watch, provide, h, onMounted, onUnmounted } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { useAuthStore } from '@/stores/auth'
import { useKnowledgeStore } from '@/stores/knowledge'
import { storeToRefs } from 'pinia'
import TagManagerModal from '@/components/knowledge/TagManagerModal.vue'
import SearchInput from '@/components/common/SearchInput.vue'
import CustomSelect from '@/components/common/CustomSelect.vue'
import CustomDatePicker from '@/components/common/CustomDatePicker.vue'
import {
  AppstoreOutlined,
  BranchesOutlined,
  TeamOutlined,
  CalendarOutlined,
  TagOutlined,
  SettingOutlined,
  PlusOutlined,
  UploadOutlined
} from '@ant-design/icons-vue'
import dayjs from 'dayjs'

// Router
const route = useRoute()
const router = useRouter()

// Store
const authStore = useAuthStore()
const knowledgeStore = useKnowledgeStore()

// 認證狀態
const isAuthenticated = computed(() => authStore.isAuthenticated)

// Store refs
const {
  filters,
  services,
  clients,
  tags,
  error
} = storeToRefs(knowledgeStore)

// 當前活動的標籤頁
const activeTab = ref('sop')

// 標籤管理彈窗顯示狀態
const tagManagerVisible = ref(false)

// 日期選擇器
const datePicker = ref(null)

// 處理日期變化
const handleDateChange = (date) => {
  if (date) {
    filters.value.year = date.format('YYYY')
    filters.value.month = date.format('MM')
  } else {
    filters.value.year = ''
    filters.value.month = ''
  }
  handleFilterChange()
}

// 監聽 filters 變化，同步 datePicker
watch(
  () => [filters.value.year, filters.value.month],
  ([year, month]) => {
    if (year && month) {
      datePicker.value = dayjs(`${year}-${month}`)
    } else {
      datePicker.value = null
    }
  },
  { immediate: true }
)

// 獲取服務 ID
const getServiceId = (service) => {
  return service.id || service.serviceId || service.service_id || service
}

// 獲取服務名稱
const getServiceName = (service) => {
  if (typeof service === 'string') return service
  return service.name || service.serviceName || service.service_name || service.title || service.service_title || String(service)
}

// 獲取客戶 ID
const getClientId = (client) => {
  return client.id || client.clientId || client.client_id
}

// 獲取客戶名稱
const getClientName = (client) => {
  return client.name || client.clientName || client.client_name || client.companyName || client.company_name || String(client)
}

// 下拉選項過濾函數
const filterOption = (input, option) => {
  const children = option.children || option.label || ''
  return children.toLowerCase().indexOf(input.toLowerCase()) >= 0
}

// 處理標籤頁切換
const handleTabChange = (key) => {
  activeTab.value = key
  const routes = {
    sop: '/knowledge/sop',
    faq: '/knowledge/faq',
    resources: '/knowledge/resources',
    attachments: '/knowledge/attachments'
  }
  if (routes[key]) {
    router.push(routes[key])
  }
}



// 處理搜尋
const handleSearch = () => {
  knowledgeStore.setFilters({ ...filters.value })
}

// 處理篩選條件變化
const handleFilterChange = () => {
  knowledgeStore.setFilters({ ...filters.value })
}

// 處理新增 SOP
const handleAddSOP = () => {
  addSOPTrigger.value++
}

// 處理新增 FAQ
const handleAddFAQ = () => {
  addFAQTrigger.value++
}

// 處理新增文檔
const handleAddDocument = () => {
  addDocumentTrigger.value++
}

// 處理上傳附件
const handleUploadAttachment = () => {
  addAttachmentTrigger.value++
}

// 處理打開標籤管理器
const handleOpenTagManager = () => {
  tagManagerVisible.value = true
}

// 處理標籤更新
const handleTagsUpdate = (newTags) => {
  if (newTags) {
    knowledgeStore.saveTags(newTags)
  }
  knowledgeStore.fetchTags()
}

// 處理清除錯誤
const handleClearError = () => {
  knowledgeStore.setError(null)
}

// 新增 SOP 觸發器（用於通知子組件）
const addSOPTrigger = ref(0)

// 新增 FAQ 觸發器（用於通知子組件）
const addFAQTrigger = ref(0)

// 新增文檔觸發器（用於通知子組件）
const addDocumentTrigger = ref(0)

// 上傳附件觸發器（用於通知子組件）
const addAttachmentTrigger = ref(0)

// Provide 給子組件
provide('addSOPTrigger', addSOPTrigger)
provide('addFAQTrigger', addFAQTrigger)
provide('addDocumentTrigger', addDocumentTrigger)
provide('addAttachmentTrigger', addAttachmentTrigger)

// 加載篩選器數據
const loadFilterData = async () => {
  try {
    await Promise.all([
      knowledgeStore.fetchServices(),
      knowledgeStore.fetchClients(),
      knowledgeStore.fetchTags()
    ])
  } catch (error) {
    console.error('加載篩選器數據失敗:', error)
  }
}

// 組件掛載時加載數據
onMounted(() => {
  if (isAuthenticated.value) {
    loadFilterData()
  }
})

// 監聽認證狀態變化，加載數據
watch(
  () => isAuthenticated.value,
  (authenticated) => {
    if (authenticated) {
      loadFilterData()
    }
  }
)

// 根據路由設置活動標籤頁
watch(
  () => route.path,
  (path) => {
    if (path.includes('/knowledge/sop')) {
      activeTab.value = 'sop'
    } else if (path.includes('/knowledge/faq')) {
      activeTab.value = 'faq'
    } else if (path.includes('/knowledge/resources')) {
      activeTab.value = 'resources'
    } else if (path.includes('/knowledge/attachments')) {
      activeTab.value = 'attachments'
    }
  },
  { immediate: true }
)

// 組件卸載時清理防抖計時器
onUnmounted(() => {
  // 組件卸載時的清理工作
})
</script>

<style scoped>
.knowledge-content {
  padding: 24px;
  min-height: calc(100vh - 64px);
}

/* 標籤頁 */
.knowledge-tabs {
  margin-bottom: 16px;
}

.knowledge-tabs :deep(.ant-tabs-nav) {
  margin-bottom: 0;
}

/* 工具欄卡片 */
.knowledge-toolbar-card {
  margin-bottom: 16px;
}

.knowledge-toolbar-card :deep(.ant-card-body) {
  padding: 16px;
}

.toolbar-content {
  width: 100%;
}

.toolbar-row {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
}

.toolbar-item {
  display: flex;
  align-items: center;
  height: 32px;
  margin-bottom: 0;
}

.toolbar-label {
  display: inline-block;
  width: 70px;
  flex-shrink: 0;
  height: 32px;
  line-height: 32px;
  font-size: 14px;
  color: #333;
  font-weight: 500;
  margin-right: 8px;
  text-align: right;
}


.toolbar-date-picker {
  flex: 1;
  height: 32px;
  width: 100%;
}

.toolbar-date-picker :deep(.ant-picker) {
  height: 32px !important;
  width: 100%;
  padding: 0 11px;
}

.toolbar-date-picker :deep(.ant-picker-input) {
  height: 32px;
}

.toolbar-date-picker :deep(.ant-picker-input > input) {
  height: 30px !important;
  line-height: 30px !important;
  padding: 0;
}

/* 工具欄選擇器樣式已移至自定義組件中 */

/* 日期選擇器樣式已移至自定義組件中 */


.toolbar-button {
  height: 32px;
  padding: 4px 15px;
}

.toolbar-button-primary {
  height: 32px;
  padding: 4px 15px;
}

.toolbar-actions {
  justify-content: flex-end;
}

.toolbar-actions .toolbar-label {
  display: none;
}

/* 路由視圖區域 */
.knowledge-router-view {
  margin-top: 0;
  min-height: calc(100vh - 400px);
}

/* 響應式設計 */
@media (max-width: 992px) {
  .knowledge-content {
    padding: 16px;
  }
}
</style>
