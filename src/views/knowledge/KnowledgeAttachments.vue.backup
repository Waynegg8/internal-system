<template>
  <div class="knowledge-attachments-content">
    <!-- 成功提示 -->
    <a-alert
      v-if="successMessage"
      type="success"
      :message="successMessage"
      show-icon
      closable
      @close="successMessage = ''"
      style="margin-bottom: 16px"
    />
    
    <!-- 錯誤提示 -->
    <a-alert
      v-if="errorMessage"
      type="error"
      :message="errorMessage"
      show-icon
      closable
      @close="errorMessage = ''"
      style="margin-bottom: 16px"
    />
    
    <!-- 信息提示 -->
    <a-alert
      v-if="infoMessage"
      type="info"
      :message="infoMessage"
      show-icon
      closable
      @close="infoMessage = ''"
      style="margin-bottom: 16px"
    />
    
    <!-- 附件專用篩選區域（補充父組件的篩選器） -->
    <a-card style="margin-bottom: 16px" class="attachment-extra-filters">
      <a-row :gutter="16" align="middle">
        <a-col :xs="24" :sm="12" :md="8" :lg="6">
          <a-form-item style="margin-bottom: 0; width: 100%">
            <a-select
              v-model:value="attachmentFilters.type"
              placeholder="附件類型"
              allow-clear
              style="width: 100%"
              @change="handleFilterChange"
            >
              <a-select-option value="">全部類型</a-select-option>
              <a-select-option value="task">任務附件</a-select-option>
              <a-select-option value="client">客戶附件</a-select-option>
              <a-select-option value="receipt">收據附件</a-select-option>
            </a-select>
          </a-form-item>
        </a-col>
        <a-col :xs="24" :sm="12" :md="8" :lg="6">
          <a-statistic 
            title="附件總數" 
            :value="attachmentPagination.total" 
            :value-style="{ fontSize: '20px' }"
          />
        </a-col>
      </a-row>
    </a-card>

    <!-- 附件網格列表 -->
    <a-spin :spinning="attachmentLoading">
      <a-row :gutter="16" v-if="attachments.length > 0">
        <a-col
          v-for="attachment in attachments"
          :key="getAttachmentId(attachment)"
          :xs="24"
          :sm="12"
          :md="8"
          :lg="6"
          style="margin-bottom: 16px"
        >
          <a-card
            :hoverable="true"
            class="attachment-card"
            @click="handleDownloadAttachment(attachment)"
          >
            <template #cover>
              <div class="attachment-icon">
                <FileOutlined style="font-size: 48px; color: #1890ff" />
              </div>
            </template>
            <a-card-meta>
              <template #title>
                <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap">
                  {{ getAttachmentTitle(attachment) }}
                </div>
              </template>
              <template #description>
                <div style="font-size: 12px; color: #999">
                  <div>{{ formatFileSize(attachment) }}</div>
                  <div>{{ formatUploadTime(attachment) }}</div>
                  <div v-if="getAttachmentRelation(attachment)" style="margin-top: 4px">
                    {{ getAttachmentRelation(attachment) }}
                  </div>
                </div>
              </template>
            </a-card-meta>
            <template #actions>
              <DeleteOutlined style="color: #ff4d4f; cursor: pointer" @click.stop="handleDeleteAttachment(attachment)" />
            </template>
          </a-card>
        </a-col>
      </a-row>

      <!-- 空狀態 -->
      <a-empty
        v-else
        description="尚無附件"
        style="padding: 40px 0"
      />
    </a-spin>

    <!-- 分頁 -->
    <div
      v-if="attachmentPagination.total > attachmentPagination.perPage"
      style="margin-top: 16px; text-align: center"
    >
      <a-pagination
        v-model:current="attachmentPagination.page"
        v-model:page-size="attachmentPagination.perPage"
        :total="attachmentPagination.total"
        :page-size-options="['10', '20', '50', '100']"
        show-size-changer
        show-total
        @change="handlePaginationChange"
        @show-size-change="handlePaginationChange"
      />
    </div>

    <!-- 附件上傳抽屜 -->
    <AttachmentUploadDrawer
      v-model:visible="drawerVisible"
      @close="handleDrawerClose"
      @success="handleDrawerSuccess"
    />
  </div>
</template>

<script setup>
import { ref, computed, inject, onMounted, watch } from 'vue'
import { useKnowledgeStore } from '@/stores/knowledge'
import { storeToRefs } from 'pinia'
import { usePageAlert } from '@/composables/usePageAlert'
import { FileOutlined, DeleteOutlined } from '@ant-design/icons-vue'
import AttachmentUploadDrawer from '@/components/knowledge/AttachmentUploadDrawer.vue'
import { downloadAttachment } from '@/api/knowledge'

// Store
const knowledgeStore = useKnowledgeStore()
const { successMessage, errorMessage, infoMessage, showSuccess, showError, showInfo } = usePageAlert()
const {
  attachments,
  attachmentPagination,
  attachmentLoading,
  attachmentFilters,
  filters,
  clients
} = storeToRefs(knowledgeStore)

// Inject addAttachmentTrigger from parent
const addAttachmentTrigger = inject('addAttachmentTrigger', ref(0))

// Local state
const drawerVisible = ref(false)

// 獲取附件 ID
const getAttachmentId = (attachment) => {
  return attachment.id || attachment.attachmentId || attachment.attachment_id
}

// 獲取附件標題
const getAttachmentTitle = (attachment) => {
  return attachment.title || attachment.attachment_title || attachment.fileName || attachment.file_name || attachment.name || '無標題'
}

// 格式化文件大小
const formatFileSize = (attachment) => {
  const size = attachment.fileSize || attachment.file_size || attachment.size || 0
  if (size === 0) return '未知大小'
  
  if (size < 1024) {
    return size + ' B'
  } else if (size < 1024 * 1024) {
    return (size / 1024).toFixed(1) + ' KB'
  } else {
    return (size / (1024 * 1024)).toFixed(1) + ' MB'
  }
}

// 格式化上傳時間
const formatUploadTime = (attachment) => {
  const time = attachment.createdAt || attachment.created_at || attachment.uploadTime || attachment.upload_time
  if (!time) return '未知時間'
  
  try {
    const date = new Date(time)
    return date.toLocaleString('zh-TW', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    })
  } catch (error) {
    return time
  }
}

// 獲取附件關聯信息
const getAttachmentRelation = (attachment) => {
  const relations = []
  
  if (attachment.clientName || attachment.client_name) {
    relations.push(`客戶: ${attachment.clientName || attachment.client_name}`)
  }
  
  if (attachment.taskName || attachment.task_name) {
    relations.push(`任務: ${attachment.taskName || attachment.task_name}`)
  }
  
  if (attachment.receiptId || attachment.receipt_id) {
    relations.push(`收據: ${attachment.receiptId || attachment.receipt_id}`)
  }
  
  return relations.length > 0 ? relations.join(', ') : null
}

// 獲取客戶 ID
const getClientId = (client) => {
  return client.id || client.clientId || client.client_id
}

// 獲取客戶名稱
const getClientName = (client) => {
  return client.name || client.clientName || client.client_name || client.companyName || client.company_name || String(client)
}

// 下拉選項過濾函數
const filterOption = (input, option) => {
  const children = option.children || option.label || ''
  return children.toLowerCase().indexOf(input.toLowerCase()) >= 0
}

// 上傳附件（由父組件觸發）
const handleUploadAttachment = () => {
  drawerVisible.value = true
}

// 刪除附件
const handleDeleteAttachment = async (attachment) => {
  const attachId = getAttachmentId(attachment)
  try {
    await knowledgeStore.deleteAttachment(attachId)
    showSuccess('附件已刪除')
    // 重新載入列表
    loadAttachments()
  } catch (error) {
    console.error('刪除附件失敗:', error)
    showError(error.message || '刪除附件失敗')
  }
}

// 下載附件
const handleDownloadAttachment = async (attachment) => {
  const attachId = getAttachmentId(attachment)
  try {
    const blob = await downloadAttachment(attachId)
    const url = URL.createObjectURL(blob)
    const link = document.createElement('a')
    link.href = url
    
    // 獲取文件名
    const fileName = getAttachmentTitle(attachment) || `attachment_${attachId}`
    const fileExtension = attachment.fileExtension || attachment.file_extension || attachment.extension || ''
    const fullFileName = fileExtension ? `${fileName}.${fileExtension}` : fileName
    
    link.download = fullFileName
    document.body.appendChild(link)
    link.click()
    document.body.removeChild(link)
    URL.revokeObjectURL(url)
    
    showSuccess('下載成功')
  } catch (error) {
    console.error('下載附件失敗:', error)
    showError(error.message || '下載附件失敗')
  }
}

// 抽屜關閉
const handleDrawerClose = () => {
  drawerVisible.value = false
}

// 抽屜上傳成功
const handleDrawerSuccess = () => {
  // 重新載入列表
  loadAttachments()
}

// 篩選條件變化
const handleFilterChange = () => {
  // 重置分頁到第一頁
  knowledgeStore.setAttachmentPagination({ page: 1 })
  loadAttachments()
}

// 監聽父組件的篩選條件變化
watch(
  () => filters.value,
  () => {
    // 同步父組件的篩選條件到附件篩選器
    knowledgeStore.setAttachmentFilters({
      ...attachmentFilters.value,
      q: filters.value.q || '',
      client: filters.value.client || ''
    })
    knowledgeStore.setAttachmentPagination({ page: 1 })
    loadAttachments()
  },
  { deep: true }
)

// 分頁變化
const handlePaginationChange = () => {
  loadAttachments()
}

// 載入附件列表
const loadAttachments = async () => {
  try {
    await knowledgeStore.fetchAttachments()
  } catch (error) {
    console.error('載入附件列表失敗:', error)
  }
}

// 組件掛載時載入數據
onMounted(() => {
  loadAttachments()
})

// 監聽 addAttachmentTrigger 變化，打開上傳抽屜
watch(
  () => addAttachmentTrigger.value,
  () => {
    if (addAttachmentTrigger.value > 0) {
      handleUploadAttachment()
    }
  }
)
</script>

<style scoped>
.knowledge-attachments-content {
  padding: 0;
}

.attachment-extra-filters :deep(.ant-form-item) {
  margin-bottom: 0;
  display: flex;
  align-items: center;
}

.attachment-extra-filters :deep(.ant-form-item-control) {
  flex: 1;
}

.attachment-extra-filters :deep(.ant-select) {
  height: 32px;
  line-height: 32px;
}

.attachment-extra-filters :deep(.ant-select-selector) {
  height: 32px;
  line-height: 32px;
}

.attachment-extra-filters :deep(.ant-select-selection-item),
.attachment-extra-filters :deep(.ant-select-selection-placeholder) {
  line-height: 30px;
}

.attachment-card {
  cursor: pointer;
  height: 100%;
}

.attachment-icon {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 120px;
  background: #f5f5f5;
}
</style>
