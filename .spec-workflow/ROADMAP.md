# 開發 Roadmap

## 概述

本文檔列出所有待完成任務的依存關係和建議執行順序。任務按優先級和依存關係分組，確保開發流程順暢。

---

## Phase 1: 核心基礎設施（優先級：最高）

### 1.1 BR1 客戶計費邏輯重構（關鍵依賴）
**影響範圍**：BR13、BR14 月報/年報的營收計算

#### 任務順序：
1. **BR1.3.3** - 客戶計費詳情重構
   - 1.2 建立新的計費計劃模型
   - 1.3 建立計費計劃數據模型
   - 2.1 建立 BillingPlanModel 數據模型
   - 2.2 建立計費計劃 CRUD API
   - 2.3 建立年度計費計劃管理
   - 3.1 重構計費計劃管理 API
   - 3.2 建立計費計劃查詢 API
   - 3.3 任務模板關聯更新
   - 4.1 建立計費計劃前端組件
   - 5.1 重構計費計劃編輯表單
   - 5.2 建立年度計費計劃組件
   - 6.1 建立計費計劃列表組件
   - 6.2 建立計費計劃詳情組件
   - 7.1 建立計費計劃編輯組件
   - 7.2 建立計費計劃管理 API 整合
   - 8.1 建立單元測試和整合測試
   - 8.2 建立 E2E 測試和性能測試
   - 8.3 建立數據遷移腳本

**完成後才能進行**：BR13、BR14 的營收計算邏輯更新

---

## Phase 2: 報表系統（依賴 Phase 1）

### 2.1 BR13 月報（依賴 BR1.3.3）
**前置條件**：BR1 計費邏輯重構完成

#### 任務順序：
1. 實現 BR1 應計營收邏輯
2. 修改 getMonthlyRevenueByClient 使用 BR1 邏輯
3. 修改 allocateRevenueByServiceType 使用 BR1 邏輯
4. 修改 computeMonthlyEmployeePerformance 使用標準工時
5. 修改所有報表 Handler 支援 refresh 參數
6. 修改前端 API 層支援 refresh 參數
7. 修改 MonthlyReports.vue 實現自動載入
8. 修改 MonthlyReports.vue 新增統一刷新按鈕
9. 修改錯誤處理顯示詳細錯誤
11. 更新快取鍵格式
12. 實現 E2E 測試

### 2.2 BR14 年報（依賴 BR1.3.3）
**前置條件**：BR1 計費邏輯重構完成、BR13 月報完成

#### 任務順序：
3. 修改員工績效計算使用標準工時
4. 修改員工績效計算包含年度間接成本分配
5. 客戶獲利能力計算使用 BR1 邏輯
6. 修改客戶獲利能力計算使用員工實際時薪
7. 修改客戶獲利能力計算收入分配使用 BR1 邏輯
8. 所有年報 Handler 新增快取支援
9. 修改所有年報 Handler 支援 refresh 參數
10. 實現年報自動載入功能
11. 修改前端年報組件新增統一刷新按鈕
12. 修改錯誤處理顯示詳細錯誤
13. 修改年報 API 層支援 refresh 參數
17. 實現 E2E 測試

---

## Phase 3: 任務系統核心功能

### 3.1 BR2.3 任務建立（優先級：高）
**影響範圍**：任務自動生成、任務模板管理

#### 任務順序：
1. **後端日期計算邏輯**
   - 2.2.1 實現任務生成時間計算工具
   - 2.2.2 實現任務到期日計算工具
   - 7.1.1 實現生成時間計算邏輯
   - 7.2.1 實現到期日計算邏輯

2. **前端組件**
   - 2.3.1 實現任務規則選擇組件
   - 3.1.1 實現前端日期計算工具
   - 3.2.1 實現服務層級任務預覽功能
   - 3.3.1 實現任務模板關聯選擇功能
   - 4.1.1 實現 SOP 自動選擇功能
   - 5.1.1 實現任務預覽功能
   - 5.2.1 實現規則預覽功能
   - 6.1.1 實現服務層級任務預覽
   - 6.2.1 實現任務模板關聯預覽
   - 8.1.1 實現任務預覽功能
   - 8.2.1 實現規則預覽功能
   - 9.1.1 實現批量任務建立功能
   - 10.1.1 實現錯誤處理和驗證功能
   - 11.1.1 實現任務模板驗證功能

3. **API 和測試**
   - 14.1.1 更新 API 文檔
   - 14.1.2 更新測試文檔
   - 15.1.1 更新任務模板
   - 16.1.1 實現任務建立
   - 17.1.1 檢查前端日期計算工具
   - 17.2.1 實現任務規則選擇組件
   - 17.3.1 實現任務生成時間計算工具
   - 17.3.2 實現任務到期日計算工具
   - 17.4.1 實現服務層級 SOP 選擇組件
   - 17.5.1 新增預設任務模板關聯
   - 17.5.2 顯示所有模板組件
   - 17.6.1 實現服務層級任務預覽功能
   - 17.7.1 實現任務模板關聯預覽
   - 17.8.1 實現任務建立功能
   - 12.1.1 編寫 E2E 測試
   - 13.1.1 實現任務模板預覽功能

### 3.2 BR2.5 任務自動生成（依賴 BR2.3）
**前置條件**：BR2.3 日期計算邏輯完成

#### 任務順序：
1. 修改 Cron 任務生成時間為 02:00
2. 增強任務生成預覽功能
3. 實現任務生成時間計算邏輯
4. 新增任務模板關聯
5. 增強任務生成預覽功能
6. 實現任務生成時間計算邏輯
7. 新增任務模板關聯
8. 增強任務生成預覽功能
9. 實現預設任務模板關聯功能
10. 增強任務生成預覽 API
11. 實現任務生成預覽功能 API
12. 實現任務生成預覽前端組件
13. 增強任務生成預覽組件
14. 編寫 E2E 測試

### 3.3 BR2.6 任務通知（依賴 BR2.5）
**前置條件**：任務自動生成完成

#### 任務順序：
1. 建立 TaskNotificationHistory 表
2. 實現通知檢查邏輯
   - 2.1 實現任務逾期檢查邏輯
   - 2.2 實現任務即將到期檢查邏輯
   - 2.3 實現前置任務完成檢查邏輯
   - 2.4 實現預設任務模板衝突檢查邏輯
3. 實現通知發送邏輯
   - 3.1 實現通知發送頻率控制
   - 3.2 實現通知發送邏輯
4. 實現 Cron 觸發器
5. 實現通知 API
   - 5.1 實現通知查詢 API
   - 5.2 實現通知標記已讀 API
   - 5.3 建立通知相關路由
6. 實現前端組件
   - 6.1 實現通知列表前端組件
   - 6.2 增強 Dashboard 通知面板
   - 6.3 實現通知 API 整合
7. 編寫 E2E 測試

### 3.4 BR2.1 任務列表增強
#### 任務順序：
1. 實現任務可開始狀態計算邏輯
2. 實現可開始狀態顯示
3. 建立 task-stats.js Handler
4. 新增統計相關路由
5. 建立 task-batch.js Handler
6. 新增批量操作相關路由
7. 新增統計和批量操作 API 層
8. 新增統計卡片組件顯示
9. 實現預設任務模板關聯和位置
10. 新增客戶服務關聯顯示
11. 實現可開始狀態顯示功能
12. 實現「我的任務」顯示功能
13. 增強統計卡片和刷新功能
14. 修改統計卡片顯示 BR2.1 需求
15. 實現批量操作確認和提示功能
16. 實現操作確認和結果處理
17. 實現操作確認和結果處理
18. 實現操作確認和結果處理
19. 新增預設任務模板關聯選項
20. 前端組件預設任務模板關聯功能
21. 建立任務列表 E2E 測試
22. 建立列表顯示 E2E 測試
23. 建立統計和批量操作 E2E 測試
24. 建立刷新功能 E2E 測試

### 3.5 BR2.4 任務模板管理
#### 任務順序：
1. 實現搜尋和篩選
2. 實現排序功能
3. 實現模板套用策略邏輯
4. 實現模板套用策略選擇
5. 建立批量操作確認 Handler
6. 建立批量更新和刪除 Handler
7. 建立批量操作和階段任務模板 Handler
8. 新增搜尋和排序相關路由
9. 實現任務模板建立 API
10. 實現任務模板更新 API
11. 實現任務模板刪除 API
12. 實現批量操作 API 整合
13. 新增搜尋和排序功能
14. 新增模板套用策略和客戶關聯
15. 實現批量操作組件
16. 實現批量操作確認和提示功能
17. 實現模板刪除確認對話框（增強）
18. 檢查 TaskConfiguration 組件是否支援模板套用
19. 實現模板套用功能（如需要）
20. 新增搜尋和排序相關 API 整合
21. 建立任務模板列表 E2E 測試
22. 建立任務模板建立和更新 E2E 測試
23. 建立任務模板刪除 E2E 測試
24. 建立批量操作 E2E 測試
25. 建立模板套用 E2E 測試

---

## Phase 4: 附件和資源管理

### 4.1 BR12 附件系統（獨立模組）
#### 任務順序：

**BR12.1 附件上傳**
1. 修正後端上傳簽名 API Handler（調整大小限制和文件類型）
2. 建立文件驗證工具函數
3. 增強附件上傳組件（支援多文件上傳）
4. 新增文件類型驗證組件
5. 更新前端文件驗證組件
6. 實現 E2E 測試

**BR12.2 附件列表**
1. 增強附件列表 API Handler 以 JOIN 實體表
2. 建立和整合附件過濾 API 前端組件
3. 實現附件過濾組件
4. 實現附件列表組件
5. 增強知識庫附件頁面整合（如需要，可能需要增強）
6. 實現附件列表顯示功能
7. 實現 E2E 測試

**BR12.3 附件預覽**
1. 建立文件類型工具函數
2. 增強附件預覽組件響應式布局
3. 增強附件預覽組件錯誤處理
4. 增強附件預覽組件重試邏輯
5. 建立圖片預覽單元測試
6. 建立文本預覽單元測試
7. 建立整合測試

**BR12.4 附件下載/刪除**
1. 修正附件刪除 API Handler（從 UPDATE 改為物理 DELETE）
2. 新增刪除確認對話框
3. 實現 E2E 測試

### 4.2 BR11 資源管理（獨立模組）
#### 任務順序：

**BR11.3 資源預覽**
1. 實現預覽 URL 簽名 API Handler
2. 新增預覽 URL 路由
3. 新增前端 API 整合
4. 增強 DocumentPreview 組件 - Office 文件預覽
5. 實現 E2E 測試

**BR11.4 資源管理**
1. 實現批量刪除 API Handler
2. 新增批量刪除相關路由
3. 新增前端編輯 API 整合
4. 新增前端刪除 API 整合
5. 增強上傳抽屜支援編輯模式
6. 增強批量操作抽屜支援編輯功能
7. 實現前端批量刪除功能
8. 增強編輯 API 支援文件替換
9. 修正批量刪除 API 支援部分失敗
10. 修正資源刪除 API 移除 R2 刪除（軟刪除）
11. 實現 E2E 測試

---

## Phase 5: 系統設定和配置

### 5.1 BR16 系統設定（獨立模組，可並行開發）

**BR16.1 服務設定**
1. 修改後端服務刪除 API 為硬刪除
2. 修改前端服務列表表格顯示欄位
3. 實現 E2E 測試

**BR16.2 任務模板設定**
1. 修正後端任務模板刪除 API 註釋
2. 實現模板套用策略邏輯
3. 實現 E2E 測試

**BR16.3 用戶管理**
1. 修改後端使用者刪除 API 為硬刪除
2. 移除員工個人資料中的電子郵件欄位
3. 移除 SettingsUsers.vue 中與電子郵件相關的邏輯
4. 實現使用者列表排序和搜尋功能
5. 實現查看使用者密碼功能
6. 實現重置使用者密碼功能
7. 實現員工個人資料編輯功能
8. 編寫單元測試
9. 編寫整合測試
10. 編寫端到端測試

**BR16.4 公司設定**
1. 補完未保存變更提示功能
2. 編寫單元測試
3. 編寫整合測試
4. 編寫端到端測試

**BR16.5 自動化規則**
1. 修正後端 API 權限：移除 handleAutomation 中的管理員權限檢查
2. 實現搜尋和篩選功能
3. 編寫單元測試
4. 編寫整合測試
5. 編寫端到端測試

**BR16.6 國定假日設定**
1. 新增刪除確認對話框
2. 編寫單元測試
3. 編寫整合測試
4. 編寫端到端測試

---

## Phase 6: 其他功能模組

### 6.1 BR3 收據管理（獨立模組）
#### 任務順序：

**BR3.1 收據列表**
- 實現 E2E 測試

**BR3.2 收據詳情**
1. 修正收據 ID
2. 修正狀態修改限制
3. 實現收據 ID 唯一性檢查
4. 實現總金額驗證
5. 修正取消邏輯
6. 修正收據取消相關邏輯
7. 修正收據取消
8. 新增收據取消確認和提示功能
9. 新增取消確認和結果處理
10. 檢查列印功能是否支援已取消收據
11. 實現收據詳情 E2E 測試

**BR3.3 收據建立**
1. 實現金額調整原因處理
2. 實現計費提醒狀態更新
3. 實現金額調整原因輸入
4. 實現多服務選擇和金額建議
5. 新增多服務選擇組件（如需要）
6. 新增計費提醒狀態更新邏輯（如需要）
7. 實現收據建立 E2E 測試

**BR3.4 收據付款**
1. 修正付款金額超過未付金額的驗證邏輯
2. 實現更新付款記錄 API
3. 實現刪除付款記錄 API
4. 實現查詢付款記錄歷史 API（如需要）
5. 實現新增付款記錄表單
6. 實現付款金額超過未付金額的驗證錯誤提示
7. 實現新增付款記錄表單（如需要）
8. 實現累計金額顯示
9. 實現新增和刪除操作確認
10. 實現新增付款記錄表單
11. 實現付款記錄 E2E 測試

**BR3.5 收據對帳**
1. 實現多服務選擇和自動完成標記
2. 實現自動重新顯示已延後提醒
3. 實現多服務選擇組件
4. 顯示多服務選擇組件在收據列表頁面
5. 新增自動重新顯示已延後提醒邏輯（如需要）
6. 實現對帳 E2E 測試

### 6.2 BR4 薪資管理（獨立模組）
#### 任務順序：

**BR4.1 薪資計算**
1. 實現詳細薪資 API Handler
2. 實現詳細薪資列印 API Handler
3. 新增詳細薪資和列印 API 路由
4. 修正前端薪資計算組件（詳細薪資和列印）
5. 建立詳細薪資前端組件（如需要）
6. 建立詳細薪資列印組件（如需要）
7. 建立詳細薪資列印組件（如需要）
8. 建立員工列印組件（如需要）
9. 實現薪資計算 E2E 測試

**BR4.2 薪資設定**
1. 實現員工薪資項目設定 API Handler（新增快取）
2. 實現薪資項目 CRUD API Handler（新增快取）
3. 新增快取相關路由（如需要）
4. 修正前端 API 整合（新增快取，如需要）
5. 實現薪資項目設定列表和編輯組件
6. 修正薪資項目設定前端組件支援員工薪資項目設定
7. 實現薪資設定 E2E 測試

**BR4.4 系統設定調整**
1. 加強表單驗證規則
2. 實現系統設定 E2E 測試

### 6.3 BR5 成本管理（獨立模組）
#### 任務順序：

**BR5.2 成本記錄**
1. 修正成本記錄邏輯符合需求規範
2. 修正客戶查詢支援客戶名稱
3. 修正年度查詢
4. 修正新增功能以支援年度、月份、日期
5. 修正刪除功能為硬刪除
6. 實現成本記錄管理 E2E 測試

**BR5.3 成本模板**
1. 檢查是否需要建立新的 CostTemplates 表
2. 建立 CostTemplates 數據遷移和相關邏輯（如需要）
3. 實現模板列表查詢 API Handler（如需要）
4. 實現模板建立 API Handler
5. 實現模板刪除 API Handler
6. 修正前端 API 整合（如需要）
7. 實現前端選擇和建立模板功能（如需要）
8. 實現模板列表組件（如需要）
9. 修正前端組件邏輯（如需要）
10. 新增前端組件邏輯（如需要）
11. 實現選擇和建立模板 E2E 測試

**BR5.5 員工成本分析**
1. 修正間接成本分配詳細分解
2. 修正展開功能
3. 實現員工成本分析 E2E 測試

**BR5.6 客戶成本分析**
1. 修正客戶任務成本間接成本分配詳細分解
2. 修正客戶任務成本展開功能
3. 修正客戶任務成本展開功能
4. 實現成本詳細分解組件（如需要）
5. 實現客戶成本分析 E2E 測試

### 6.4 BR6 工時管理（獨立模組）
#### 任務順序：

**BR6.1 工時填寫**
1. 實現動態載入邏輯（service_item_id 和 task_type）
2. 實現動態載入邏輯（task_type 和 service_item_id）
3. 確認工時單日上限驗證（24 小時上限）
4. 實現工時填寫 E2E 測試

**BR6.2 工時規則校驗**
- 實現工時規則校驗 E2E 測試

**BR6.3 工時顯示**
- 實現工時顯示功能 E2E 測試

**BR6.4 工時管理**
1. 建立員工篩選前端組件
2. 新增 Timesheets 表支援員工篩選
3. 增強錯誤處理和統一刷新
4. 編寫單元測試
5. 編寫整合測試

### 6.5 BR7 請假管理（獨立模組）
#### 任務順序：
1. 實現請假申請 API Handler（包含餘額檢查和 FIFO 邏輯）
2. 實現請假更新 API Handler（包含餘額檢查和更新 FIFO 邏輯）
3. 實現請假刪除 API Handler（包含餘額檢查和 FIFO 邏輯）
4. 實現請假餘額自動更新功能
5. 修正前端請假申請表單數據驗證（日期類型檢查）
6. 修正數據驗證邏輯（日期類型）
7. 建立請假管理 E2E 測試和文檔

### 6.6 BR8 外出管理（獨立模組）
#### 任務順序：

**BR8.1 外出列表**
1. 客戶外出記錄列表組件和相關功能
2. 建立外出記錄列表 E2E 測試和文檔

**BR8.2 外出建立**
1. 建立數據遷移 Migration（新增時間欄位和任務關聯）
2. 增強建立外出記錄 API Handler（支援時間欄位和任務關聯）
3. 增強更新外出記錄 API Handler（支援時間欄位和任務關聯）
4. 新增外出記錄表單組件（新增時間欄位和任務關聯）
5. 實現 E2E 測試（trip-creation.spec.ts）

### 6.7 BR9 SOP 管理（獨立模組）
#### 任務順序：
1. 修正 ManageSOPModal 組件，新增 clientId prop 和過濾邏輯
2. 修正 TaskSOPList 組件，新增 clientId prop 並傳遞給 ManageSOPModal
3. 修正 TasksNew 組件，實現服務層級 SOP 自動選擇
4. 修正 TasksNew 組件，實現任務層級 SOP 自動選擇
5. 新增任務詳情頁面 SOP 管理，加入 clientId 到 TaskSOPList
6. 實現 SOP 自動選擇相關邏輯（參考 BR10 FAQ 建立）
7. 實現 SOP 建立功能
8. 實現 SOP 刪除功能
9. 檢查後端 API 刪除功能是否已實現
10. 建立 E2E 測試：SOP 自動選擇功能
11. 建立 E2E 測試：SOP 可見性過濾
12. 檢查前端刪除確認功能
13. 建立 E2E 測試：SOP 建立和刪除功能

### 6.8 BR10 FAQ 管理（獨立模組）
#### 任務順序：

**BR10.3 FAQ 建立**
1. 實現 E2E 測試
2. 實現標籤系統自動提取（部分實現）

**BR10.4 FAQ 編輯**
1. 實現 E2E 測試
2. 修正後端更新 API 支援 scope 欄位處理
3. 實現前端權限檢查
4. 實現刪除確認對話框（可選實現）

### 6.9 BR15 Dashboard（依賴 BR2.6）
**前置條件**：BR2.6 任務通知完成

#### 任務順序：
1. 增強 DashboardAlertsPanel 組件以整合 BR2.6 通知邏輯
2. 增強 AdminDashboard 組件以顯示統計數據
3. 建立員工統計數據顯示組件
4. 增強 handleDashboardAlerts 以整合 BR2.6 通知邏輯和日誌
5. 編寫 E2E 測試 - 通知管理功能
6. 編寫 E2E 測試 - 統計數據顯示

---

## Phase 7: 測試和文檔（最後階段）

### 7.1 E2E 測試
所有模組的 E2E 測試應在功能開發完成後進行，但可以與功能開發並行準備測試用例。

### 7.2 API 文檔更新
- BR2.3 任務建立 API 文檔
- 其他新增或修改的 API 文檔

---

## 執行建議

### 優先級 1（立即開始）
- **Phase 1**: BR1.3.3 客戶計費邏輯重構（阻塞 BR13/BR14）

### 優先級 2（Phase 1 完成後）
- **Phase 2**: BR13/BR14 報表系統
- **Phase 3.1**: BR2.3 任務建立核心邏輯

### 優先級 3（可並行開發）
- **Phase 4**: 附件和資源管理
- **Phase 5**: 系統設定
- **Phase 6**: 其他功能模組（BR3-BR10）

### 優先級 4（最後階段）
- **Phase 7**: 測試和文檔

---

## 關鍵依存關係圖

```
BR1.3.3 (客戶計費重構)
    ↓
BR13 (月報) ──→ BR14 (年報)
    ↓
BR2.3 (任務建立) ──→ BR2.5 (任務自動生成) ──→ BR2.6 (任務通知) ──→ BR15 (Dashboard)
    ↓
BR2.1, BR2.2, BR2.4 (其他任務功能)

其他模組（BR3-BR12, BR16）可獨立並行開發
```

---

## 注意事項

1. **BR1.3.3 是關鍵阻塞點**：必須優先完成，否則 BR13/BR14 無法正確計算營收
2. **BR2.3 → BR2.5 → BR2.6 → BR15** 有明確的依賴鏈，需按順序完成
3. **其他模組可並行開發**：BR3-BR12、BR16 等模組相對獨立，可以並行開發
4. **E2E 測試**：建議在功能開發完成後立即進行，但測試用例可以提前準備
5. **API 文檔**：建議在 API 開發完成後立即更新文檔



