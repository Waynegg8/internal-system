# Requirements Document: BR13: 月報表（Monthly Reports）

## Introduction

提供月份層級的經營數據視圖，包含營收、薪資、客戶獲利、員工績效等，用於月度營運檢視與管理決策。

本功能是會計師事務所內部管理系統的報表分析核心模組之一，提供統一的月度報表查看界面，幫助管理員快速了解月度經營狀況、客戶獲利情況和員工績效表現。

**路由**
- 月報表：`/reports/monthly`

## Alignment with Product Vision

本功能支援產品願景中的「數據驅動決策」目標，通過提供準確的月度經營數據，幫助管理員：
- 快速了解月度經營狀況
- 分析客戶獲利情況
- 評估員工績效表現
- 進行月度營運檢視與管理決策

## Requirements

### Requirement 1: 月度報表查看功能

**User Story:** As a 管理員, I want 查看月度報表, so that 我可以快速了解月度經營狀況、客戶獲利情況和員工績效表現

#### Acceptance Criteria

1. WHEN 使用者訪問 `/reports/monthly` THEN 系統 SHALL 顯示月度報表主頁面，包含年份和月份選擇器
2. WHEN 使用者切換年份或月份 THEN 系統 SHALL 立即自動載入報表，並於 500ms 內返回快取或新鮮數據
3. WHEN 使用者點擊匯總數字或展開按鈕 THEN 系統 SHALL 顯示對應的明細（收據明細、服務類型明細、客戶分布等）
4. WHEN 權限不足 THEN 系統 SHALL 僅顯示允許範圍的數據
5. WHEN 發生錯誤 THEN 系統 SHALL 顯示簡要錯誤訊息，並提供「查看詳情」按鈕顯示完整錯誤資訊
6. WHEN 使用者點擊刷新按鈕 THEN 系統 SHALL 強制重新計算所有報表數據

### Requirement 2: 月度收款報表

**User Story:** As a 管理員, I want 查看月度收款報表, so that 我可以了解本月應收、實收和未收情況

#### Acceptance Criteria

1. WHEN 載入月度收款報表 THEN 系統 SHALL 顯示本月應收、期限內實收/未收、逾期收回/未收、總未收
2. WHEN 查看客戶列表 THEN 系統 SHALL 顯示每個客戶的收款情況，並可展開查看收據明細
3. WHEN 顯示金額 THEN 系統 SHALL 使用 0 位小數精度（顯示到元）

### Requirement 3: 月度薪資報表

**User Story:** As a 管理員, I want 查看月度薪資報表, so that 我可以了解該月結算薪資總額和員工薪資明細

#### Acceptance Criteria

1. WHEN 載入月度薪資報表 THEN 系統 SHALL 顯示總應發、總實發、平均應發、平均實發、員工人數
2. WHEN 查看員工薪資明細 THEN 系統 SHALL 顯示每位員工的薪資構成和薪資構成分析
3. WHEN 顯示金額 THEN 系統 SHALL 使用 0 位小數精度（顯示到元）

### Requirement 4: 月度員工產值分析

**User Story:** As a 管理員, I want 查看月度員工產值分析, so that 我可以評估員工績效表現

#### Acceptance Criteria

1. WHEN 載入月度員工產值報表 THEN 系統 SHALL 顯示標準工時、加權工時、工時差異、產生收入、總成本、毛利、毛利率
2. WHEN 計算員工產生收入 THEN 系統 SHALL 使用標準工時（排除加班工時）進行收入分配
3. WHEN 查看員工客戶分布 THEN 系統 SHALL 顯示該員工在各客戶的標準工時和收入分配
4. WHEN 顯示金額 THEN 系統 SHALL 使用 0 位小數精度（顯示到元）

### Requirement 5: 月度客戶毛利分析

**User Story:** As a 管理員, I want 查看月度客戶毛利分析, so that 我可以了解客戶獲利情況

#### Acceptance Criteria

1. WHEN 載入月度客戶毛利報表 THEN 系統 SHALL 顯示總工時、加權工時、平均時薪、本月收入、總成本、毛利、毛利率
2. WHEN 計算客戶收入 THEN 系統 SHALL 使用 BR1 應計收入邏輯（定期服務按執行次數比例分攤，一次性服務直接使用實際金額）
3. WHEN 查看客戶服務類型明細 THEN 系統 SHALL 顯示各服務類型的收入分攤（使用 BR1 邏輯）
4. WHEN 顯示金額 THEN 系統 SHALL 使用 0 位小數精度（顯示到元）

## 指標範圍

- **月營收**：依收據金額（含一次性與定期）統計
- **月薪資**：該月結算薪資總額
- **月客戶獲利**：客戶營收（使用 BR1 應計收入邏輯）− 客戶成本（工時成本 + 管理費分攤）
- **月員工績效**：工時統計、產生收入、總成本、毛利、毛利率

## 業務規則

### 收入計算規則
- **月度收款報表**：以收據開立日期（receipt_date）為準，統計本月應收、期限內實收與逾期收回
- **月度客戶毛利分析**：使用 BR1 應計收入邏輯計算客戶收入
  - **定期服務**：按執行次數比例分攤收費計劃總金額
    - 計算定期服務總收費 = Σ(定期服務收費計劃中所有月份的金額)
    - 計算每個定期服務的執行次數 = execution_months 陣列的長度
    - 計算總執行次數 = Σ(所有關聯定期服務的執行次數)
    - 每個定期服務全年的分攤收入 = 定期服務總收費 × (該服務的執行次數 / 總執行次數)
    - 每個定期服務每個月的應計收入 = 該服務全年的分攤收入 ÷ 該服務的執行次數（如果該月在 execution_months 中，否則為 0）
  - **一次性服務**：直接使用收費計劃實際金額
    - 每個一次性服務每個月的應計收入 = 該月份的金額（如果該月在收費計劃中，否則為 0）
- **服務類型收入分攤**：使用 BR1 邏輯，按服務類型的執行次數比例分攤（定期服務按 execution_months，一次性服務直接使用實際金額）

### 成本計算規則
- **客戶成本**：工時成本（基於加權工時和實際時薪）+ 管理費分攤
- **員工成本**：人工成本（薪資）+ 管理費分攤

### 員工收入分配規則
- **分配方式**：使用標準工時（排除加班工時）進行收入分配
- **標準工時定義**：
  - 正常工時（work_type = 1）：全額計入
  - 固定 8 小時班別（work_type = 7, 10）：每日最多計入 8 小時
  - 加班工時（work_type = 2, 3, 4, 5, 6, 8, 9, 11, 12）：不計入標準工時
- **計算公式**：員工產生收入 = 客戶收入 × (員工標準工時 / 客戶總標準工時)

### 其他規則
- 客戶獲利 = 營收（BR1 應計收入）− 成本（工時成本 + 管理費分攤）
- 員工績效包含標準工時、加權工時、產生收入、總成本、毛利、毛利率
- 數據以月為粒度，與年報關聯但獨立計算
- 金額顯示精度：0 位小數（顯示到元）

---

## Non-Functional Requirements

### Code Architecture and Modularity
- **Single Responsibility Principle**: 每個文件應該有單一、明確的職責
  - 每個報表 Handler 只處理一個報表類型
  - 每個 Vue 組件只負責一個報表顯示
  - 工具函數按功能分組，可在多處重用
- **Modular Design**: 組件、工具和服務應該隔離且可重用
  - 前端組件通過 props 和 events 通信，保持獨立
  - API 調用與業務邏輯分離，使用統一的 API 工具函數
  - 收入計算邏輯封裝為獨立函數，可在多處重用
- **Dependency Management**: 最小化模組間的相互依賴
  - 組件之間通過 Store 和 API 層通信，避免直接依賴
  - 工具函數不依賴特定組件或 Handler
- **Clear Interfaces**: 定義清晰的組件和層級之間的契約
  - API 函數有明確的輸入輸出格式
  - 組件 Props 和 Events 有清晰的類型定義
  - Handler 函數有明確的參數和返回值格式

### Performance
- **API 響應時間**: < 500ms（使用快取時）
- **頁面載入時間**: < 3 秒
- **切換月份響應時間**: < 1 秒
- **資料庫查詢**: 複雜查詢 < 2 秒
- **快取策略**: 
  - 使用 Cloudflare KV 快取報表數據
  - 快取鍵格式：`monthly:{year}:{month}:{reportType}`
  - 支援 `refresh` 參數強制重新計算
  - 相關來源資料變更時標記失效

### Security
- **認證機制**: Cookie-based Session
- **權限控制**: 僅管理員可以訪問報表
- **數據保護**：
  - 參數化查詢防止 SQL 注入
  - XSS 防護（Vue 自動轉義）
  - 報表數據權限過濾，確保數據安全
- **合規要求**: 財務數據安全、審計追蹤

### Reliability
- **錯誤處理**: 
  - 顯示簡要錯誤訊息，提供「查看詳情」按鈕
  - 記錄完整錯誤堆疊資訊（用於除錯）
  - API 請求失敗時提供重試選項
- **數據一致性**: 
  - 使用 BR1 應計收入邏輯確保收入計算準確
  - 使用標準工時分配確保員工收入分配準確
  - 快取數據過期時自動重新計算
- **可用性要求**: 99.9% 可用性

### Usability
- **自動載入**: 切換年份或月份時立即自動載入報表，無需手動點擊
- **手動刷新**: 在篩選器區域統一放置刷新按鈕，強制重新計算所有報表
- **錯誤提示**: 預設顯示簡要錯誤訊息，點擊可查看詳細錯誤
- **金額顯示**: 金額顯示精度為 0 位小數（顯示到元），符合財務報表習慣
- **深入鑽取**: 部分報表支援展開查看明細（客戶可展開收據、服務類型明細；員工可查看客戶分布）
