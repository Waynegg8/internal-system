# Requirements Document: BR1.2.3: 客戶新增 - 帳務設定分頁

## Introduction

本功能提供客戶新增流程中的帳務設定分頁，允許員工在新增客戶時設定付款方式和收費計劃。這是客戶管理系統的核心模組之一，確保財務記錄的準確性和完整性。

**業務價值**:
- 集中管理客戶資訊，提升客戶服務品質
- 追蹤客戶服務狀態，及時響應客戶需求
- 管理客戶帳務，確保財務準確性

## Alignment with Product Vision

本功能支持產品願景中的以下目標：
- **提升客戶服務品質**: 通過完整的帳務設定，確保客戶收費計劃的準確性
- **提高工作效率**: 在客戶新增流程中即可完成帳務設定，減少後續操作
- **確保財務準確性**: 完整的收費計劃管理，支援年度管理和收入分攤計算

---

#### BR1.2.3: 客戶新增 - 帳務設定分頁

**User Story**: 作為會計師事務所的員工，我需要在新增客戶時設定帳務資訊和收費計劃，以便確保財務記錄準確。

**頁面結構說明**:
- 客戶新增帳務設定分頁是客戶新增頁面（ClientAdd）的一個獨立分頁（Tab）
- 路由：`/clients/add/billing` → 帳務設定分頁（ClientAddBilling.vue）

**功能需求**:
- BR1.2.3.1: 設定付款方式 ✅ 已實現
- BR1.2.3.2: 新增收費計劃（選擇年度、勾選月份、填寫金額、關聯服務）✅ 已實現
- BR1.2.3.3: 編輯收費計劃（修改月份金額、關聯服務）✅ 已實現
- BR1.2.3.4: 刪除收費計劃 ✅ 已實現
- BR1.2.3.5: 批量刪除收費記錄 ✅ 已實現
- BR1.2.3.6: 關聯多個服務到收費計劃 ✅ 已實現
- BR1.2.3.7: 為每個勾選的月份填寫不同金額 ✅ 已實現
- BR1.2.3.8: 獨立保存帳務設定 ✅ 已實現

**驗收標準**:
- WHEN 員工在新增客戶帳務設定分頁時 THEN 系統 SHALL 允許設定收費計劃
- WHEN 員工查看收費計劃時 THEN 系統 SHALL 分別顯示定期服務收費計劃和一次性服務收費計劃（可以切換查看或合併顯示）
- WHEN 員工新增定期服務收費計劃時 THEN 系統 SHALL 要求選擇年度
- WHEN 員工新增定期服務收費計劃時 THEN 系統 SHALL 允許直接勾選要收費的月份（1-12 月）
- WHEN 員工勾選月份時 THEN 系統 SHALL 為每個勾選的月份顯示金額輸入欄位
- WHEN 員工填寫月份金額時 THEN 系統 SHALL 允許為每個月份填寫不同的金額
- WHEN 員工新增定期服務收費計劃時 THEN 系統 SHALL 允許從該客戶的服務列表中選擇多個**定期服務**進行關聯
- WHEN 員工關聯服務時 THEN 系統 SHALL 只顯示該客戶已建立的**定期服務**（從 ClientServices 表中讀取，service_type = 'recurring'）
- WHEN 員工編輯收費計劃時 THEN 系統 SHALL 允許修改月份金額、新增/刪除月份、新增/刪除關聯服務
- WHEN 員工刪除收費計劃時 THEN 系統 SHALL 支援單筆刪除和批量刪除
- WHEN 員工在帳務設定分頁點擊保存時 THEN 系統 SHALL 保存帳務設定（客戶必須已存在，即已保存基本資訊）
- WHEN 員工保存帳務設定後 THEN 系統 SHALL 允許切換到其他分頁（基本資訊、服務設定）繼續填寫
- WHEN 員工未保存基本資訊就進入帳務設定分頁時 THEN 系統 SHALL 提示先保存基本資訊

**業務規則**:
- 帳務資訊與客戶基本資訊關聯
- 收費計劃按年度管理，每個年度有獨立的收費計劃
- **收費計劃類型**（見 BR1.3.3）:
  - **定期服務收費計劃**（`billing_type = 'recurring'`）：用於定期服務的收費計劃
  - **一次性服務收費計劃**（`billing_type = 'one-time'`）：用於一次性服務的收費計劃
- 定期服務收費計劃必須關聯到客戶的定期服務項目（從 ClientServices 表中選擇，service_type = 'recurring'）
- **定期服務收費計劃的建立方式**（見 BR1.3.3）:
  - 直接勾選要收費的月份（1-12 月）
  - 為每個勾選的月份填寫金額（可以不同）
  - 關聯多個定期服務到收費計劃
- **一次性服務收費計劃的建立方式**（見 BR1.3.3）:
  - 通過「執行服務」功能自動建立/更新
  - 每個一次性服務有獨立的收費計劃
- 付款期限（payment_due_days）：收費日期後多少天內需付款，例如 30 天
  - 可以在收費計劃層級設定預設付款期限
  - 也可以在每個月份明細中設定特定的付款期限（可選，預設使用計劃的付款期限）
- 收費計劃可以按服務項目篩選查看
- **收入分攤規則**（見 BR1.3.3）:
  - **定期服務**：多個定期服務的收費混合在一起，按執行次數比例分攤
    - 計算定期服務總收費 = Σ(定期服務收費計劃中所有月份的金額)
    - 計算每個定期服務的執行次數 = execution_months 陣列的長度
    - 計算總執行次數 = Σ(所有關聯定期服務的執行次數)
    - 每個定期服務全年的分攤收入 = 定期服務總收費 × (該服務的執行次數 / 總執行次數)
    - 每個定期服務每個月的應計收入 = 該服務全年的分攤收入 ÷ 該服務的執行次數（如果該月在 execution_months 中，否則為 0）
  - **一次性服務**：每個一次性服務的收費獨立，直接使用實際金額，不分攤
    - 每個一次性服務有獨立的收費計劃（一次性服務收費計劃）
    - 每個一次性服務的應計收入 = 該服務的收費計劃中所有月份的金額總和
    - 每個一次性服務每個月的應計收入 = 該月份的金額（如果該月在收費計劃中，否則為 0）
  - 定期服務和一次性服務之間不互相影響
  - 應計收入按年度計算，跨年度不混亂

## Non-Functional Requirements

### Code Architecture and Modularity
- **Single Responsibility Principle**: 每個組件和 Handler 只負責一個功能模組
- **Modular Design**: 收費計劃組件、API Handler、數據模型應分離且可重用
- **Dependency Management**: 前端組件依賴 API 層，後端 Handler 依賴數據庫層，避免循環依賴
- **Clear Interfaces**: API 接口定義清晰，前後端通過統一的數據格式通信

### Performance
- **API 響應時間**: 收費計劃查詢和保存操作應在 500ms 內完成
- **頁面載入時間**: 帳務設定分頁應在 2 秒內完成初始載入
- **數據查詢優化**: 使用索引優化收費計劃查詢，支援按年度、服務類型快速篩選

### Security
- **權限控制**: 只有有權限的員工可以設定客戶帳務資訊
- **數據驗證**: 所有輸入數據必須經過驗證，防止無效數據寫入資料庫
- **參數化查詢**: 所有資料庫操作使用參數化查詢，防止 SQL 注入

### Reliability
- **錯誤處理**: 所有 API 操作應有完整的錯誤處理機制
- **數據完整性**: 收費計劃保存時應確保數據完整性，支援事務處理
- **軟刪除**: 收費計劃刪除應使用軟刪除機制，保留歷史記錄

### Usability
- **操作直觀**: 收費計劃設定流程應直觀易懂，減少學習成本
- **錯誤提示**: 表單驗證失敗時應提供清晰的錯誤提示
- **即時反饋**: 操作成功或失敗應有即時的視覺反饋（Toast 提示）

---
