# Requirements Document: BR1.3.3: 客戶詳情頁 - 收費設定分頁

## Introduction

本功能是會計師事務所內部管理系統中客戶管理模組的核心功能之一，提供客戶收費計劃管理和應計收入計算功能。通過集中管理客戶的收費計劃、年度帳務資訊和收入分攤，幫助員工高效地管理客戶帳務，確保財務記錄準確性，並支援成本核算和利潤分析。

**頁面結構說明**:
- 客戶收費設定管理是客戶詳情頁（ClientDetail）的一個獨立分頁（Tab）
- 路由：`/clients/:id/billing` → 收費設定分頁（ClientBilling.vue）
- 包含收費計劃管理、年度管理、應計收入展示等功能

**業務價值**:
- 集中管理客戶收費計劃，提升帳務管理效率
- 自動化年度收費計劃建立，減少重複操作
- 準確計算應計收入，支援成本核算和利潤分析
- 確保財務記錄準確性，支援審計追蹤

## Alignment with Product Vision

本功能支援產品願景中的以下目標：
- **提升客戶服務品質**: 通過集中管理客戶收費計劃，確保帳務資訊準確完整，及時響應客戶需求
- **提高工作效率**: 自動化年度收費計劃建立和收入分攤計算，減少重複操作
- **確保財務準確性**: 完整的收費計劃管理和應計收入計算，支援成本核算和利潤分析
- **資料完整性**: 保留歷史記錄，支援審計和報表生成

---

## Requirements

### Requirement 1: 收費計劃管理

**User Story**: 作為會計師事務所的員工，我需要管理客戶帳務資訊和收費計劃，以便確保財務記錄準確並計算應計收入。

#### Acceptance Criteria

1. WHEN 員工查看客戶帳務資訊時 THEN 系統 SHALL 顯示收費計劃列表，包含年度、收費計劃類型、月份、金額、付款期限、關聯服務等資訊
2. WHEN 員工查看收費計劃時 THEN 系統 SHALL 在頁面頂部顯示年度選擇器，預設顯示當前年度
3. WHEN 員工查看收費計劃時 THEN 系統 SHALL 分別顯示定期服務收費計劃和一次性服務收費計劃（可以切換查看或合併顯示）
4. WHEN 員工切換年度時 THEN 系統 SHALL 顯示該年度的收費計劃（如果存在）
5. WHEN 員工切換到新年度時 THEN 系統 SHALL 自動建立該年度的**定期服務收費計劃**（如果不存在），自動複製上一年度定期服務收費計劃的月份、金額和關聯服務（不複製一次性服務收費計劃）
6. WHEN 員工新增定期服務收費計劃時 THEN 系統 SHALL 要求選擇年度（如果該年度已有定期服務收費計劃，則進入編輯模式）
7. WHEN 員工新增定期服務收費計劃時 THEN 系統 SHALL 允許直接勾選要收費的月份（1-12 月）
8. WHEN 員工勾選月份時 THEN 系統 SHALL 為每個勾選的月份顯示金額輸入欄位
9. WHEN 員工填寫月份金額時 THEN 系統 SHALL 允許為每個月份填寫不同的金額
10. WHEN 員工新增定期服務收費計劃時 THEN 系統 SHALL 允許從該客戶的服務列表中選擇多個**定期服務**進行關聯
11. WHEN 員工關聯服務時 THEN 系統 SHALL 只顯示該客戶已建立的**定期服務**（從 ClientServices 表中讀取，service_type = 'recurring'）
12. WHEN 員工編輯收費計劃時 THEN 系統 SHALL 允許修改月份金額、新增/刪除月份、新增/刪除關聯服務
13. WHEN 員工刪除收費計劃時 THEN 系統 SHALL 支援單筆刪除
14. WHEN 員工選擇多筆收費計劃時 THEN 系統 SHALL 支援批量刪除
15. WHEN 員工查看應計收入時 THEN 系統 SHALL 顯示每個服務的應計收入分攤結果

### Requirement 2: 應計收入計算

**User Story**: 作為會計師事務所的員工，我需要查看每個服務的應計收入分攤結果，以便進行成本核算和利潤分析。

#### Acceptance Criteria

1. WHEN 系統計算定期服務應計收入時 THEN 系統 SHALL 按執行次數比例分攤定期服務收費計劃的總金額
2. WHEN 系統計算一次性服務應計收入時 THEN 系統 SHALL 直接使用一次性服務收費計劃的實際金額，不分攤
3. WHEN 系統計算應計收入時 THEN 系統 SHALL 按年度計算，跨年度不混亂
4. WHEN 員工查看應計收入時 THEN 系統 SHALL 顯示每個服務的全年分攤收入和每月應計收入

**業務規則**:
- 收費計劃按年度管理，每個年度有獨立的收費計劃
- **收費計劃類型**:
  - **定期服務收費計劃**（`billing_type = 'recurring'`）：用於定期服務的收費計劃
    - 可以關聯多個定期服務
    - 年度自動建立時，只複製定期服務收費計劃
  - **一次性服務收費計劃**（`billing_type = 'one-time'`）：用於一次性服務的收費計劃
    - 每個一次性服務有獨立的收費計劃
    - 不參與年度自動建立
- **新年度收費計劃自動建立**:
  - 當員工切換到新年度查看收費計劃時，如果該年度還沒有**定期服務收費計劃**，系統自動建立
  - 自動建立的收費計劃**只複製上一年度定期服務收費計劃的月份、金額和關聯服務**
  - 一次性服務收費計劃不會自動複製到新年度，因為一次性服務是臨時性的，不應該跨年度自動建立
  - 員工可以隨時修改自動建立的收費計劃（修改月份、金額、關聯服務）
  - 例如：2025 年 1 月 1 日，員工查看 2025 年收費計劃時，系統自動建立並複製 2024 年**定期服務收費計劃**（例如：記帳服務 1-12 月每月 20,000 元），但不會複製 2024 年的一次性服務收費計劃（例如：工商設立服務）
- 收費計劃必須關聯到客戶的服務項目（從 ClientServices 表中選擇）
- **定期服務收費計劃的建立方式**:
  - 直接勾選要收費的月份（1-12 月）
  - 為每個勾選的月份填寫金額（可以不同）
  - 關聯多個定期服務到收費計劃
- **一次性服務收費計劃的建立方式**:
  - 通過「執行服務」功能自動建立/更新
  - 每個一次性服務有獨立的收費計劃
  - 記錄該服務的收費月份和金額
- 付款期限（payment_due_days）：收費日期後多少天內需付款，例如 30 天
  - 可以在收費計劃層級設定預設付款期限
  - 也可以在每個月份明細中設定特定的付款期限（可選，預設使用計劃的付款期限）
- 收費計劃可以按服務項目篩選查看
- **執行一次性服務與收費計劃的協調**:
  - 執行一次性服務時，系統自動建立/更新該服務的**一次性服務收費計劃**
  - 如果該年度該服務已有一次性服務收費計劃，則更新該月份金額
  - 如果該年度該服務還沒有一次性服務收費計劃，則建立新的收費計劃並關聯該服務
  - 一次性服務收費計劃與定期服務收費計劃完全獨立，互不影響
- **收入分攤規則**:
  - **定期服務**：多個定期服務的收費混合在一起，按執行次數比例分攤
    - 計算定期服務總收費 = Σ(定期服務收費計劃中所有月份的金額)
    - 計算每個定期服務的執行次數 = execution_months 陣列的長度（該年度該服務實際執行的月份數）
    - 計算總執行次數 = Σ(所有關聯定期服務的執行次數)
    - 如果總執行次數 > 0：
      - 每個定期服務全年的分攤收入 = 定期服務總收費 × (該服務的執行次數 / 總執行次數)
      - 每個定期服務每個月的應計收入 = 該服務全年的分攤收入 ÷ 該服務的執行次數（如果該月在 execution_months 中，否則為 0）
    - 如果總執行次數 = 0（所有服務都沒有執行）：
      - 每個定期服務全年的分攤收入 = 0
      - 每個定期服務每個月的應計收入 = 0
    - 範例：定期服務收費計劃總收費 240,000 元，服務A執行 12 次（1-12月），服務B執行 6 次（1,3,5,7,9,11月）
      - 總執行次數 = 12 + 6 = 18
      - 服務A全年分攤收入 = 240,000 × (12/18) = 160,000 元，每月應計收入 = 160,000 ÷ 12 = 13,333.33 元
      - 服務B全年分攤收入 = 240,000 × (6/18) = 80,000 元，每月應計收入 = 80,000 ÷ 6 = 13,333.33 元（只在1,3,5,7,9,11月有收入）
  - **一次性服務**：每個一次性服務的收費獨立，直接使用實際金額，不分攤
    - 每個一次性服務有獨立的收費計劃（一次性服務收費計劃）
    - 每個一次性服務的應計收入 = 該服務的收費計劃中所有月份的金額總和
    - 每個一次性服務每個月的應計收入 = 該月份的金額（如果該月在收費計劃中，否則為 0）
    - 範例：一次性服務A在3月收費 50,000 元，一次性服務B在6月收費 30,000 元
      - 服務A全年應計收入 = 50,000 元，3月應計收入 = 50,000 元，其他月份 = 0
      - 服務B全年應計收入 = 30,000 元，6月應計收入 = 30,000 元，其他月份 = 0
  - 定期服務和一次性服務之間不互相影響
  - 應計收入按年度計算，跨年度不混亂

**收費計劃在其他頁面的使用**:
- **收據提醒功能**：
  - 系統會根據當月的收費計劃，檢查哪些客戶的服務已經完成所有任務，但還沒有開立收據
  - 系統會同時檢查定期服務收費計劃和一次性服務收費計劃
  - 如果該月份有收費計劃（定期服務或一次性服務），且所有任務已完成，系統會提醒開立收據
  - 提醒中會顯示收費計劃設定的金額作為建議金額（定期服務和一次性服務的金額會合併顯示）
  - 提醒條件：
    - 該月份有收費計劃（定期服務或一次性服務）
    - 該月份有任務且所有任務已完成
    - 該月份尚未開立收據（或收據已作廢）
    - 該提醒未被暫緩（postponed）
- **收據新增功能**：
  - 系統提供 API 可以根據 `client_id`、`billing_year` 和 `billing_month` 獲取建議金額
  - 建議金額來自收費計劃（定期服務收費計劃和一次性服務收費計劃的合計）
  - 如果該月份有收費計劃，系統會自動帶入建議金額和付款期限（payment_due_days）
  - 如果該月份沒有收費計劃，建議金額為 0，付款期限預設為 30 天
- **客戶詳情頁**：
  - 客戶詳情頁會顯示該客戶所有服務的收費計劃（定期服務和一次性服務）
  - 可以查看年度總收費金額（year_total，包含定期服務和一次性服務）
- **應計收入計算**：
  - 系統根據收費計劃和服務執行頻率自動計算應計收入
  - 定期服務按執行次數比例分攤定期服務收費計劃的總金額
  - 一次性服務直接使用一次性服務收費計劃的實際金額，不分攤
  - 應計收入用於成本核算和利潤分析

## Non-Functional Requirements

### Code Architecture and Modularity
- **Single Responsibility Principle**: 每個文件應該有單一、明確的職責
  - `ClientBilling.vue` 只負責收費計劃管理 UI
  - `client-billing.js` Handler 只負責收費計劃相關的 API 處理
  - `billing-calculator.js` 只負責收入分攤計算邏輯
- **Modular Design**: 組件、工具和服務應該隔離且可重用
  - 收入分攤計算邏輯應該獨立為工具函數，可在多處重用
  - 收費計劃表單組件應該可重用於新增和編輯場景
- **Dependency Management**: 最小化模組之間的相互依賴
  - 前端組件通過 API 層與後端通信，不直接依賴後端實現
  - 後端 Handler 通過工具函數訪問資料庫，不直接依賴資料庫結構
- **Clear Interfaces**: 定義清晰的組件和層級之間的契約
  - API 端點應該有明確的請求和回應格式
  - 組件 Props 和 Events 應該有清晰的類型定義

### Performance
- **API 響應時間**: 收費計劃列表查詢 < 500ms
- **頁面載入時間**: 收費設定分頁載入 < 3 秒
- **收入分攤計算**: 複雜計算 < 2 秒（支援快取）
- **年度切換**: 年度切換和自動建立收費計劃 < 1 秒

### Security
- **權限控制**: 只有有權限的員工才能查看和編輯客戶收費計劃
- **數據驗證**: 所有輸入數據必須經過驗證（金額、日期、服務關聯等）
- **SQL 注入防護**: 使用參數化查詢，防止 SQL 注入攻擊
- **XSS 防護**: Vue 自動轉義，防止 XSS 攻擊

### Reliability
- **錯誤處理**: 所有 API 調用必須有錯誤處理，顯示友好的錯誤訊息
- **數據一致性**: 收費計劃的建立、編輯、刪除操作必須保證數據一致性
- **事務處理**: 批量操作和複雜計算應該使用事務確保原子性
- **數據備份**: 支援軟刪除機制，保留歷史記錄供審計使用

### Usability
- **操作直觀**: 年度選擇器、月份勾選、金額輸入等操作應該直觀易用
- **錯誤提示**: 表單驗證失敗時應該在對應欄位顯示清晰的錯誤訊息
- **載入狀態**: API 調用期間應該顯示載入狀態，避免用戶重複操作
- **確認對話框**: 刪除操作應該有確認對話框，防止誤操作
