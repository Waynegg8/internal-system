# Requirements Document: BR1.2.2: 客戶新增 - 服務設定分頁

## Introduction

本功能提供客戶新增流程中的服務設定分頁，允許員工在新增客戶時設定服務項目和任務配置。這是客戶管理系統的核心模組之一，支援定期服務和一次性服務的配置，以及任務模板的自動套用和任務生成時間、到期日的設定。

**業務價值**:
- 集中管理客戶資訊，提升客戶服務品質
- 追蹤客戶服務狀態，及時響應客戶需求
- 管理客戶帳務，確保財務準確性

## Alignment with Product Vision

本功能支援產品願景中的以下目標：
- **提升客戶服務品質**：透過完整的服務配置和任務自動生成，確保客戶服務的及時性和準確性
- **提高工作效率**：自動套用任務模板和預設值，減少重複配置工作
- **確保財務準確性**：與收費計劃整合，確保服務與帳務的一致性

## Requirements

### BR1.2.2: 客戶新增 - 服務設定分頁

**User Story**: 作為會計師事務所的員工，我需要在新增客戶時設定服務項目和任務配置，以便追蹤服務狀態並自動生成任務。

**頁面結構說明**:
- 客戶新增服務設定分頁是客戶新增頁面（ClientAdd）的一個獨立分頁（Tab）
- 路由：`/clients/add/services` → 服務設定分頁（ClientAddServices.vue）

**功能需求**:
- BR1.2.2.1: 新增客戶服務 ✅ 已實現
- BR1.2.2.2: 編輯客戶服務 ✅ 已實現
- BR1.2.2.3: 刪除客戶服務 ✅ 已實現
- BR1.2.2.4: 選擇服務類型（定期服務 / 一次性服務）✅ 已實現
- BR1.2.2.5: 服務類型預設值自動帶入 ✅ 已實現
- BR1.2.2.6: 設定服務執行頻率（勾選執行月份）✅ 已實現
- BR1.2.2.7: 設定是否用於自動生成任務 ✅ 已實現
- BR1.2.2.8: 執行一次性服務（一鍵完成收費計劃+任務生成）⚠️ 需實現（應在客戶詳情頁面的服務列表中實現，不在新增流程中）
- BR1.2.2.9: 任務配置自動建立（使用任務模板）✅ 已實現
- BR1.2.2.10: 服務任務配置管理 ✅ 已實現
- BR1.2.2.11: 收費計劃建立提示 ✅ 已實現
- BR1.2.2.12: 獨立保存服務設定 ✅ 已實現

**驗收標準**:
- WHEN 員工在新增客戶服務設定分頁時 THEN 系統 SHALL 允許選擇和設定客戶服務項目
- WHEN 員工新增服務時 THEN 系統 SHALL 驗證服務必須存在且為啟用狀態
- WHEN 員工新增服務時 THEN 系統 SHALL 允許選擇服務類型（定期服務 / 一次性服務）
- WHEN 員工新增定期服務時 THEN 系統 SHALL 要求設定執行頻率（勾選執行月份）
- WHEN 員工新增一次性服務時 THEN 系統 SHALL 不要求設定執行頻率（執行月份為空）
- WHEN 員工設定服務執行頻率時 THEN 系統 SHALL 允許直接勾選執行月份（1-12 月），不需要預設選項
- WHEN 員工設定服務執行頻率時 THEN 系統 SHALL 驗證定期服務必須至少勾選一個月份
- WHEN 員工設定服務時 THEN 系統 SHALL 允許選擇是否用於自動生成任務
- WHEN 員工點擊「執行服務」按鈕（一次性服務）時 THEN 系統 SHALL 彈出對話框，允許選擇執行月份、填寫收費金額，並自動完成收費計劃建立/更新和任務生成
- WHEN 員工配置服務任務時 THEN 系統 SHALL 允許設定任務模板、任務生成時間、到期日等（任務執行頻率從服務層級繼承）
- WHEN 員工設定任務生成時間時 THEN 系統 SHALL 允許選擇生成時間規則（服務月份開始時、前一個月最後X天、前一個月第X天、後一個月開始時）
- WHEN 員工設定任務到期日時 THEN 系統 SHALL 允許選擇到期日規則（服務月份結束時、後一個月結束時、後N個月結束時、固定日期、固定期限）
- WHEN 員工配置任務生成時間和到期日時 THEN 系統 SHALL 即時顯示預覽效果（例如「3月的任務在3月1日生成，到期日是3月15日」）
- WHEN 員工設定任務到期日時 THEN 系統 SHALL 允許設置為「固定期限任務」（不受前面任務延後影響）
- WHEN 員工配置服務任務時 THEN 系統 SHALL 允許關聯標準作業程序（SOP）
- WHEN 員工創建任務時 THEN 系統 SHALL 自動從知識庫讀取符合條件的服務層級SOP（服務類型層級 = 當前服務類型，層級 = 服務層級，客戶 = 統一模板或當前客戶）
- WHEN 員工選擇服務層級SOP時 THEN 系統 SHALL 允許多選，也可以取消預設帶入的SOP
- WHEN 客戶在同一個服務類型下有多個專屬服務層級SOP時 THEN 系統 SHALL 全部帶入，員工自行判斷是否都選擇
- WHEN 員工選擇任務層級SOP時 THEN 系統 SHALL 從知識庫篩選符合條件的SOP（服務類型層級 = 當前服務類型，層級 = 任務層級，客戶 = 統一模板或當前客戶）
- WHEN 員工篩選SOP時 THEN 系統 SHALL 先篩選服務類型，再篩選層級（服務層級或任務層級）
- WHEN 員工選擇任務層級SOP時 THEN 系統 SHALL 允許多選，也可以取消預設帶入的SOP
- WHEN 員工配置服務任務時 THEN 系統 SHALL 支援批量保存任務配置
- WHEN 員工在服務設定分頁點擊保存時 THEN 系統 SHALL 保存服務設定（客戶必須已存在，即已保存基本資訊）
- WHEN 員工保存服務設定後 THEN 系統 SHALL 允許切換到其他分頁（基本資訊、帳務設定）繼續填寫
- WHEN 員工未保存基本資訊就進入服務設定分頁時 THEN 系統 SHALL 提示先保存基本資訊

**業務規則**:
- 同一客戶不能重複新增相同服務（除非之前已刪除）
- 服務必須存在且為啟用狀態才能新增
- 任務配置用於自動生成任務（見 BR2.4）
- **任務自動生成執行頻率**:
  - 系統每日檢查（每天 02:00 執行）
  - 檢查所有需要生成的任務
  - 如果生成時間到了，就生成任務
- **服務類型（定期/一次性）**（見 BR1.3.2）:
  - **定期服務**：有固定執行頻率的服務（例如：記帳服務每月執行、營業稅申報服務奇數月執行）
    - 必須設定執行頻率（勾選執行月份）
    - 通常用於自動生成任務（`use_for_auto_generate = 1`）
  - **一次性服務**：執行時間不固定的服務（例如：工商設立服務、公司變更服務）
    - 不需要設定執行頻率（`execution_months = NULL`）
    - 通常不用於自動生成任務（`use_for_auto_generate = 0`）
    - 需要執行時，使用「執行服務」功能，一鍵完成收費計劃建立/更新和任務生成
- **服務執行頻率設定**（見 BR1.3.2）:
  - 執行頻率在服務層級設定（`ClientServices.execution_months`），不在任務層級設定
  - 任務的執行頻率從服務層級繼承
  - 定期服務必須設定執行頻率（至少勾選一個月份）
  - 一次性服務不需要設定執行頻率
  - 執行頻率設定方式：直接勾選執行月份（1-12 月），不需要預設選項（如奇數月、按季等）
- **是否用於自動生成任務**（見 BR1.3.2）:
  - 定期服務通常設為「是」（`use_for_auto_generate = 1`），系統會根據執行頻率自動生成任務
  - 一次性服務通常設為「否」（`use_for_auto_generate = 0`），不會自動生成任務，需要手動執行
- **執行一次性服務**（見 BR1.3.2）:
  - 在服務列表頁面，一次性服務會顯示「執行服務」按鈕
  - 點擊後彈出對話框：
    - 選擇執行月份（必填）
    - 填寫收費金額（必填）
    - 選擇服務月份（用於任務，預設為執行月份）
    - 付款期限（可選，預設使用收費計劃的付款期限）
  - 系統自動完成：
    1. 檢查該年度該服務的一次性服務收費計劃是否存在，如果不存在則建立新的收費計劃（`billing_type = 'one-time'`）
    2. 在一次性服務收費計劃中新增/更新該月份，金額為填寫的金額
    3. 關聯該服務到收費計劃（如果還沒關聯）
    4. 根據任務配置，**立即生成**該服務的所有任務（服務月份 = 選擇的服務月份）
  - 一次性服務設定完後立即生成任務，不需要等待自動生成
  - 一次性服務收費計劃與定期服務收費計劃完全獨立，互不影響
- **服務類型預設值自動帶入**:
  - 在 `Services` 表中新增欄位：
    - `default_service_type`（TEXT）：預設服務類型（'recurring' 或 'one-time'）
    - `default_execution_months`（TEXT，JSON 格式）：預設執行月份陣列，例如 `[1,2,3,4,5,6,7,8,9,10,11,12]`
    - `default_use_for_auto_generate`（INTEGER）：預設是否用於自動生成任務（0 或 1）
  - 新增服務時，系統自動從服務類型帶入這些預設值
  - 用戶可以修改預設值，但不需要每次都重新設定
- **任務配置自動建立（使用任務模板）**:
  - 新增服務時，系統自動檢查是否有該服務類型的任務模板（優先使用客戶專屬模板，其次使用通用模板）
  - 如果找到任務模板，系統自動套用模板並建立任務配置
  - 自動建立的任務配置包含：
    - 任務名稱、描述、階段編號：從任務模板帶入
    - 任務生成時間、到期日：從任務模板帶入（如果模板有設定）
    - 執行頻率：從服務層級繼承（不需要單獨設定）
    - 負責人、預估工時：從任務模板帶入（如果模板有設定）
  - 用戶可以修改自動建立的任務配置，也可以刪除不需要的任務
  - 如果沒有找到任務模板，系統提示用戶手動配置或選擇模板
- **任務配置規則**（見 BR1.3.2）:
  - 任務名稱從服務類型下的任務類型列表下拉選擇（不是手動輸入）
  - 任務類型在系統設置中，每個服務類型下可以設置多個任務類型（ServiceItems）
  - 任務模板可以在系統設置中設置，可以關聯到服務類型和客戶
  - 配置任務時可以直接套用任務模板
  - 套用模板後可以根據需要修改細節，修改不會影響原始模板
  - **任務不再需要單獨設定執行頻率**，執行頻率從服務層級繼承
- **任務生成時間和到期日設置**:
  - 任務生成時間：設定任務何時生成（相對於服務月份）
    - 服務月份開始時（例如：1月1日生成1月的任務）
    - 服務月份前一個月的最後X天（例如：1月28日生成2月的任務，X=3）
    - 服務月份前一個月的第X天（例如：1月25日生成2月的任務，X=25）
    - 服務月份後一個月開始時（例如：2月1日生成1月的任務）
  - 任務到期日：設定任務何時到期（相對於服務月份）
    - 服務月份結束時（例如：1月31日）
    - 服務月份後一個月結束時（例如：2月29日）
    - 服務月份後N個月結束時（例如：服務月份+2個月的月底）
    - 固定日期（例如：每月15日，如果該月沒有15日則為該月最後一天）
    - 固定期限（例如：服務月份15日，用於稅務申報等固定期限任務）
  - 即時預覽：配置時顯示實際效果，例如「3月的任務在3月1日生成，到期日是3月15日」
  - 固定期限任務：可以設置為「不受前面任務延後影響」，即使前置任務延誤，到期日也不會順延
  - 前置任務延誤處理：如果前置任務延誤，後續任務的到期日會順延，但如果後續任務是固定期限，則調整為「固定期限的前一天」
- **SOP 自動綁定規則**:
  - 服務層級SOP：創建任務時自動從知識庫讀取符合條件的SOP（服務類型層級 = 當前服務類型，層級 = 服務層級，客戶 = 統一模板或當前客戶）
  - 服務層級SOP可以多選，也可以取消預設帶入的SOP
  - 如果客戶在同一個服務類型下有多個專屬服務層級SOP，系統會全部帶入，員工自行判斷是否都選擇
  - 任務層級SOP：從知識庫篩選符合條件的SOP（服務類型層級 = 當前服務類型，層級 = 任務層級，客戶 = 統一模板或當前客戶）
  - 任務層級SOP可以多選，也可以取消預設帶入的SOP
  - 篩選SOP時：先篩選服務類型，再篩選層級（服務層級或任務層級）
  - SOP不需要在設定頁面關聯，直接從知識庫讀取
- **收費計劃建立提示**:
  - 新增定期服務並保存後，系統自動提示「是否立即建立收費計劃？」
  - 如果選擇「是」，系統自動跳轉到帳務設定分頁，並預選該服務
  - 如果選擇「稍後」，系統記錄該服務尚未建立收費計劃，在服務列表中顯示提示標記

## Non-Functional Requirements

### Code Architecture and Modularity
- **Single Responsibility Principle**: 每個組件和 Handler 只負責一個功能模組
- **Modular Design**: 組件之間通過 props 和 events 通信，保持獨立
- **Dependency Management**: API 調用與業務邏輯分離，使用統一的 API 工具函數
- **Clear Interfaces**: 組件 Props 和 Events 必須有清晰的類型定義和說明

### Performance
- API 響應時間 < 500ms（正常情況）
- 頁面載入時間 < 3 秒
- 任務配置批量保存時，支援至少 20 個任務配置同時保存

### Security
- 所有 API 請求必須通過認證（Cookie-based Session）
- 使用參數化查詢防止 SQL 注入
- 驗證客戶 ID 和服務 ID 的有效性，防止未授權訪問

### Reliability
- 服務設定保存失敗時，必須回滾所有變更
- 任務配置批量保存時，必須保證原子性（全部成功或全部失敗）
- 系統必須處理並發保存的情況

### Usability
- 表單驗證錯誤必須即時顯示在對應欄位下方
- 任務生成時間和到期日配置必須提供即時預覽
- 操作成功或失敗必須有明確的提示訊息（使用 Toast，不使用 alert/confirm）
- 複雜操作（如批量保存）必須顯示載入狀態

---
