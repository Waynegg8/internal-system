# BR5: 成本管理（Costs）

**定位/目的**: 管理各類成本（專案/客戶/部門/全域），支援分類、附件、對帳與分析，為利潤計算與報表提供可靠依據。

**路由**
- 列表/總覽：`/finance/costs`
- 新增/編輯：`/finance/costs/:id?`

---

## 功能需求
- 成本紀錄維護：新增/編輯/刪除成本紀錄（日期、金額、幣別、分類、描述）
- 關聯維度：可選關聯 客戶/服務/任務/員工/部門/專案（任一或多個）
- 成本分類：支援多層分類與常用類別（租金、雲服務、交通、設備、外包、雜支等）
- 附件管理：上傳發票/收據影本（整合 R2），檢視與下載
- 查詢/篩選：依日期、分類、關聯維度、金額區間、是否可攤銷 等條件
- 攤銷/分攤：長期成本（如年費）可按月攤銷；部門/客戶間按比例分攤
- 對帳提示：與收據/工時/任務產生之成本對照，顯示差異
- 匯出：CSV 下載（依篩選條件）

---

## 驗收標準
- WHEN 使用者新增成本時 THEN 系統 SHALL 要求日期、金額與分類為必填並可上傳附件
- WHEN 使用者查詢成本時 THEN 系統 SHALL 依多條件篩選並正確分頁/排序
- WHEN 使用者設定攤銷 THEN 系統 SHALL 依期間自動產生攤銷明細並在月度檢視呈現
- WHEN 使用者關聯到客戶/服務/任務 THEN 系統 SHALL 於相關頁面可回看該成本清單
- WHEN 匯出成本清單 THEN 系統 SHALL 依目前篩選條件輸出 CSV，欄位齊全

---

## 業務規則
- 必填欄位：日期、金額、分類；金額必為正數
- 攤銷規則：按月等額攤銷；支援提早終止（剩餘一次攤銷）
- 分攤規則：按權重比例；需保存分攤依據（權重來源/快照）
- 權限：管理員可檢視所有成本；一般員工僅可見與自身或所屬部門相關之成本（依 RBAC）
- 附件存儲：使用 Cloudflare R2；僅已授權用戶可下載

---

## 與其他模組關聯
- 應計/獲利分析：成本資料提供 BR3.5 與 BR6 報表使用
- 客戶/任務：可從 `ClientDetail` 與 `TaskDetail` 回看關聯成本
- 權限與審計：所有操作留存審計日誌（建立/修改/刪除/下載附件）


