# Implementation Log: Task 6

**Summary:** 修改 computeAnnualClientProfitability 函數的成本計算邏輯，將固定的 DEFAULT_AVG_HOURLY_RATE 替換為基於員工實際時薪的計算。創建了 calculateAllEmployeesAnnualActualHourlyRate 函數，計算每個員工的年度實際時薪（全年薪資成本（應發）+ 全年管理費分攤）/ 全年工時。客戶成本計算為所有員工的 (員工實際時薪 × 該員工為該客戶的工時) 的總和。管理費已經包含在時薪中，不再單獨添加。

**Timestamp:** 2025-11-19T12:01:24.217Z
**Log ID:** 4894e8ee-06ba-4235-b2bc-2235a55e92c7

---

## Statistics

- **Lines Added:** +120
- **Lines Removed:** -2
- **Files Changed:** 1
- **Net Change:** 118

## Files Modified
- backend/src/handlers/reports/annual-client-profitability.js

## Files Created
_No files created_

---

## Artifacts

### Functions

#### calculateAllEmployeesAnnualActualHourlyRate
- **Purpose:** 計算所有員工的年度實際時薪（包含全年薪資成本和管理費分攤）
- **Location:** backend/src/handlers/reports/annual-client-profitability.js:97
- **Signature:** async function calculateAllEmployeesAnnualActualHourlyRate(env, year)
- **Exported:** No

#### computeAnnualClientProfitability
- **Purpose:** 計算年度客戶盈利能力報表，成本基於員工實際時薪
- **Location:** backend/src/handlers/reports/annual-client-profitability.js:200
- **Signature:** async function computeAnnualClientProfitability(env, year)
- **Exported:** Yes

### Integrations

#### Integration
- **Description:** 年度客戶毛利分析成本計算使用員工實際時薪，確保成本計算準確
- **Frontend Component:** AnnualClientProfitability
- **Backend Endpoint:** GET /api/v2/reports/annual/client-profitability?year={year}
- **Data Flow:** 前端請求 → Handler 檢查參數 → computeAnnualClientProfitability 計算員工實際時薪 → 計算客戶成本 → 返回結果

