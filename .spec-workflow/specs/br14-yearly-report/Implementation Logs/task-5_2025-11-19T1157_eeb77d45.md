# Implementation Log: Task 5

**Summary:** 修改 getAnnualRevenueByClient 函數使用 BR1.3.3 應計收入邏輯，取代原有的 Receipts 表查詢。函數現在使用 calculateAnnualAccruedRevenueByClient，該函數完全遵循 BR1.3.3 規則：定期服務按執行次數比例分攤收費計劃總金額，一次性服務直接使用收費計劃實際金額。保持向後兼容性，函數簽名和返回格式不變。

**Timestamp:** 2025-11-19T11:57:58.820Z
**Log ID:** eeb77d45-6353-4885-a433-a631248ec30a

---

## Statistics

- **Lines Added:** +30
- **Lines Removed:** -19
- **Files Changed:** 1
- **Net Change:** 11

## Files Modified
- backend/src/handlers/reports/revenue-allocation.js

## Files Created
_No files created_

---

## Artifacts

### Functions

#### getAnnualRevenueByClient
- **Purpose:** 取得某年度各客戶的應計收入總額，使用 BR1.3.3 規則
- **Location:** backend/src/handlers/reports/revenue-allocation.js:81
- **Signature:** async function getAnnualRevenueByClient(year, env)
- **Exported:** Yes

### Integrations

#### Integration
- **Description:** 年度客戶毛利分析使用 BR1 應計收入邏輯，通過 getAnnualRevenueByClient 獲取客戶年度收入
- **Frontend Component:** AnnualClientProfitability
- **Backend Endpoint:** GET /api/v2/reports/annual/client-profitability?year={year}
- **Data Flow:** 前端請求 → Handler 檢查參數 → computeAnnualClientProfitability 調用 getAnnualRevenueByClient → calculateAnnualAccruedRevenueByClient 計算 BR1 收入 → 返回結果

