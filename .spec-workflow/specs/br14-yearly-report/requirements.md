# Requirements Document: BR14: 年度報表

## Introduction

年度報表功能提供年度層級的經營數據全貌，統計各月累計與年對年趨勢，支持年度策略制定與績效考核。

**User Story**: 作為管理員，我需要查看年度報表，以便了解全年經營狀況、客戶獲利情況和員工績效表現，支持年度策略制定與績效考核。

## Alignment with Product Vision

本功能支持報表分析系統的核心目標：
- **提升管理決策效率**：提供準確的年度經營數據，支持管理層快速做出決策
- **支持績效考核**：提供員工和客戶的年度績效數據，支持績效考核和獎金分配
- **識別經營問題**：通過年度報表快速識別客戶獲利問題、員工績效問題等
- **支持策略制定**：提供年度趨勢數據，支持年度策略制定和目標設定

## Requirements

### BR14.1: 年度收款報表

**User Story**: 作為管理員，我需要查看年度收款報表，以便了解全年收款狀況。

#### 驗收標準
- WHEN 管理員查看年度收款報表時 THEN 系統 SHALL 顯示以下資訊：
  - 全年應收、實收、未收、逾期收回、年末逾期未收、年末總未收
  - 月度收款趨勢（1-12月）
  - 客戶年度彙總（可展開查看服務類型-月份明細）
  - 服務類型彙總（可展開查看客戶-月份明細）
- WHEN 管理員查看年度收款報表時 THEN 系統 SHALL 以收據開立日期（receipt_date）為準統計
- WHEN 管理員查看年度收款報表時 THEN 系統 SHALL 年末逾期未收取 12 月底的餘額（而非全年累計）
- WHEN 管理員查看年度收款報表時 THEN 系統 SHALL 金額顯示精度為 0 位小數（顯示到元）

### BR14.2: 年度薪資報表

**User Story**: 作為管理員，我需要查看年度薪資報表，以便了解全年薪資狀況。

#### 驗收標準
- WHEN 管理員查看年度薪資報表時 THEN 系統 SHALL 顯示以下資訊：
  - 全年總應發、總實發、月均應發、平均人數
  - 月度薪資趨勢（1-12月）
  - 按員工年度彙總（可查看月度明細）
- WHEN 管理員查看年度薪資報表時 THEN 系統 SHALL 從 PayrollCache 表讀取數據
- WHEN 管理員查看年度薪資報表時 THEN 系統 SHALL 如果某月快取缺失，自動觸發計算
- WHEN 管理員查看年度薪資報表時 THEN 系統 SHALL 如果計算結果真的是 0，則顯示 0
- WHEN 管理員查看年度薪資報表時 THEN 系統 SHALL 金額顯示精度為 0 位小數（顯示到元）

### BR14.3: 年度員工產值分析

**User Story**: 作為管理員，我需要查看年度員工產值分析，以便了解員工全年績效表現。

#### 驗收標準
- WHEN 管理員查看年度員工產值分析時 THEN 系統 SHALL 顯示以下資訊：
  - 員工全年標準工時、加權工時、工時差異
  - 員工產生收入、年度成本、年度毛利、毛利率
  - 月度趨勢（可查看）
  - 客戶分布（可查看）
- WHEN 管理員查看年度員工產值分析時 THEN 系統 SHALL 使用標準工時（排除加班工時）進行收入分配
- WHEN 管理員查看年度員工產值分析時 THEN 系統 SHALL 員工成本 = 全年薪資成本（應發）+ 全年管理費分攤
- WHEN 管理員查看年度員工產值分析時 THEN 系統 SHALL 顯示所有員工，即使沒有工時記錄或沒有服務任何客戶
- WHEN 管理員查看年度員工產值分析時 THEN 系統 SHALL 金額顯示精度為 0 位小數（顯示到元）

### BR14.4: 年度客戶毛利分析

**User Story**: 作為管理員，我需要查看年度客戶毛利分析，以便了解客戶全年獲利情況。

#### 驗收標準
- WHEN 管理員查看年度客戶毛利分析時 THEN 系統 SHALL 顯示以下資訊：
  - 客戶全年工時、加權工時、總成本、全年收入、毛利、毛利率、月均收入
  - 服務類型明細（可展開查看）
  - 服務類型彙總
- WHEN 管理員查看年度客戶毛利分析時 THEN 系統 SHALL 使用 BR1 應計收入邏輯計算客戶收入
- WHEN 管理員查看年度客戶毛利分析時 THEN 系統 SHALL 客戶成本基於員工實際時薪計算（已包含管理費分攤）
- WHEN 管理員查看年度客戶毛利分析時 THEN 系統 SHALL 服務類型收入分配使用 BR1 邏輯，按執行次數比例分攤
- WHEN 管理員查看年度客戶毛利分析時 THEN 系統 SHALL 金額顯示精度為 0 位小數（顯示到元）

### BR14.5: 年度篩選與報表管理

**User Story**: 作為管理員，我需要選擇不同年度查看報表，並能夠手動刷新報表。

#### 驗收標準
- WHEN 管理員切換年度時 THEN 系統 SHALL 於可接受時間內（<=700ms）返回快取或新鮮數據
- WHEN 管理員點擊刷新按鈕時 THEN 系統 SHALL 強制重新計算所有報表數據
- WHEN 管理員查看報表時 THEN 系統 SHALL 顯示報表載入狀態（載入中、已載入、載入失敗）
- WHEN 管理員查看報表時 THEN 系統 SHALL 路由為 `/reports/annual`

### BR14.6: 錯誤處理

**User Story**: 作為管理員，當報表載入失敗時，我需要查看詳細錯誤資訊以便排查問題。

#### 驗收標準
- WHEN 報表載入失敗時 THEN 系統 SHALL 顯示簡要錯誤訊息
- WHEN 報表載入失敗時 THEN 系統 SHALL 提供「查看詳情」按鈕顯示完整錯誤資訊
- WHEN 管理員點擊「查看詳情」按鈕時 THEN 系統 SHALL 顯示完整的錯誤堆疊和錯誤訊息

### BR14.7: 權限控制

**User Story**: 作為系統，我需要確保只有管理員可以訪問年度報表。

#### 驗收標準
- WHEN 非管理員用戶嘗試訪問年度報表時 THEN 系統 SHALL 返回 403 錯誤
- WHEN 非管理員用戶嘗試訪問年度報表時 THEN 系統 SHALL 前端顯示「權限不足」提示
- WHEN 管理員訪問年度報表時 THEN 系統 SHALL 顯示所有報表數據

---

## Non-Functional Requirements

### Code Architecture and Modularity
- **Single Responsibility Principle**: 每個文件只負責一個功能模組
- **Modular Design**: 組件、工具和服務應隔離且可重用
- **Dependency Management**: 最小化模組間的相互依賴
- **Clear Interfaces**: 定義組件和層級之間的清晰契約

### Performance
- API 響應時間 < 700ms（使用快取時）
- 頁面載入時間 < 3 秒
- 報表切換響應時間 < 1 秒

### Security
- 僅管理員可以訪問年度報表
- 使用參數化查詢防止 SQL 注入

### Reliability
- 報表數據準確
- 計算邏輯正確
- 與月度報表數據一致

### Usability
- 提供清晰的數據展示和排序功能
- 支援明細展開查看詳細資訊
- 數據格式易於閱讀和理解

## Business Rules

### 收入計算規則
- **年度收款報表**：以收據開立日期（receipt_date）為準，統計全年應收、期限內實收與逾期收回
  - **年末逾期未收**：取 12 月底的逾期未收餘額（而非全年累計）
- **年度客戶毛利分析**：使用 BR1 應計收入邏輯計算客戶收入
  - **定期服務**：按執行次數比例分攤收費計劃總金額
    - 計算定期服務總收費 = Σ(定期服務收費計劃中所有月份的金額)
    - 計算每個定期服務的執行次數 = execution_months 陣列的長度
    - 計算總執行次數 = Σ(所有關聯定期服務的執行次數)
    - 每個定期服務全年的分攤收入 = 定期服務總收費 × (該服務的執行次數 / 總執行次數)
  - **一次性服務**：直接使用收費計劃實際金額
    - 每個一次性服務全年的應計收入 = 該年度所有月份的金額總和
- **服務類型收入分攤**：使用 BR1 邏輯，按服務類型的執行次數比例分攤（定期服務按 execution_months，一次性服務直接使用實際金額）

### 成本計算規則
- **客戶成本**：基於員工實際時薪計算
  - 員工實際時薪 = (全年薪資成本（應發）+ 全年管理費分攤) / 全年工時
  - 客戶成本 = Σ(各員工實際時薪 × 該員工在該客戶的工時)
  - 注意：員工實際時薪已包含管理費分攤，不再額外加管理費
- **員工成本**：人工成本（薪資）+ 管理費分攤
  - 員工年度成本 = 全年薪資成本（應發）+ 全年管理費分攤

### 員工收入分配規則
- **分配方式**：使用標準工時（排除加班工時）進行收入分配
- **標準工時定義**：
  - 正常工時（work_type = 1）：全額計入
  - 固定 8 小時班別（work_type = 7, 10）：每日最多計入 8 小時
  - 加班工時（work_type = 2, 3, 4, 5, 6, 8, 9, 11, 12）：不計入標準工時
- **計算公式**：員工產生收入 = 客戶收入 × (員工標準工時 / 客戶總標準工時)

### 其他規則
- 指標以年為粒度；月度細節統一由 `BR13 月報表` 呈現
- 客戶獲利與員工績效的計算口徑與月報一致，但按年彙總
- 年度薪資報表：如果某月快取缺失，自動觸發計算；如果計算結果真的是 0，則顯示 0
- 年度員工產值分析：顯示所有員工，即使沒有工時記錄或沒有服務任何客戶
- 金額顯示精度：0 位小數（顯示到元）

### 報表快取規則
- **快取目的**：降低重算成本，加速切換年度時的體驗
- **快取鍵格式**：`annual:{year}:{reportType}`
  - `annual:{year}:revenue` - 年度收款報表
  - `annual:{year}:payroll` - 年度薪資報表
  - `annual:{year}:employee-performance` - 年度員工產值分析
  - `annual:{year}:client-profitability` - 年度客戶毛利分析
- **更新策略**：
  - 所有報表都應該支援 `refresh` 參數，強制重新計算
  - 手動刷新：在篩選器區域統一放置刷新按鈕，刷新所有報表
  - 自動失效：相關來源資料（收據、薪資、工時、成本、收費計劃）變更時標記失效
- **數據來源**：
  - 收據、薪資快取（PayrollCache）、工時（Timesheets）、成本分攤（CostAllocation）、收費計劃（BillingPlans）、服務執行頻率（ClientServices.execution_months）

