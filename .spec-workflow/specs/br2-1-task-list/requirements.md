# Requirements Document: BR2.1: 任務列表

## Introduction

任務列表功能提供統一的任務查看、篩選、統計和批量操作界面。本頁面為合併後的任務列表頁面（原「任務列表」和「任務總覽」已合併為單一頁面），幫助員工快速找到需要處理的任務、追蹤任務進度，並進行批量操作。

**User Story**: 作為會計師事務所的員工，我需要查看和管理任務列表，以便能夠快速找到需要處理的任務、追蹤任務進度，並進行批量操作。

## Alignment with Product Vision

本功能支持任務管理系統的核心目標：
- **提升任務管理效率**：集中展示所有任務，提供統一的查看和管理界面
- **快速定位任務**：提供靈活的篩選和搜尋功能，幫助員工快速找到目標任務
- **提升工作效率**：支援批量操作，減少重複操作
- **即時了解狀況**：提供統計摘要，快速了解任務整體狀況

## Requirements

### BR2.1.1: 任務列表展示

**User Story**: 作為員工，我需要查看任務列表，以便了解所有任務的狀況。

**驗收標準**:
- WHEN 員工打開任務列表頁面時 THEN 系統 SHALL 顯示所有任務（根據權限過濾）
- WHEN 員工查看任務列表時 THEN 系統 SHALL 按分組層級顯示：客戶 → 月份 → 服務 → 階段 → 任務
- WHEN 員工查看任務時 THEN 系統 SHALL 顯示以下資訊：
  - 任務名稱
  - 客戶名稱（可點擊跳轉到客戶詳情）
  - 服務月份（格式：YYYY-MM）
  - 服務名稱
  - 階段資訊（顯示「階段X/Y」，X為當前階段，Y為總階段數）
  - 負責人
  - 到期日
  - 狀態（pending、in_progress、completed、cancelled）
  - 是否逾期
  - 是否可開始（所有前置階段任務都已完成）
- WHEN 任務可開始時 THEN 系統 SHALL 以背景色高亮顯示
- WHEN 任務不可開始時 THEN 系統 SHALL 以灰色顯示或禁用狀態

### BR2.1.2: 篩選功能

**User Story**: 作為員工，我需要篩選任務列表，以便快速找到目標任務。

**驗收標準**:
- WHEN 員工使用服務月份篩選時 THEN 系統 SHALL 提供兩個年月選擇器（開始月份和結束月份）來設定區間
- WHEN 員工打開任務列表時 THEN 系統 SHALL 預設載入範圍為「還有未完成任務的月份」到「本月」
- WHEN 員工使用客戶搜尋時 THEN 系統 SHALL 支援按客戶名稱和統一編號搜尋
- WHEN 員工使用狀態快速切換時 THEN 系統 SHALL 提供快速切換按鈕（全部、進行中、已完成、已取消、逾期）
- WHEN 員工勾選「隱藏已完成」時 THEN 系統 SHALL 隱藏狀態為「已完成」的任務（但保留分組結構，如果分組中仍有未完成任務）
- WHEN 員工使用高級篩選時 THEN 系統 SHALL 提供可展開的高級篩選面板，包含：
  - 負責人篩選（多選）
  - 服務類型篩選（多選）
  - 標籤篩選（多選）
  - 是否可開始篩選（是/否）
- WHEN 員工使用「我的任務」篩選時 THEN 系統 SHALL 顯示整個服務的任務（不只有自己的任務），但高亮顯示負責人是自己的任務
- WHEN 員工取消「我的任務」篩選時 THEN 系統 SHALL 顯示所有任務（根據其他篩選條件）

### BR2.1.3: 統計摘要

**User Story**: 作為員工，我需要查看任務統計摘要，以便快速了解任務狀況。

**驗收標準**:
- WHEN 員工查看任務列表時 THEN 系統 SHALL 在頁面頂部顯示統計摘要
- WHEN 員工套用篩選條件時 THEN 系統 SHALL 即時更新統計摘要（按當前篩選條件計算）
- WHEN 系統顯示統計摘要時 THEN 系統 SHALL 包含以下資訊：
  - 總任務數
  - 進行中任務數
  - 已完成任務數
  - 逾期任務數
  - 可開始任務數

### BR2.1.4: 批量操作

**User Story**: 作為員工，我需要批量操作任務，以便提升工作效率。

**驗收標準**:
- WHEN 員工選擇多個任務時 THEN 系統 SHALL 允許批量操作（所有員工都可以使用，不限管理員）
- WHEN 員工執行批量操作時 THEN 系統 SHALL 支援以下操作：
  - 批量分配負責人
  - 批量更新狀態
  - 批量調整到期日
- WHEN 員工執行批量操作時 THEN 系統 SHALL 顯示操作確認對話框，列出將要操作的任務數量
- WHEN 員工確認批量操作時 THEN 系統 SHALL 執行操作並顯示成功提示

### BR2.1.5: 快速新增任務

**User Story**: 作為員工，我需要快速新增任務，以便及時記錄新任務。

**驗收標準**:
- WHEN 員工點擊「快速新增任務」按鈕時 THEN 系統 SHALL 跳轉到服務設定頁面（不是彈窗）
- WHEN 員工在任務卡片中點擊客戶名稱時 THEN 系統 SHALL 跳轉到客戶詳情頁面

---

## 業務規則

### 任務分組規則

- 任務按以下層級分組顯示：
  1. **客戶**：按客戶名稱分組
  2. **月份**：按服務月份（service_year + service_month）分組
  3. **服務**：按服務名稱分組
  4. **階段**：按階段編號（stage_order）分組，顯示「階段X/Y」
  5. **任務**：顯示具體任務

### 任務可開始判斷規則

- 任務可開始的條件：**所有前置階段的所有任務都必須是「已完成」狀態**
- 「已取消」狀態的任務不計入已完成（視為未完成，會阻止後續階段開始）
- 如果前置階段有任何任務不是「已完成」狀態，則後續階段的任務不可開始
- 同一階段內的任務之間沒有依賴關係（可並行執行）
- 階段編號（stage_order）較小的階段為前置階段

### 預設載入範圍規則

- 預設載入範圍：「還有未完成任務的月份」到「本月」
- 判斷邏輯：
  - 查找所有有未完成任務（status != 'completed'）的月份
  - 取最早月份作為開始月份
  - 取「本月」作為結束月份
  - 如果沒有未完成任務的月份，則預設為「本月」到「本月」

### 權限規則

- 所有員工都可以查看任務列表（根據篩選條件）
- 所有員工都可以使用批量操作（不限管理員）
- 「我的任務」篩選：顯示整個服務的任務，但高亮自己的任務

### 任務狀態規則

- **pending**：待處理（尚未開始）
- **in_progress**：進行中
- **completed**：已完成
- **cancelled**：已取消

### 逾期任務判斷規則

- 任務被視為逾期的條件：**到期日（due_date）小於當前日期，且任務狀態不是「已完成」或「已取消」**
- 已完成或已取消的任務不計入逾期任務
- 逾期任務在統計摘要中單獨計算
- 逾期任務可以通過狀態快速切換按鈕篩選

### 階段顯示規則

- 階段顯示格式：「階段X/Y」
  - X：當前階段編號（stage_order）
  - Y：該任務的總階段數
- 階段背景色高亮：可開始的階段以背景色高亮顯示

---

## 非功能性需求

### Code Architecture and Modularity
- **Single Responsibility Principle**: Each file should have a single, well-defined purpose
- **Modular Design**: Components, utilities, and services should be isolated and reusable
- **Dependency Management**: Minimize interdependencies between modules
- **Clear Interfaces**: Define clean contracts between components and layers

### 性能要求

- 頁面載入時間 < 3 秒
- 篩選操作響應時間 < 1 秒
- 統計摘要更新時間 < 500ms

### Security

- 所有輸入資料應進行驗證和清理，防止 SQL 注入和 XSS 攻擊
- 任務資料的存取應遵循權限控制機制
- 批量操作應驗證用戶權限
- 敏感資訊應在傳輸和存儲時進行適當保護

### 可用性要求

- 篩選條件應清晰易懂
- 批量操作應有明確的確認提示
- 任務分組應易於瀏覽和展開/折疊

### 可靠性要求

- 篩選條件應正確應用
- 統計摘要應準確反映當前篩選結果
- 批量操作應有錯誤處理和回滾機制

