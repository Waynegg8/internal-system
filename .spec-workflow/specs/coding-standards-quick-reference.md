# 編碼規範快速參考

> **重要**：這是核心規範的快速參考摘要。詳細規範請查看 `design.md`。
> 
> **位置**：此文件位於 `.spec-workflow/specs/` 根目錄，作為專案級別的編碼規範快速參考。
> 詳細的設計規範請查看 `.spec-workflow/specs/design.md` 或 `.spec-workflow/specs/project-documentation/design.md`。

## 使用說明

- **開發時**：優先查看此文件的檢查清單
- **需要詳細說明時**：查看 `design.md` 對應章節
- **遇到問題時**：查看 `design.md` 的「常見錯誤示例」

---

## 開發前必讀（5 分鐘）

### 1. 新功能開發流程（必須執行）

```
1. 分析功能需求 → 列出所有功能點
2. 檢查現有 API → 查看 backend/src/handlers/ 和 src/api/
3. 列出所需 API 端點 → 方法、路徑、請求/回應格式
4. 制定開發計劃 → 後端 API 優先，再前端
```

**檢查清單**：
- [ ] 已列出所有需要的 API 端點
- [ ] 已確認每個前端功能都有對應的 API
- [ ] 已確定開發順序（後端 → API 層 → 前端）

### 2. 資料庫開發流程（必須執行）

```
1. 查詢現有結構 → 使用 get_database_schema MCP 工具
2. 確認命名一致性 → 檢查現有欄位命名
3. 檢查可重用性 → 是否有現有表/欄位可重用
4. 遵循標準欄位 → created_at, updated_at, is_deleted
5. 創建遷移文件 → 記錄所有變更
```

**檢查清單**：
- [ ] 已查詢相關表的完整結構
- [ ] 已確認欄位命名符合規範（snake_case）
- [ ] 已包含標準欄位（created_at, updated_at, is_deleted）
- [ ] 已創建必要的索引（外鍵、軟刪除、時間戳）

### 3. 測試開發流程（必須執行）⚠️

**在編寫任何測試之前，必須主動考慮：**

```
1. 分析測試需求 → 需要測試哪些功能點和驗收標準？
2. 設置測試數據 → 需要哪些測試客戶、標籤、用戶？
3. 獲取帳號信息 → 需要管理員/員工帳號？如何獲取或創建？
4. 驗證測試數據 → 測試中使用數據前必須檢查是否存在
5. 處理邊界情況 → 沒有測試數據時的處理邏輯
```

**檢查清單**：
- [ ] 已在 `beforeAll` 中設置所有必要的測試數據
- [ ] 已獲取或創建所需的管理員/員工帳號
- [ ] 已使用測試數據工具（`setupBR1_1TestData` 等）
- [ ] 測試中使用數據前已檢查數據是否存在
- [ ] 已處理「沒有測試數據」的邊界情況
- [ ] 已確認環境變數（如 `PLAYWRIGHT_BASE_URL`）

**測試帳號信息**（可直接使用）：
- **管理員**: `admin` / `111111` (ID: 50)
- **一般員工**: `manager` / `111111` (經理一, ID: 51)
- **一般員工**: `liu` / `111111` (劉會計, ID: 52)
- **測試員工**: `test_employee` / `111111` (測試時自動創建)

---

## 核心規範檢查清單

### 資料庫表設計（創建新表時）

- [ ] **標準欄位**：`created_at`, `updated_at`, `is_deleted`（如適用）
- [ ] **主鍵**：命名 `表名_id`，類型正確
- [ ] **外鍵**：命名 `關聯表名_id`，已定義約束
- [ ] **索引**：外鍵索引、軟刪除索引、時間戳索引
- [ ] **命名**：表名 `PascalCase`，欄位名 `snake_case`

### API Handler 開發

- [ ] **工具函數**：使用 `successResponse`、`errorResponse`
- [ ] **結構**：try-catch 包裹，認證檢查，輸入驗證
- [ ] **查詢**：參數化查詢（`.bind()`），過濾 `is_deleted = 0`
- [ ] **錯誤**：記錄日誌，返回統一格式

### 前端 API 調用

- [ ] **工具函數**：使用 `extractApiData`、`extractApiArray`、`extractApiError`
- [ ] **錯誤處理**：try-catch 包裹，使用 `showError` 顯示
- [ ] **Loading**：處理 loading 狀態

### 輸入驗證

- [ ] **前端**：Ant Design Vue Form 驗證規則
- [ ] **後端**：API Handler 中驗證輸入
- [ ] **一致性**：前後端驗證規則一致

### 代碼重用（開發前檢查）

- [ ] **工具函數**：檢查 `src/utils/` 和 `backend/src/utils/`
- [ ] **組件**：檢查 `src/components/` 是否有可重用組件
- [ ] **API**：檢查 `src/api/` 是否有可重用函數
- [ ] **Store**：檢查 `src/stores/` 是否有可重用狀態

### 組件設計

- [ ] **職責單一**：組件不超過 500 行
- [ ] **Props**：類型定義、預設值、validator
- [ ] **Events**：動詞命名，只傳遞必要數據
- [ ] **Slots**：使用具名 slots 實現靈活性

### 性能優化

- [ ] **前端**：使用 `computed`、列表使用 `key`、懶加載大型組件
- [ ] **後端**：避免 N+1 查詢、使用索引、限制查詢數量

---

## 常見錯誤（嚴禁重複）

### ❌ 資料庫相關
1. 創建表時忘記標準欄位（created_at, updated_at, is_deleted）
2. 忘記創建外鍵索引
3. 忘記創建軟刪除索引
4. 自行編造欄位名稱（必須先查詢現有結構）

### ❌ API 相關
1. 先實現前端，後發現缺少 API
2. 前端和後端不同步（路徑、格式不一致）
3. 未檢查現有 API，重複實現

### ❌ 查詢相關
1. 直接拼接用戶輸入到 SQL（SQL 注入風險）
2. 忘記過濾 `is_deleted = 0`
3. N+1 查詢問題

### ❌ 代碼重用
1. 重複實現格式化、驗證等通用功能
2. 重複實現相同的 API 調用邏輯
3. 組件包含特定業務邏輯，無法重用

### ❌ 測試相關（嚴禁重複）⚠️
1. **未設置測試數據**：直接使用現有數據，假設數據存在
2. **未獲取帳號信息**：假設管理員/員工帳號存在且可用
3. **未檢查測試數據**：直接使用測試數據，未檢查是否存在
4. **未處理邊界情況**：沒有測試數據時的處理邏輯
5. **未使用測試數據工具**：手動創建測試數據，而非使用工具函數

---

## 快速查找表

| 需要查看 | 查看位置 |
|---------|---------|
| 資料庫標準欄位詳情 | `design.md` → 資料庫表設計規範 |
| API Handler 完整結構 | `design.md` → API Handler 開發規範 |
| 前端 API 調用範例 | `design.md` → 前端 API 調用規範 |
| 組件設計範例 | `design.md` → 組件設計規範 |
| 資料庫遷移策略 | `design.md` → 資料庫遷移規範 |
| 錯誤診斷流程 | `design.md` → 錯誤診斷與修復規範 |
| 代碼風格詳情 | `design.md` → 文件編碼與代碼風格規範 |
| **測試開發規範** | `design.md` → 測試開發規範 |
| 測試數據工具 API | `tests/e2e/utils/test-data.ts` |

---

## 關鍵原則（記住這 6 點）

1. **先檢查，再開發**：檢查現有代碼、API、資料庫結構
2. **後端優先**：先實現 API，再實現前端
3. **標準欄位**：所有表必須包含 created_at, updated_at, is_deleted
4. **參數化查詢**：嚴禁直接拼接用戶輸入到 SQL
5. **重用優先**：優先使用現有代碼，避免重複實現
6. **測試數據優先**：編寫測試前必須先設置測試數據和帳號信息 ⚠️

---

## 開發流程圖

```
開始開發新功能
    ↓
檢查現有代碼（API、組件、工具函數）
    ↓
列出所需 API 端點
    ↓
實現後端 API（Handler）
    ↓
實現前端 API 調用層（src/api/）
    ↓
實現前端功能（組件）
    ↓
測試和驗證
    ↓
清理調試信息
    ↓
完成
```

---

**最後更新**：2025-01-XX  
**詳細規範**：請查看 `.spec-workflow/specs/design.md`  
**Spec Workflow 規範**：此文件作為專案級別的編碼規範快速參考，符合 Spec Workflow 的輔助文檔規範

