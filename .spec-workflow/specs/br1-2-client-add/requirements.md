# BR1: 客戶管理

**業務價值**:
- 集中管理客戶資訊，提升客戶服務品質
- 追蹤客戶服務狀態，及時響應客戶需求
- 管理客戶帳務，確保財務準確性


---

## Introduction

BR1.2: 客戶新增功能是會計師事務所內部管理系統的核心模組之一，提供多步驟表單流程讓員工能夠完整記錄客戶的所有資訊，包括基本資訊、服務設定和帳務設定。本功能支援分頁獨立保存，允許員工分多次完成客戶新增流程，並提供複製現有客戶的功能，大幅提升工作效率。

## Alignment with Product Vision

本功能直接支持產品願景中的以下目標：
- **提升客戶服務品質**：透過完整的客戶資訊記錄，確保所有客戶資料的準確性和完整性
- **提高工作效率**：多步驟表單和分頁獨立保存設計，讓員工可以靈活安排工作時間，不需要一次性完成所有資訊填寫
- **確保財務準確性**：完整的帳務設定功能，確保客戶收費計劃的正確性
- **資料完整性**：統一的客戶編號設計（使用統一編號作為主鍵），確保資料的一致性和可追溯性

## Requirements

### Requirement 1: 多步驟表單流程

**User Story**: 作為會計師事務所的員工，我需要透過多步驟表單新增客戶，以便完整記錄客戶的所有資訊。

**頁面結構說明**:
- 客戶新增頁面（`/clients/add`）是一個獨立的頁面，使用 Tabs 導航的三個獨立分頁
- 路由結構：
  - `/clients/add` → 客戶新增主頁面（ClientAdd.vue），包含三個 Tabs
  - `/clients/add/basic` → 分頁1：基本資訊（ClientAddBasic.vue）
  - `/clients/add/services` → 分頁2：服務設定（ClientAddServices.vue）
  - `/clients/add/billing` → 分頁3：帳務設定（ClientAddBilling.vue）
- 每個分頁都可以獨立保存，不需要完成所有分頁才能保存

#### Acceptance Criteria

1. WHEN 員工進入新增客戶頁面時 THEN 系統 SHALL 提供選擇模式：「新增空白客戶」或「從現有客戶複製」
2. WHEN 員工選擇「新增空白客戶」時 THEN 系統 SHALL 顯示三個 Tabs（基本資訊、服務設定、帳務設定）
3. WHEN 員工在基本資訊分頁點擊保存時 THEN 系統 SHALL 創建客戶基本資料並允許後續分頁繼續填寫
4. WHEN 員工在服務設定分頁點擊保存時 THEN 系統 SHALL 保存服務設定（客戶必須已存在）
5. WHEN 員工在帳務設定分頁點擊保存時 THEN 系統 SHALL 保存帳務設定（客戶必須已存在）
6. WHEN 員工完成所有分頁並點擊最終提交時 THEN 系統 SHALL 完成客戶創建並跳轉至客戶詳情頁
7. WHEN 員工在任何分頁保存後 THEN 系統 SHALL 允許隨時返回該客戶繼續填寫其他分頁

### Requirement 2: 基本資訊填寫與保存

**User Story**: 作為會計師事務所的員工，我需要填寫客戶基本資訊並能夠獨立保存，以便分多次完成客戶新增流程。

#### Acceptance Criteria

1. WHEN 員工在基本資訊分頁填寫統一編號時 THEN 系統 SHALL 根據客戶類型自動格式化：
   - 企業客戶：輸入8碼統一編號，系統自動加前綴 `00` 存入（變成10碼）
   - 個人客戶：輸入10碼身分證，直接存入統一編號欄位
2. WHEN 員工填寫基本資訊表單時 THEN 系統 SHALL 即時驗證必填欄位和格式
3. WHEN 員工點擊保存基本資訊時 THEN 系統 SHALL 創建客戶記錄並返回客戶 ID
4. IF 使用相同的統一編號重新新增 THEN 系統 SHALL 檢查是否已存在（包括已刪除的），如果存在且已刪除則恢復該客戶
5. IF 統一編號已存在且未刪除 THEN 系統 SHALL 返回錯誤提示，不允許重複建立

### Requirement 3: 複製現有客戶功能

**User Story**: 作為會計師事務所的員工，我需要能夠從現有客戶複製資訊，以便快速建立相似客戶，減少重複輸入。

#### Acceptance Criteria

1. WHEN 員工選擇「從現有客戶複製」時 THEN 系統 SHALL 顯示客戶選擇器（可搜尋、篩選）
2. WHEN 員工選擇現有客戶時 THEN 系統 SHALL 自動帶入該客戶的所有資訊（基本資訊、服務設定、帳務設定）
3. WHEN 系統複製客戶資訊時 THEN 系統 SHALL 自動清除客戶專屬資訊（如客戶 ID、統一編號），避免混淆
4. WHEN 員工修改複製的客戶資訊後保存時 THEN 系統 SHALL 創建新客戶，不影響原始客戶

### Requirement 4: 服務項目設定

**User Story**: 作為會計師事務所的員工，我需要為客戶設定服務項目及其配置，以便管理客戶的服務內容。

#### Acceptance Criteria

1. WHEN 員工在服務設定分頁添加服務時 THEN 系統 SHALL 允許配置服務類型、執行頻率、任務配置等
2. WHEN 員工保存服務設定時 THEN 系統 SHALL 驗證客戶必須已存在（已保存基本資訊）
3. WHEN 員工修改或刪除服務時 THEN 系統 SHALL 保存變更並更新客戶服務關聯

### Requirement 5: 帳務設定

**User Story**: 作為會計師事務所的員工，我需要為客戶設定收費計劃，以便管理客戶的帳務資訊。

#### Acceptance Criteria

1. WHEN 員工在帳務設定分頁添加收費計劃時 THEN 系統 SHALL 允許配置年度、月份、金額、關聯服務等
2. WHEN 員工保存帳務設定時 THEN 系統 SHALL 驗證客戶必須已存在（已保存基本資訊）
3. WHEN 員工修改或刪除收費計劃時 THEN 系統 SHALL 保存變更並更新客戶帳務關聯

**業務規則**:
- 每個分頁都可以獨立保存，不需要完成所有分頁才能保存
- 基本資訊分頁保存後，客戶即被創建（但服務和帳務資訊可能尚未完成）
- 服務設定和帳務設定分頁保存時，客戶必須已存在（已保存基本資訊）
- 員工可以分多次完成客戶新增流程，每次保存後可以離開，之後再回來繼續填寫
- 統一編號（tax_registration_number）直接作為客戶編號（client_id），必須唯一（主鍵）
- 統一編號欄位統一存儲10碼格式
- 企業客戶：輸入8碼統一編號，系統自動加前綴 `00` 存入（變成10碼）
- 個人客戶：輸入10碼身分證，直接存入統一編號欄位
- 如果使用相同的統一編號重新新增，系統應檢查是否已存在（包括已刪除的），如果存在且已刪除則恢復該客戶
- **複製現有客戶功能**:
  - 進入客戶新增頁面時，系統提供選擇模式：「新增空白客戶」或「從現有客戶複製」
  - 選擇「從現有客戶複製」時，系統顯示客戶選擇器（可搜尋、篩選）
  - 選擇客戶後，系統自動帶入該客戶的所有資訊：
    - 基本資訊：複製所有欄位（公司名稱、統一編號等需要手動修改）
    - 服務設定：複製所有服務及其配置（包括服務類型、執行頻率、任務配置等）
    - 帳務設定：複製所有收費計劃（包括年度、月份、金額、關聯服務等）
  - 系統自動清除客戶專屬資訊（如客戶 ID、統一編號等），避免混淆
  - 用戶只需要修改不同的部分（如公司名稱、統一編號、收費金額等）
  - 保存複製的客戶時，創建新客戶，不影響原始客戶

## Non-Functional Requirements

### Code Architecture and Modularity
- **Single Responsibility Principle**: 每個組件和 Handler 只負責一個功能模組（基本資訊、服務設定、帳務設定）
- **Modular Design**: 三個分頁組件（ClientAddBasic、ClientAddServices、ClientAddBilling）相互獨立，可獨立保存和載入
- **Dependency Management**: 前端組件通過 API 層與後端通信，後端 Handler 通過統一的工具函數處理資料庫操作
- **Clear Interfaces**: API 端點定義清晰的請求/回應格式，組件通過 props 和 events 通信

### Performance
- **API 響應時間**: < 500ms（正常情況）
- **頁面載入時間**: < 3 秒
- **表單驗證**: 即時驗證，無明顯延遲
- **資料保存**: 單個分頁保存操作 < 1 秒

### Security
- **權限控制**: 所有 API 端點需要認證，只有已登入用戶可以新增客戶
- **資料驗證**: 前端和後端雙重驗證，防止無效資料提交
- **SQL 注入防護**: 使用參數化查詢，防止 SQL 注入攻擊
- **統一編號唯一性**: 系統自動檢查統一編號唯一性，防止重複建立

### Reliability
- **錯誤處理**: 所有 API 操作都有完整的錯誤處理機制，返回友好的錯誤訊息
- **資料一致性**: 使用事務確保多表操作的原子性（如服務設定和帳務設定）
- **軟刪除恢復**: 如果使用已刪除客戶的統一編號重新新增，系統自動恢復該客戶
- **快取失效**: 新增或更新客戶後，自動清除相關快取

### Usability
- **分頁獨立保存**: 每個分頁都可以獨立保存，不需要完成所有分頁才能保存
- **進度提示**: 清楚顯示當前所在分頁和完成狀態
- **表單驗證**: 即時顯示驗證錯誤，幫助用戶快速修正
- **複製功能**: 提供複製現有客戶功能，減少重複輸入
- **自動填充**: 複製客戶時自動帶入所有資訊，用戶只需修改不同部分

---
