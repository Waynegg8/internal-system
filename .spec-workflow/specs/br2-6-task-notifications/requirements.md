# Requirements Document: BR2.6: 任務到期提醒

## Introduction

任務到期提醒功能自動檢查任務狀態並發送提醒通知，及時通知相關人員任務即將到期或已逾期。系統每日檢查並發送站內通知，確保提醒及時送達。

**User Story**: 作為會計師事務所的系統，我需要發送任務到期提醒，以便及時通知相關人員任務即將到期或已逾期。

## Alignment with Product Vision

本功能支持任務管理系統的核心目標：
- **確保任務按時完成**：及時提醒任務負責人，確保任務按時完成
- **提升協作效率**：通知相關人員（任務負責人、客戶負責人），提升協作效率
- **及時送達提醒**：使用站內通知，確保提醒及時送達
- **準確及時檢查**：每日檢查，確保提醒準確及時

## Requirements

### BR2.6.1: 任務逾期提醒

**User Story**: 作為系統，我需要發送任務逾期提醒，以便通知相關人員任務已逾期。

**驗收標準**:
- WHEN 任務到期日已過且任務未完成時 THEN 系統 SHALL 標記任務為逾期
- WHEN 系統每日檢查逾期任務時 THEN 系統 SHALL 在每天 02:00（台灣時間）執行檢查
- WHEN 系統發現逾期任務時 THEN 系統 SHALL 發送站內通知給以下人員：
  - 任務負責人（必送）
  - 客戶負責人（必送）
  - 註：階段（ActiveTaskStages）目前無獨立負責人字段，階段相關通知發送給任務負責人
- WHEN 系統發送逾期提醒時 THEN 系統 SHALL 包含以下資訊：
  - 任務名稱
  - 客戶名稱
  - 服務名稱
  - 到期日
  - 逾期天數
  - 任務詳情連結

### BR2.6.2: 任務即將到期提醒

**User Story**: 作為系統，我需要發送任務即將到期提醒，以便提前通知任務負責人。

**驗收標準**:
- WHEN 任務到期日前1天且任務未完成時 THEN 系統 SHALL 發送即將到期提醒
- WHEN 系統每日檢查即將到期任務時 THEN 系統 SHALL 在每天 02:00（台灣時間）執行檢查
- WHEN 系統發現即將到期任務時 THEN 系統 SHALL 發送站內通知給以下人員：
  - 任務負責人（必送）
  - 客戶負責人（必送）
  - 註：階段（ActiveTaskStages）目前無獨立負責人字段，階段相關通知發送給任務負責人
- WHEN 系統發送即將到期提醒時 THEN 系統 SHALL 包含以下資訊：
  - 任務名稱
  - 客戶名稱
  - 服務名稱
  - 到期日
  - 剩餘天數（1天）
  - 任務詳情連結

### BR2.6.3: 前置任務延誤通知

**User Story**: 作為系統，我需要發送前置任務延誤通知，以便通知後續任務負責人。

**驗收標準**:
- WHEN 前置任務延誤影響後續任務時 THEN 系統 SHALL 發送通知給以下人員：
  - 後續任務負責人（必送，通過查詢 prerequisite_task_id = 前置任務ID 的所有任務）
  - 客戶負責人（必送）
  - 註：階段（ActiveTaskStages）目前無獨立負責人字段，階段相關通知發送給任務負責人
- WHEN 系統發送前置任務延誤通知時 THEN 系統 SHALL 包含以下資訊：
  - 前置任務名稱和延誤情況
  - 受影響的後續任務列表
  - 調整後的到期日（如果適用）
  - 任務詳情連結

### BR2.6.4: 固定期限任務衝突通知

**User Story**: 作為系統，我需要發送固定期限任務衝突通知，以便通知相關人員任務時間衝突。

**驗收標準**:
- WHEN 前置任務延誤導致中間任務無法在固定期限前完成時 THEN 系統 SHALL 發送通知
  - 註：固定期限任務的識別方式需從任務配置（ClientServiceTaskConfigs）或任務屬性中判斷，具體實現需參考任務生成邏輯
- WHEN 系統發送固定期限任務衝突通知時 THEN 系統 SHALL 發送給以下人員：
  - 中間任務負責人（必送）
  - 固定期限任務負責人（必送）
  - 客戶負責人（必送）
  - 註：階段（ActiveTaskStages）目前無獨立負責人字段，階段相關通知發送給任務負責人
- WHEN 系統發送固定期限任務衝突通知時 THEN 系統 SHALL 包含以下資訊：
  - 前置任務延誤情況
  - 中間任務調整後的到期日
  - 固定期限任務的到期日
  - 衝突說明
  - 任務詳情連結

### BR2.6.5: 站內通知機制

**User Story**: 作為員工，我需要接收站內通知，以便及時了解任務提醒。

**驗收標準**:
- WHEN 系統發送任務提醒時 THEN 系統 SHALL 使用站內通知機制
- WHEN 員工登入系統時 THEN 系統 SHALL 顯示未讀通知數量
- WHEN 員工查看通知時 THEN 系統 SHALL 顯示通知列表，包括：
  - 通知類型（逾期、即將到期、延誤、衝突）
  - 通知內容
  - 通知時間
  - 相關任務連結
- WHEN 員工點擊通知時 THEN 系統 SHALL 跳轉到相關任務詳情頁面
- WHEN 員工查看通知後 THEN 系統 SHALL 標記通知為已讀

### BR2.6.6: 通知頻率控制

**User Story**: 作為系統，我需要控制通知頻率，以便避免重複通知。

**驗收標準**:
- WHEN 系統發送任務提醒時 THEN 系統 SHALL 每日只發送一次（每天 02:00 執行）
- WHEN 任務已發送過提醒時 THEN 系統 SHALL 記錄提醒發送時間
- WHEN 任務狀態變更時 THEN 系統 SHALL 更新提醒狀態（例如：任務完成後不再發送提醒）
- WHEN 任務到期日調整時 THEN 系統 SHALL 重新計算提醒時間

---

## 業務規則

### 任務逾期判斷規則

- 任務到期日已過且任務狀態不是「已完成」或「已取消」時，標記為逾期
- 逾期天數 = 當前日期 - 到期日
- 系統每日檢查逾期任務，並發送提醒

### 任務即將到期判斷規則

- 任務到期日前1天且任務狀態不是「已完成」或「已取消」時，發送即將到期提醒
- 剩餘天數 = 到期日 - 當前日期
- 系統每日檢查即將到期任務，並發送提醒

### 通知對象規則

- 任務逾期/即將到期提醒發送給：
  - 任務負責人（必送，從 ActiveTasks.assignee_user_id 獲取）
  - 客戶負責人（必送，從 Clients.assignee_user_id 獲取）
  - 註：ActiveTaskStages 表目前無獨立負責人字段，階段相關通知統一發送給任務負責人
- 前置任務延誤通知發送給：
  - 後續任務負責人（必送，通過查詢 ActiveTasks WHERE prerequisite_task_id = 前置任務ID）
  - 客戶負責人（必送）
- 固定期限任務衝突通知發送給：
  - 中間任務負責人（必送）
  - 固定期限任務負責人（必送）
  - 客戶負責人（必送）
  - 註：固定期限任務的識別需參考任務生成邏輯，可能需從 ClientServiceTaskConfigs 或任務屬性判斷

### 通知頻率規則

- 系統每日 02:00（台灣時間）執行檢查並發送提醒
- 每種提醒類型每日只發送一次
- 任務狀態變更後，重新計算提醒狀態

### 站內通知規則

- 所有任務提醒使用站內通知機制
- 通知包含任務詳情連結，點擊可跳轉到任務詳情頁面
- 通知支援已讀/未讀狀態
- 通知列表支援按類型、時間篩選

---

## 非功能性需求

### Code Architecture and Modularity
- **Single Responsibility Principle**: Each file should have a single, well-defined purpose
- **Modular Design**: Components, utilities, and services should be isolated and reusable
- **Dependency Management**: Minimize interdependencies between modules
- **Clear Interfaces**: Define clean contracts between components and layers

### 性能要求

- 通知檢查執行時間 < 30 秒
- 通知發送響應時間 < 1 秒
- 通知列表載入時間 < 1 秒

### Security

- 通知內容應進行適當的清理，防止 XSS 攻擊
- 通知資料的存取應遵循權限控制機制
- 通知發送應驗證接收者權限
- 敏感資訊應在通知中進行適當保護

### 可靠性要求

- 通知發送失敗時有明確錯誤記錄
- 通知發送狀態可追蹤
- 避免重複發送通知

### 可用性要求

- 通知內容清晰易懂
- 通知連結準確有效
- 通知列表易於查看和管理

