# BR1: 客戶管理

**業務價值**:
- 集中管理客戶資訊，提升客戶服務品質
- 追蹤客戶服務狀態，及時響應客戶需求
- 管理客戶帳務，確保財務準確性


---

#### BR1.1: 客戶列表管理

**User Story**: 作為會計師事務所的員工，我需要搜尋和篩選客戶列表，以便快速找到目標客戶，並能夠批量移轉客戶負責人。

**功能需求**:
- BR1.1.1: 客戶列表展示 ✅ 已實現
- BR1.1.2: 客戶搜尋功能 ✅ 已實現
- BR1.1.3: 客戶篩選功能 ✅ 已實現
- BR1.1.4: 客戶標籤管理 ✅ 已實現
- BR1.1.5: 批量移轉客戶負責人 ✅ 已實現
- BR1.1.6: 刪除客戶 ✅ 已實現

**驗收標準**:
- WHEN 員工查看客戶列表時 THEN 系統 SHALL 顯示以下欄位：
  - 統一編號（tax_registration_number / client_id）：統一顯示10碼格式，企業客戶顯示 `00` + 8碼統一編號，個人客戶顯示10碼身分證，等寬字體顯示，作為客戶唯一識別碼
  - 公司名稱（company_name）：可點擊連結至客戶詳情頁
  - 聯絡人（contact_person_1）：主要聯絡人姓名
  - 電話（phone）：聯絡電話
  - 負責人（assignee_user_id）：負責此客戶的員工姓名，未分配時顯示「未分配」
  - 標籤（tags）：顯示最多2個標籤，超過時顯示「+N」
  - 服務數量（services_count）：該客戶的服務項目總數，以藍色標籤顯示
  - 全年收費（year_total）：該客戶所有服務的年度收費總額，以綠色顯示
  - 操作（action）：刪除按鈕（僅管理員可見）
- WHEN 員工搜尋客戶時 THEN 系統 SHALL 支援按公司名稱、統一編號、標籤等條件快速搜尋
- WHEN 員工使用標籤篩選時 THEN 系統 SHALL 顯示符合標籤條件的客戶
- WHEN 員工查看客戶列表時 THEN 系統 SHALL 支援分頁顯示（預設每頁50筆）
- WHEN 員工選擇多個客戶並執行批量移轉時 THEN 系統 SHALL 允許批量更改客戶負責人
- WHEN 員工執行批量移轉前 THEN 系統 SHALL 支援預覽模式，顯示將要移轉的客戶列表
- WHEN 員工使用快速移轉功能時 THEN 系統 SHALL 支援按目前負責人、標籤、關鍵字等條件篩選客戶進行批量移轉
- WHEN 員工在客戶列表中刪除客戶時 THEN 系統 SHALL 執行軟刪除，保留歷史記錄

**業務規則**:
- 員工只能查看自己有權限的客戶（管理員可查看所有，一般員工只能查看自己負責或協作的客戶）
- 客戶標籤可用於分類和篩選
- 批量移轉可以選擇特定客戶、或按目前負責人篩選、或包含未分配的客戶
- 新負責人不得與目前負責人相同
- 批量移轉前可以預覽將要移轉的客戶列表
- 只有管理員可以刪除客戶
- **客戶編號（client_id）設計說明**:
  - 客戶編號（client_id）直接使用統一編號（tax_registration_number），不再有單獨的客戶編號欄位
  - 客戶編號作為主鍵（PRIMARY KEY），用於系統內部識別和關聯
  - 客戶編號作為外鍵被多個表引用：ClientServices、ClientTagAssignments、ClientCollaborators、Tasks、Timesheets、Receipts 等
  - **統一編號格式設計**（統一存儲10碼格式）:
    - **企業客戶**：
      - 輸入：8碼統一編號（例如：`12345678`）
      - 驗證規則：必須是8碼數字
      - 存儲：系統自動加前綴 `00`，存入統一編號欄位（例如：`0012345678`）
      - 統一編號欄位值直接作為客戶編號（client_id）
      - 顯示時可選擇顯示完整10碼或去掉前綴 `00` 顯示8碼
    - **個人客戶**：
      - 輸入：10碼身分證（例如：`A123456789`）
      - 驗證規則：必須是10碼（可以是字母+數字組合）
      - 存儲：直接存入統一編號欄位（例如：`A123456789`）
      - 統一編號欄位值直接作為客戶編號（client_id）
    - **優點**:
      - 統一編號欄位格式統一（都是10碼），便於資料庫存儲和查詢
      - 簡化設計：統一編號就是客戶編號，不需要額外的客戶編號欄位
      - 業務邏輯清晰：企業客戶輸入8碼自動補00，個人客戶輸入10碼直接使用
      - 減少資料冗餘：不需要同時維護客戶編號和統一編號兩個欄位
      - 企業客戶的統一編號可以通過去掉前綴 `00` 還原為原始8碼
    - **資料庫存儲說明**:
      - client_id 在資料庫中定義為 TEXT 類型（`client_id TEXT PRIMARY KEY`）
      - TEXT 類型完全支持存儲字母+數字組合（例如：`A123456789`）
      - 個人客戶第一碼是英文字母不會影響資料庫存儲或查詢性能
      - 所有使用 client_id 作為外鍵的表也都是 TEXT 類型，完全兼容
      - SQLite/D1 對 TEXT 主鍵的索引和查詢性能良好，無需擔心
    - **實施要求**:
      - 統一編號驗證：企業客戶驗證8碼數字，個人客戶驗證10碼
      - 企業客戶輸入8碼統一編號時，系統自動加前綴 `00` 存入（變成10碼）
      - 統一編號欄位統一存儲10碼格式
      - 統一編號欄位值直接作為 client_id 使用
      - 不需要資料遷移（系統為測試階段，可重新建立）
      - 不需要複雜的驗證邏輯（只需驗證長度和格式）
- **軟刪除保留的記錄**:
  - 客戶的所有基本資訊（公司名稱、統一編號、聯絡方式、備註等）
  - 客戶的所有關聯數據（服務項目、任務記錄、工時記錄、收據記錄等）
  - 客戶標籤（ClientTagAssignments）會保留（因為軟刪除不會觸發 CASCADE）
  - 客戶協作者（ClientCollaborators）會保留（因為軟刪除不會觸發 CASCADE）
  - 刪除時間（deleted_at）和刪除人（deleted_by）
  - 已刪除的客戶不會出現在客戶列表中，但數據仍保留在資料庫中
- **重新新增客戶的處理**:
  - 統一編號（tax_registration_number）直接作為客戶編號（client_id），因此統一編號必須唯一
  - 如果使用相同的統一編號重新新增，會發生主鍵衝突，無法新增
  - **處理方式**（建議實現）:
    - 新增客戶時，檢查該統一編號是否已存在（包括已刪除的）
    - 如果存在且已刪除，則恢復該客戶並更新資訊（將 `is_deleted` 設為 0，清除 `deleted_at` 和 `deleted_by`）
    - 如果不存在，則新增
    - 恢復後客戶會重新出現在列表中，所有關聯數據（標籤、協作者、服務等）都會恢復

---
