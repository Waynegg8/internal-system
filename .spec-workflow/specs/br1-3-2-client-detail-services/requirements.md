# Requirements Document: BR1.3.2: 客戶詳情頁 - 服務項目分頁

## Introduction

本功能提供客戶詳情頁中的服務項目管理分頁，允許員工管理客戶的服務項目和任務配置。這是客戶管理系統的核心模組之一，支援服務列表查看、新增/編輯/刪除服務、任務配置、一次性服務執行等功能，幫助員工高效地追蹤服務狀態並自動生成任務。

**頁面結構說明**:
- 客戶服務項目管理是客戶詳情頁（ClientDetail）的一個獨立分頁（Tab）
- 路由：`/clients/:id/services` → 服務分頁（ClientServices.vue）
- 服務任務配置詳情頁：`/clients/:clientId/services/:clientServiceId/config` → 服務配置頁（ClientServiceConfig.vue）
- 包含服務列表、新增/編輯服務、刪除服務、任務配置等功能

## Alignment with Product Vision

本功能支援產品願景中的以下目標：
- **提升客戶服務品質**：集中管理客戶服務項目，及時響應客戶需求
- **提高工作效率**：自動化任務生成流程，減少重複操作
- **確保財務準確性**：完整的服務管理和收費計劃追蹤
- **資料完整性**：保留歷史記錄，支援審計和報表生成

## Requirements

### Requirement 1: 客戶服務列表管理

**User Story**: 作為會計師事務所的員工，我需要查看和管理客戶的服務列表，以便追蹤服務狀態和執行情況。

#### Acceptance Criteria

1. WHEN 員工查看客戶服務列表時 THEN 系統 SHALL 顯示服務名稱、狀態、年度總額、任務配置數量、服務類型、執行次數等資訊
2. WHEN 員工為客戶新增服務項目時 THEN 系統 SHALL 驗證服務是否已存在，避免重複新增
3. WHEN 員工刪除服務時 THEN 系統 SHALL 執行軟刪除，保留歷史記錄
4. WHEN 員工點擊「配置任務」時 THEN 系統 SHALL 跳轉至服務任務配置詳情頁

### Requirement 2: 新增和編輯客戶服務

**User Story**: 作為會計師事務所的員工，我需要新增和編輯客戶的服務項目，以便管理客戶的服務配置。

#### Acceptance Criteria

1. WHEN 員工新增服務時 THEN 系統 SHALL 從系統設置的服務類型列表下拉選擇服務類型
2. WHEN 員工新增服務時 THEN 系統 SHALL 驗證服務必須存在且為啟用狀態
3. WHEN 員工新增服務時 THEN 系統 SHALL 允許選擇服務類型（定期服務 / 一次性服務）
4. WHEN 員工新增服務時 THEN 系統 SHALL 自動從服務類型帶入預設執行頻率、服務類型、是否用於自動生成任務（從 Services 表的 default_service_type、default_execution_months、default_use_for_auto_generate）
5. WHEN 系統帶入預設值時 THEN 系統 SHALL 允許用戶修改這些預設值
6. WHEN 服務類型沒有設定預設值時 THEN 系統 SHALL 要求用戶手動設定
7. WHEN 員工新增服務時 THEN 系統 SHALL 允許設定服務狀態（使用中、暫停、已到期、已取消）和開始日期
8. WHEN 員工編輯服務配置時 THEN 系統 SHALL 允許修改服務狀態、開始日期、執行頻率、是否用於自動生成任務等

### Requirement 3: 服務執行頻率設定

**User Story**: 作為會計師事務所的員工，我需要設定服務的執行頻率，以便系統根據頻率自動生成任務。

#### Acceptance Criteria

1. WHEN 員工新增定期服務時 THEN 系統 SHALL 要求設定執行頻率（勾選執行月份）
2. WHEN 員工新增一次性服務時 THEN 系統 SHALL 不要求設定執行頻率（執行月份為空）
3. WHEN 員工設定服務執行頻率時 THEN 系統 SHALL 允許直接勾選執行月份（1-12 月），不需要預設選項
4. WHEN 員工設定服務執行頻率時 THEN 系統 SHALL 驗證定期服務必須至少勾選一個月份
5. WHEN 員工設定服務時 THEN 系統 SHALL 允許選擇是否用於自動生成任務

### Requirement 4: 一次性服務執行

**User Story**: 作為會計師事務所的員工，我需要執行一次性服務，以便完成收費計劃建立和任務生成。

#### Acceptance Criteria

1. WHEN 員工點擊「執行服務」按鈕（一次性服務）時 THEN 系統 SHALL 彈出對話框，允許選擇執行月份、填寫收費金額，並自動完成收費計劃建立/更新和任務生成
2. WHEN 員工執行一次性服務時 THEN 系統 SHALL 立即生成任務（不需要等待自動生成）
3. WHEN 員工執行一次性服務時 THEN 系統 SHALL 自動建立/更新該年度該服務的一次性服務收費計劃

### Requirement 5: 任務配置管理

**User Story**: 作為會計師事務所的員工，我需要配置服務的任務設定，以便系統自動生成任務。

#### Acceptance Criteria

1. WHEN 員工在服務任務配置詳情頁時 THEN 系統 SHALL 允許從當前服務類型下的任務類型列表下拉選擇任務名稱、設定階段編號、負責人、預估工時、任務生成時間、到期日等
2. WHEN 員工配置任務時 THEN 系統 SHALL 允許從系統設置的任務模板中選擇並套用模板
3. WHEN 員工套用任務模板後 THEN 系統 SHALL 允許修改任務細節，且修改不會影響原始模板
4. WHEN 員工配置服務任務時 THEN 系統 SHALL 支援批量保存任務配置
5. WHEN 員工保存任務配置時 THEN 系統 SHALL 返回服務列表頁面

### Requirement 6: 任務生成時間和到期日設置

**User Story**: 作為會計師事務所的員工，我需要設定任務的生成時間和到期日規則，以便系統自動生成任務並設定期限。

#### Acceptance Criteria

1. WHEN 員工設定任務生成時間時 THEN 系統 SHALL 允許選擇生成時間規則（服務月份開始時、前一個月最後X天、前一個月第X天、後一個月開始時）
2. WHEN 員工設定任務到期日時 THEN 系統 SHALL 允許選擇到期日規則（服務月份結束時、後一個月結束時、後N個月結束時、固定日期、固定期限）
3. WHEN 員工配置任務生成時間和到期日時 THEN 系統 SHALL 即時顯示預覽效果（例如「3月的任務在3月1日生成，到期日是3月15日」）
4. WHEN 員工設定任務到期日時 THEN 系統 SHALL 允許設置為「固定期限任務」（不受前面任務延後影響）

### Requirement 7: SOP 自動綁定

**User Story**: 作為會計師事務所的員工，我需要系統自動綁定相關的 SOP，以便任務執行時參考標準作業程序。

#### Acceptance Criteria

1. WHEN 員工創建任務時 THEN 系統 SHALL 自動從知識庫讀取符合條件的服務層級SOP（服務類型層級 = 當前服務類型，層級 = 服務層級，客戶 = 統一模板或當前客戶）
2. WHEN 員工選擇服務層級SOP時 THEN 系統 SHALL 允許多選，也可以取消預設帶入的SOP
3. WHEN 客戶在同一個服務類型下有多個專屬服務層級SOP時 THEN 系統 SHALL 全部帶入，員工自行判斷是否都選擇
4. WHEN 員工選擇任務層級SOP時 THEN 系統 SHALL 從知識庫篩選符合條件的SOP（服務類型層級 = 當前服務類型，層級 = 任務層級，客戶 = 統一模板或當前客戶）
5. WHEN 員工篩選SOP時 THEN 系統 SHALL 先篩選服務類型，再篩選層級（服務層級或任務層級）
6. WHEN 員工配置服務任務時 THEN 系統 SHALL 允許關聯標準作業程序（SOP）

### Requirement 8: 任務模板自動套用

**User Story**: 作為會計師事務所的員工，我需要系統自動套用任務模板，以便快速建立任務配置。

#### Acceptance Criteria

1. WHEN 員工新增服務時 THEN 系統 SHALL 自動檢查是否有該服務類型的任務模板（優先使用客戶專屬模板，其次使用通用模板）
2. WHEN 系統找到任務模板時 THEN 系統 SHALL 自動套用模板並建立任務配置
3. WHEN 系統自動建立任務配置時 THEN 系統 SHALL 允許用戶修改或刪除這些任務配置
4. WHEN 系統沒有找到任務模板時 THEN 系統 SHALL 提示用戶手動配置或選擇模板

### Requirement 9: 收費計劃建立提示

**User Story**: 作為會計師事務所的員工，我需要在新增定期服務後建立收費計劃，以便管理客戶帳務。

#### Acceptance Criteria

1. WHEN 員工新增定期服務並保存後 THEN 系統 SHALL 提示「是否立即建立收費計劃？」
2. WHEN 員工選擇「是」時 THEN 系統 SHALL 跳轉到帳務設定分頁，並預選該服務
3. WHEN 員工選擇「稍後」時 THEN 系統 SHALL 在服務列表中顯示「⚠️ 尚未建立收費計劃」標記
4. WHEN 員工查看服務列表時 THEN 系統 SHALL 顯示未建立收費計劃的定期服務標記

### Requirement 10: 為已生成的定期服務新增任務

**User Story**: 作為會計師事務所的員工，我需要為已生成的定期服務新增任務，以便處理特殊情況。

#### Acceptance Criteria

1. WHEN 員工為已生成的定期服務新增任務時 THEN 系統 SHALL 允許選擇「僅當月生成」、「保存到服務設定」或「保留設定」
2. WHEN 員工選擇「僅當月生成」時 THEN 系統 SHALL 只在當前月份生成這個任務，不影響服務設定
3. WHEN 員工選擇「保存到服務設定」時 THEN 系統 SHALL 將這個任務保存到服務設定中，未來每月自動生成
4. WHEN 員工選擇「保留設定」時 THEN 系統 SHALL 保留任務設定，但不自動生成，未來可以手動加入服務設定
5. WHEN 員工查看任務配置頁面時 THEN 系統 SHALL 顯示保留設定的任務，允許手動加入服務設定

**功能需求狀態**:
- BR1.3.2.1: 查看客戶服務列表 ✅ 已實現
- BR1.3.2.2: 新增客戶服務 ✅ 已實現
- BR1.3.2.3: 編輯客戶服務 ✅ 已實現
- BR1.3.2.4: 刪除客戶服務 ✅ 已實現
- BR1.3.2.5: 查看服務任務配置數量 ✅ 已實現
- BR1.3.2.6: 進入服務任務配置詳情頁 ✅ 已實現
- BR1.3.2.7: 選擇服務類型（定期服務 / 一次性服務）⚠️ 需實現
- BR1.3.2.8: 設定服務執行頻率（勾選執行月份）⚠️ 需實現（服務層級設定，任務繼承）
- BR1.3.2.9: 設定是否用於自動生成任務 ⚠️ 需實現
- BR1.3.2.10: 執行一次性服務（一鍵完成收費計劃+任務生成）⚠️ 需實現
- BR1.3.2.11: 從服務類型下的任務類型下拉選擇任務名稱 ⚠️ 需實現（目前為手動輸入，需改為從當前服務類型下的任務類型列表下拉選擇）
- BR1.3.2.12: 套用任務模板 ✅ 已實現
- BR1.3.2.13: 設定任務階段編號 ✅ 已實現
- BR1.3.2.14: 設定任務生成時間和到期日 ⚠️ 需實現（生成時間規則、到期日規則、即時預覽、固定期限任務設置）
- BR1.3.2.15: 服務層級SOP自動綁定 ✅ 已實現（選擇服務時自動綁定）
- BR1.3.2.16: 任務相關SOP自動篩選 ✅ 已實現（根據服務類型篩選，只顯示未綁定客戶和屬於當前客戶的SOP）
- BR1.3.2.17: 服務任務配置管理 ✅ 已實現
- BR1.3.2.18: 為已生成的定期服務新增任務 ⚠️ 需實現（僅當月生成、保存到服務設定、保留設定）


**業務規則**:
- 只有管理員或客戶負責人可以新增、編輯、刪除客戶服務
- 同一客戶不能重複新增相同服務（除非之前已刪除）
- 服務必須存在且為啟用狀態才能新增
- 如果之前刪除過相同服務，新增時會自動恢復該服務記錄
- 只有管理員或客戶負責人可以創建、編輯、刪除任務配置
- 任務配置用於自動生成任務（見 BR2.4）
- **任務自動生成執行頻率**:
  - 系統每日檢查（每天 02:00 執行）
  - 檢查所有需要生成的任務
  - 如果生成時間到了，就生成任務
- **為已生成的定期服務新增任務**:
  - 在服務任務配置頁面，可以為已生成的定期服務新增任務
  - 新增任務時可以選擇：
    - 僅當月生成：只在當前月份生成這個任務，不影響服務設定
    - 保存到服務設定：將這個任務保存到服務設定中，未來每月自動生成
    - 保留設定：保留任務設定，但不自動生成，未來可以手動加入服務設定
  - 保留設定的任務可以在任務配置頁面查看，需要時可以手動加入服務設定
- **服務類型選擇**:
  - 新增服務時，服務類型從系統設置中的服務類型列表下拉選擇
  - 服務類型在系統設置中統一管理
- **服務類型（定期/一次性）**:
  - **定期服務**：有固定執行頻率的服務（例如：記帳服務每月執行、營業稅申報服務奇數月執行）
    - 必須設定執行頻率（勾選執行月份）
    - 通常用於自動生成任務（`use_for_auto_generate = 1`）
  - **一次性服務**：執行時間不固定的服務（例如：工商設立服務、公司變更服務）
    - 不需要設定執行頻率（`execution_months = NULL`）
    - 通常不用於自動生成任務（`use_for_auto_generate = 0`）
    - 需要執行時，使用「執行服務」功能，一鍵完成收費計劃建立/更新和任務生成
- **服務執行頻率設定**:
  - 執行頻率在服務層級設定（`ClientServices.execution_months`），不在任務層級設定
  - 任務的執行頻率從服務層級繼承
  - 定期服務必須設定執行頻率（至少勾選一個月份）
  - 一次性服務不需要設定執行頻率
  - 執行頻率設定方式：直接勾選執行月份（1-12 月），不需要預設選項（如奇數月、按季等）
  - 例如：記帳服務勾選 [1,2,3,4,5,6,7,8,9,10,11,12]，營業稅申報服務勾選 [1,3,5,7,9,11]
- **是否用於自動生成任務**:
  - 定期服務通常設為「是」（`use_for_auto_generate = 1`），系統會根據執行頻率自動生成任務
  - 一次性服務通常設為「否」（`use_for_auto_generate = 0`），不會自動生成任務，需要手動執行
  - 一次性客戶的服務也可以設為「否」，即使有執行頻率也不會自動生成任務
- **執行一次性服務**:
  - 在服務列表頁面，一次性服務會顯示「執行服務」按鈕
  - 點擊後彈出對話框：
    - 選擇執行月份（必填）
    - 填寫收費金額（必填）
    - 選擇服務月份（用於任務，預設為執行月份）
    - 付款期限（可選，預設使用收費計劃的付款期限）
  - 系統自動完成：
    1. 檢查該年度該服務的一次性服務收費計劃是否存在，如果不存在則建立新的收費計劃（`billing_type = 'one-time'`）
    2. 在一次性服務收費計劃中新增/更新該月份，金額為填寫的金額
    3. 關聯該服務到收費計劃（如果還沒關聯）
    4. 根據任務配置，**立即生成**該服務的所有任務（服務月份 = 選擇的服務月份）
  - 一次性服務設定完後立即生成任務，不需要等待自動生成
  - 一次性服務可以跨年度使用，每次執行時會自動建立/更新對應年度的一次性服務收費計劃
  - 一次性服務收費計劃與定期服務收費計劃完全獨立，互不影響
- **服務類型預設值自動帶入**:
  - 在 `Services` 表中新增欄位：
    - `default_service_type`（TEXT）：預設服務類型（'recurring' 或 'one-time'）
    - `default_execution_months`（TEXT，JSON 格式）：預設執行月份陣列，例如 `[1,2,3,4,5,6,7,8,9,10,11,12]`
    - `default_use_for_auto_generate`（INTEGER）：預設是否用於自動生成任務（0 或 1）
  - 新增服務時，系統自動從服務類型帶入這些預設值
  - 用戶可以修改預設值，但不需要每次都重新設定
- **任務配置自動建立（使用任務模板）**:
  - 新增服務時，系統自動檢查是否有該服務類型的任務模板（優先使用客戶專屬模板，其次使用通用模板）
  - 如果找到任務模板，系統自動套用模板並建立任務配置
  - 自動建立的任務配置包含：
    - 任務名稱、描述、階段編號：從任務模板帶入
    - 任務開始日、期限：從任務模板帶入（如果模板有設定）
    - 執行頻率：從服務層級繼承（不需要單獨設定）
    - 負責人、預估工時：從任務模板帶入（如果模板有設定）
  - 用戶可以修改自動建立的任務配置，也可以刪除不需要的任務
  - 如果沒有找到任務模板，系統提示用戶手動配置或選擇模板
- **任務配置規則**:
  - 任務名稱從服務類型下的任務類型列表下拉選擇（不是手動輸入）
  - 任務類型在系統設置中，每個服務類型下可以設置多個任務類型（ServiceItems）
  - 例如：在「記帳服務」下可以設置「收集憑證」、「掃描憑證」、「紀錄帳務」等任務類型
  - 任務模板可以在系統設置中設置，可以關聯到服務類型和客戶
  - 配置任務時可以直接套用任務模板
  - 套用模板後可以根據需要修改細節，修改不會影響原始模板
  - **任務不再需要單獨設定執行頻率**，執行頻率從服務層級繼承
- **收費計劃建立提示**:
  - 新增定期服務並保存後，系統自動提示「是否立即建立收費計劃？」
  - 如果選擇「是」，系統自動跳轉到帳務設定分頁，並預選該服務
  - 如果選擇「稍後」，系統記錄該服務尚未建立收費計劃，在服務列表中顯示提示標記
- **任務生成時間和到期日設置**:
  - 任務生成時間：設定任務何時生成（相對於服務月份）
    - 服務月份開始時（例如：1月1日生成1月的任務）
    - 服務月份前一個月的最後X天（例如：1月28日生成2月的任務，X=3）
    - 服務月份前一個月的第X天（例如：1月25日生成2月的任務，X=25）
    - 服務月份後一個月開始時（例如：2月1日生成1月的任務）
  - 任務到期日：設定任務何時到期（相對於服務月份）
    - 服務月份結束時（例如：1月31日）
    - 服務月份後一個月結束時（例如：2月29日）
    - 服務月份後N個月結束時（例如：服務月份+2個月的月底）
    - 固定日期（例如：每月15日，如果該月沒有15日則為該月最後一天）
    - 固定期限（例如：服務月份15日，用於稅務申報等固定期限任務）
  - 即時預覽：配置時顯示實際效果，例如「3月的任務在3月1日生成，到期日是3月15日」
  - 固定期限任務：可以設置為「不受前面任務延後影響」，即使前置任務延誤，到期日也不會順延
  - 前置任務延誤處理：如果前置任務延誤，後續任務的到期日會順延，但如果後續任務是固定期限，則調整為「固定期限的前一天」
- **SOP 自動綁定規則**:
  - 服務層級SOP：創建任務時自動從知識庫讀取符合條件的SOP（服務類型層級 = 當前服務類型，層級 = 服務層級，客戶 = 統一模板或當前客戶）
  - 服務層級SOP可以多選，也可以取消預設帶入的SOP
  - 如果客戶在同一個服務類型下有多個專屬服務層級SOP，系統會全部帶入，員工自行判斷是否都選擇
  - 任務層級SOP：從知識庫篩選符合條件的SOP（服務類型層級 = 當前服務類型，層級 = 任務層級，客戶 = 統一模板或當前客戶）
  - 任務層級SOP可以多選，也可以取消預設帶入的SOP
  - 篩選SOP時：先篩選服務類型，再篩選層級（服務層級或任務層級）
  - SOP不需要在設定頁面關聯，直接從知識庫讀取

## Non-Functional Requirements

### Code Architecture and Modularity
- **Single Responsibility Principle**: 每個組件文件只處理一個功能模組
- **Modular Design**: 組件之間通過 props 和 events 通信，保持獨立
- **Dependency Management**: API 調用與業務邏輯分離，使用統一的 API 工具函數
- **Clear Interfaces**: 定義清晰的組件 props 和 events 接口

### Performance
- API 響應時間 < 500ms（正常情況）
- 頁面載入時間 < 3 秒
- 資料庫查詢 < 2 秒（複雜查詢）
- 使用 KV 快取提升查詢性能（1小時 TTL）

### Security
- 只有管理員或客戶負責人可以新增、編輯、刪除客戶服務
- 只有管理員或客戶負責人可以創建、編輯、刪除任務配置
- 使用參數化查詢防止 SQL 注入
- 實現軟刪除機制保留歷史記錄

### Reliability
- 實現錯誤處理機制，確保系統穩定性
- 支援數據恢復（軟刪除）
- 保留歷史記錄供審計使用

### Usability
- 界面簡潔，操作流程直觀
- 提供即時預覽功能（任務生成時間和到期日）
- 自動帶入預設值，減少用戶操作
- 提供清晰的錯誤提示和操作指引
