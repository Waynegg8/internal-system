# BR1: 客戶管理

**業務價值**:
- 集中管理客戶資訊，提升客戶服務品質
- 追蹤客戶服務狀態，及時響應客戶需求
- 管理客戶帳務，確保財務準確性

---

#### BR1.1: 客戶列表管理

**User Story**: 作為會計師事務所的員工，我需要搜尋和篩選客戶列表，以便快速找到目標客戶，並能夠批量移轉客戶負責人。

**功能需求**:
- BR1.1.1: 客戶列表展示 ✅ 已實現
- BR1.1.2: 客戶搜尋功能 ✅ 已實現
- BR1.1.3: 客戶篩選功能 ✅ 已實現
- BR1.1.4: 客戶標籤管理 ✅ 已實現
- BR1.1.5: 批量移轉客戶負責人 ✅ 已實現
- BR1.1.6: 刪除客戶 ✅ 已實現

**驗收標準**:
- WHEN 員工查看客戶列表時 THEN 系統 SHALL 顯示以下欄位：
  - 統一編號（tax_registration_number / client_id）：統一顯示10碼格式，企業客戶顯示 `00` + 8碼統一編號，個人客戶顯示10碼身分證，等寬字體顯示，作為客戶唯一識別碼
  - 公司名稱（company_name）：可點擊連結至客戶詳情頁
  - 聯絡人（contact_person_1）：主要聯絡人姓名
  - 電話（phone）：聯絡電話
  - 負責人（assignee_user_id）：負責此客戶的員工姓名，未分配時顯示「未分配」
  - 標籤（tags）：顯示最多2個標籤，超過時顯示「+N」
  - 服務數量（services_count）：該客戶的服務項目總數，以藍色標籤顯示
  - 全年收費（year_total）：該客戶所有服務的年度收費總額，以綠色顯示
  - 操作（action）：刪除按鈕（僅管理員可見）
- WHEN 員工搜尋客戶時 THEN 系統 SHALL 支援按公司名稱、統一編號、標籤等條件快速搜尋
- WHEN 員工使用標籤篩選時 THEN 系統 SHALL 顯示符合標籤條件的客戶
- WHEN 員工查看客戶列表時 THEN 系統 SHALL 支援分頁顯示（預設每頁50筆）
- WHEN 員工選擇多個客戶並執行批量移轉時 THEN 系統 SHALL 允許批量更改客戶負責人
- WHEN 員工執行批量移轉前 THEN 系統 SHALL 支援預覽模式，顯示將要移轉的客戶列表
- WHEN 員工使用快速移轉功能時 THEN 系統 SHALL 支援按目前負責人、標籤、關鍵字等條件篩選客戶進行批量移轉
- WHEN 員工在客戶列表中刪除客戶時 THEN 系統 SHALL 執行軟刪除，保留歷史記錄

**業務規則**:
- 員工只能查看自己有權限的客戶（管理員可查看所有，一般員工只能查看自己負責或協作的客戶）
- 客戶標籤可用於分類和篩選
- 批量移轉可以選擇特定客戶、或按目前負責人篩選、或包含未分配的客戶
- 新負責人不得與目前負責人相同
- 批量移轉前可以預覽將要移轉的客戶列表
- 只有管理員可以刪除客戶
- **客戶編號（client_id）設計說明**:
  - 客戶編號（client_id）直接使用統一編號（tax_registration_number），不再有單獨的客戶編號欄位
  - 客戶編號作為主鍵（PRIMARY KEY），用於系統內部識別和關聯
  - 客戶編號作為外鍵被多個表引用：ClientServices、ClientTagAssignments、ClientCollaborators、Tasks、Timesheets、Receipts 等
  - **統一編號格式設計**（統一存儲10碼格式）:
    - **企業客戶**：
      - 輸入：8碼統一編號（例如：`12345678`）
      - 驗證規則：必須是8碼數字
      - 存儲：系統自動加前綴 `00`，存入統一編號欄位（例如：`0012345678`）
      - 統一編號欄位值直接作為客戶編號（client_id）
      - 顯示時可選擇顯示完整10碼或去掉前綴 `00` 顯示8碼
    - **個人客戶**：
      - 輸入：10碼身分證（例如：`A123456789`）
      - 驗證規則：必須是10碼（可以是字母+數字組合）
      - 存儲：直接存入統一編號欄位（例如：`A123456789`）
      - 統一編號欄位值直接作為客戶編號（client_id）
    - **優點**:
      - 統一編號欄位格式統一（都是10碼），便於資料庫存儲和查詢
      - 簡化設計：統一編號就是客戶編號，不需要額外的客戶編號欄位
      - 業務邏輯清晰：企業客戶輸入8碼自動補00，個人客戶輸入10碼直接使用
      - 減少資料冗餘：不需要同時維護客戶編號和統一編號兩個欄位
      - 企業客戶的統一編號可以通過去掉前綴 `00` 還原為原始8碼
    - **資料庫存儲說明**:
      - client_id 在資料庫中定義為 TEXT 類型（`client_id TEXT PRIMARY KEY`）
      - TEXT 類型完全支持存儲字母+數字組合（例如：`A123456789`）
      - 個人客戶第一碼是英文字母不會影響資料庫存儲或查詢性能
      - 所有使用 client_id 作為外鍵的表也都是 TEXT 類型，完全兼容
      - SQLite/D1 對 TEXT 主鍵的索引和查詢性能良好，無需擔心
    - **實施要求**:
      - 統一編號驗證：企業客戶驗證8碼數字，個人客戶驗證10碼
      - 企業客戶輸入8碼統一編號時，系統自動加前綴 `00` 存入（變成10碼）
      - 統一編號欄位統一存儲10碼格式
      - 統一編號欄位值直接作為 client_id 使用
      - 不需要資料遷移（系統為測試階段，可重新建立）
      - 不需要複雜的驗證邏輯（只需驗證長度和格式）
- **軟刪除保留的記錄**:
  - 客戶的所有基本資訊（公司名稱、統一編號、聯絡方式、備註等）
  - 客戶的所有關聯數據（服務項目、任務記錄、工時記錄、收據記錄等）
  - 客戶標籤（ClientTagAssignments）會保留（因為軟刪除不會觸發 CASCADE）
  - 客戶協作者（ClientCollaborators）會保留（因為軟刪除不會觸發 CASCADE）
  - 刪除時間（deleted_at）和刪除人（deleted_by）
  - 已刪除的客戶不會出現在客戶列表中，但數據仍保留在資料庫中
- **重新新增客戶的處理**:
  - 統一編號（tax_registration_number）直接作為客戶編號（client_id），因此統一編號必須唯一
  - 如果使用相同的統一編號重新新增，會發生主鍵衝突，無法新增
  - **處理方式**（建議實現）:
    - 新增客戶時，檢查該統一編號是否已存在（包括已刪除的）
    - 如果存在且已刪除，則恢復該客戶並更新資訊（將 `is_deleted` 設為 0，清除 `deleted_at` 和 `deleted_by`）
    - 如果不存在，則新增
    - 恢復後客戶會重新出現在列表中，所有關聯數據（標籤、協作者、服務等）都會恢復

---

#### BR1.2: 客戶新增

**User Story**: 作為會計師事務所的員工，我需要透過多步驟表單新增客戶，以便完整記錄客戶的所有資訊。

**頁面結構說明**:
- 客戶新增頁面（`/clients/add`）是一個獨立的頁面，使用 Tabs 導航的三個獨立分頁
- 路由結構：
  - `/clients/add` → 客戶新增主頁面（ClientAdd.vue），包含三個 Tabs
  - `/clients/add/basic` → 分頁1：基本資訊（ClientAddBasic.vue）
  - `/clients/add/services` → 分頁2：服務設定（ClientAddServices.vue）
  - `/clients/add/billing` → 分頁3：帳務設定（ClientAddBilling.vue）
- 每個分頁都可以獨立保存，不需要完成所有分頁才能保存

**功能需求**:
- BR1.2.1: 多步驟表單流程 ✅ 已實現
  - 分頁1：基本資訊（ClientAddBasic）
  - 分頁2：服務設定（ClientAddServices）
  - 分頁3：帳務設定（ClientAddBilling）
- BR1.2.2: 基本資訊填寫 ✅ 已實現
- BR1.2.3: 基本資訊獨立保存 ✅ 已實現
- BR1.2.4: 複製現有客戶功能 ✅ 已實現
- BR1.2.5: 服務項目設定 ✅ 已實現
- BR1.2.6: 服務設定獨立保存 ✅ 已實現
- BR1.2.7: 收費計劃設定 ✅ 已實現
- BR1.2.8: 帳務設定獨立保存 ✅ 已實現
- BR1.2.9: 客戶編號生成 ✅ 已實現

**驗收標準**:
- WHEN 員工進入新增客戶頁面時 THEN 系統 SHALL 提供選擇模式：「新增空白客戶」或「從現有客戶複製」
- WHEN 員工選擇「從現有客戶複製」時 THEN 系統 SHALL 顯示客戶選擇器（可搜尋、篩選）
- WHEN 員工選擇現有客戶時 THEN 系統 SHALL 自動帶入該客戶的所有資訊（基本資訊、服務設定、帳務設定）
- WHEN 系統複製客戶資訊時 THEN 系統 SHALL 自動清除客戶專屬資訊（如客戶 ID、統一編號），避免混淆
- WHEN 員工選擇「新增空白客戶」時 THEN 系統 SHALL 顯示三個 Tabs（基本資訊、服務設定、帳務設定）
- WHEN 員工在基本資訊分頁點擊保存時 THEN 系統 SHALL 創建客戶基本資料並允許後續分頁繼續填寫
- WHEN 員工在服務設定分頁點擊保存時 THEN 系統 SHALL 保存服務設定（客戶必須已存在）
- WHEN 員工在帳務設定分頁點擊保存時 THEN 系統 SHALL 保存帳務設定（客戶必須已存在）
- WHEN 員工完成所有分頁並點擊最終提交時 THEN 系統 SHALL 完成客戶創建並跳轉至客戶詳情頁
- WHEN 員工在任何分頁保存後 THEN 系統 SHALL 允許隨時返回該客戶繼續填寫其他分頁

**業務規則**:
- 每個分頁都可以獨立保存，不需要完成所有分頁才能保存
- 基本資訊分頁保存後，客戶即被創建（但服務和帳務資訊可能尚未完成）
- 服務設定和帳務設定分頁保存時，客戶必須已存在（已保存基本資訊）
- 員工可以分多次完成客戶新增流程，每次保存後可以離開，之後再回來繼續填寫
- 統一編號（tax_registration_number）直接作為客戶編號（client_id），必須唯一（主鍵）
- 統一編號欄位統一存儲10碼格式
- 企業客戶：輸入8碼統一編號，系統自動加前綴 `00` 存入（變成10碼）
- 個人客戶：輸入10碼身分證，直接存入統一編號欄位
- 如果使用相同的統一編號重新新增，系統應檢查是否已存在（包括已刪除的），如果存在且已刪除則恢復該客戶
- **複製現有客戶功能**:
  - 進入客戶新增頁面時，系統提供選擇模式：「新增空白客戶」或「從現有客戶複製」
  - 選擇「從現有客戶複製」時，系統顯示客戶選擇器（可搜尋、篩選）
  - 選擇客戶後，系統自動帶入該客戶的所有資訊：
    - 基本資訊：複製所有欄位（公司名稱、統一編號等需要手動修改）
    - 服務設定：複製所有服務及其配置（包括服務類型、執行頻率、任務配置等）
    - 帳務設定：複製所有收費計劃（包括年度、月份、金額、關聯服務等）
  - 系統自動清除客戶專屬資訊（如客戶 ID、統一編號等），避免混淆
  - 用戶只需要修改不同的部分（如公司名稱、統一編號、收費金額等）
  - 保存複製的客戶時，創建新客戶，不影響原始客戶

---

#### BR1.2.1: 客戶新增 - 基本資訊分頁

**User Story**: 作為會計師事務所的員工，我需要在新增客戶時填寫基本資訊，以便建立客戶的基本資料。

**頁面結構說明**:
- 客戶新增基本資訊分頁是客戶新增頁面（ClientAdd）的一個獨立分頁（Tab）
- 路由：`/clients/add/basic` → 基本資訊分頁（ClientAddBasic.vue）

**功能需求**:
- BR1.2.1.1: 填寫客戶基本資料 ✅ 已實現
- BR1.2.1.2: 客戶編號生成 ✅ 已實現
- BR1.2.1.3: 統一編號自動同步 ✅ 已實現
- BR1.2.1.4: 獨立保存基本資訊 ✅ 已實現

**驗收標準**:
- WHEN 員工在新增客戶基本資訊分頁時 THEN 系統 SHALL 允許填寫客戶基本資料
- WHEN 員工填寫統一編號時 THEN 系統 SHALL 自動同步到客戶編號欄位（企業客戶）
- WHEN 員工點擊「產生個人客戶編號」時 THEN 系統 SHALL 自動生成個人客戶編號（智能避開合法統編）
- WHEN 員工在基本資訊分頁點擊保存時 THEN 系統 SHALL 創建客戶基本資料，客戶即被創建
- WHEN 員工保存基本資訊後 THEN 系統 SHALL 允許切換到其他分頁（服務設定、帳務設定）繼續填寫
- WHEN 員工保存基本資訊後 THEN 系統 SHALL 允許離開頁面，之後可以從客戶列表進入該客戶繼續填寫其他分頁
- WHEN 員工填寫基本資訊時 THEN 系統 SHALL 允許填寫以下欄位：
  - 公司名稱（company_name）：必填
  - 統一編號（tax_registration_number）：企業客戶8碼，個人客戶10碼
  - 公司負責人（company_owner）：可選
  - 公司地址（company_address）：可選
  - 資本額（capital_amount）：可選
  - 股東持股資訊（shareholders）：可選
  - 董監事資訊（directors_supervisors）：可選
  - 聯絡人（contact_person_1, contact_person_2）：可選
  - 負責人員（assignee_user_id）：必填
  - 主要聯絡方式（primary_contact_method）：可選
  - 聯絡電話（phone）：可選
  - Email（email）：可選
  - LINE ID（line_id）：可選
  - 客戶備註（client_notes）：可選
  - 收款備註（payment_notes）：可選

**業務規則**:
- 公司名稱（company_name）為必填欄位
- 負責人員（assignee_user_id）為必填欄位
- 統一編號（tax_registration_number）直接作為客戶編號（client_id），必須唯一（主鍵）
- 統一編號欄位統一存儲10碼格式
- 企業客戶：輸入8碼統一編號，系統自動加前綴 `00` 存入（變成10碼）
- 個人客戶：輸入10碼身分證，直接存入統一編號欄位
- 公司負責人（company_owner）：可選，記錄客戶公司的負責人姓名（與事務所內部負責人員不同）
- 公司地址（company_address）：可選，記錄客戶公司的地址
- 資本額（capital_amount）：可選，記錄公司資本額（數字，單位：新台幣元）
- 股東持股資訊（shareholders）：可選，記錄股東姓名及持股資訊（可記錄多筆，使用關聯表：標準化）
  - 股東姓名
  - 持股比例（%）
  - 持股數（股數）
  - 持股金額（新台幣元）
  - 持股類型（普通股、特別股等）
- 董監事資訊（directors_supervisors）：可選，記錄董事、監事姓名及任期（可記錄多筆，使用關聯表：標準化）
  - 資料庫：`DirectorsSupervisors`（關聯 `client_id`）
  - 欄位：`name`、`position`、`term_start`、`term_end`、`is_current`
  - 查詢需求：支援依 `is_current`、`position` 篩選與排序

---

#### BR1.3.1 資料庫設計變更（規格更新）

為支援查詢、統計與一致性，股東與董監事資訊改採「關聯表」存放（取代 JSON 欄位落地），規格要求如下：

- 使用關聯表（標準化）：
  - Shareholders
    - 主鍵：`id`（自增）
    - 關聯：`client_id` → `Clients.client_id`
    - 欄位：`name`（必填）、`share_percentage`（%）、`share_count`（股數）、`share_amount`（金額）、`share_type`
    - 索引：`client_id`、`(client_id, name)`、`(client_id, share_percentage)`
  - DirectorsSupervisors
    - 主鍵：`id`（自增）
    - 關聯：`client_id` → `Clients.client_id`
    - 欄位：`name`（必填）、`position`、`term_start`、`term_end`、`is_current`
    - 索引：`client_id`、`(client_id, is_current)`、`(client_id, position)`
- 後端 API 規範：
  - Client Detail 讀取：優先從關聯表聚合回傳前端；若關聯表無資料，保留解析舊 JSON 欄位的相容路徑（過渡期）。
  - Client Update/Save：寫入時覆蓋關聯表（先刪後插），不再寫回 JSON 欄位（JSON 欄位保留但不再使用）。
- 遷移：
  - 迁移檔：`0038_add_shareholders_and_directors_tables.sql`
  - 說明：建立 `Shareholders`、`DirectorsSupervisors` 與索引；舊 JSON 欄位保留相容，後續可提供一次性資料轉移工具。
  - 姓名
  - 職務（董事、監事、董事長等）
  - 任期開始日期
  - 任期結束日期
  - 是否為現任
- 主要聯絡方式（primary_contact_method）：可選，標記客戶的主要聯絡方式類型（選項：LINE、電話、Email、其他）
- LINE ID（line_id）：可選，記錄客戶的 LINE ID

---

#### BR1.2.2: 客戶新增 - 服務設定分頁

**User Story**: 作為會計師事務所的員工，我需要在新增客戶時設定服務項目和任務配置，以便追蹤服務狀態並自動生成任務。

**頁面結構說明**:
- 客戶新增服務設定分頁是客戶新增頁面（ClientAdd）的一個獨立分頁（Tab）
- 路由：`/clients/add/services` → 服務設定分頁（ClientAddServices.vue）

**功能需求**:
- BR1.2.2.1: 新增客戶服務 ✅ 已實現
- BR1.2.2.2: 編輯客戶服務 ✅ 已實現
- BR1.2.2.3: 刪除客戶服務 ✅ 已實現
- BR1.2.2.4: 選擇服務類型（定期服務 / 一次性服務）✅ 已實現
- BR1.2.2.5: 服務類型預設值自動帶入 ✅ 已實現
- BR1.2.2.6: 設定服務執行頻率（勾選執行月份）✅ 已實現
- BR1.2.2.7: 設定是否用於自動生成任務 ✅ 已實現
- BR1.2.2.8: 執行一次性服務（一鍵完成收費計劃+任務生成）⚠️ 需實現（應在客戶詳情頁面的服務列表中實現，不在新增流程中）
- BR1.2.2.9: 任務配置自動建立（使用任務模板）✅ 已實現
- BR1.2.2.10: 服務任務配置管理 ✅ 已實現
- BR1.2.2.11: 收費計劃建立提示 ✅ 已實現
- BR1.2.2.12: 獨立保存服務設定 ✅ 已實現

**驗收標準**:
- WHEN 員工在新增客戶服務設定分頁時 THEN 系統 SHALL 允許選擇和設定客戶服務項目
- WHEN 員工新增服務時 THEN 系統 SHALL 驗證服務必須存在且為啟用狀態
- WHEN 員工新增服務時 THEN 系統 SHALL 允許選擇服務類型（定期服務 / 一次性服務）
- WHEN 員工新增定期服務時 THEN 系統 SHALL 要求設定執行頻率（勾選執行月份）
- WHEN 員工新增一次性服務時 THEN 系統 SHALL 不要求設定執行頻率（執行月份為空）
- WHEN 員工設定服務執行頻率時 THEN 系統 SHALL 允許直接勾選執行月份（1-12 月），不需要預設選項
- WHEN 員工設定服務執行頻率時 THEN 系統 SHALL 驗證定期服務必須至少勾選一個月份
- WHEN 員工設定服務時 THEN 系統 SHALL 允許選擇是否用於自動生成任務
- WHEN 員工點擊「執行服務」按鈕（一次性服務）時 THEN 系統 SHALL 彈出對話框，允許選擇執行月份、填寫收費金額，並自動完成收費計劃建立/更新和任務生成
- WHEN 員工配置服務任務時 THEN 系統 SHALL 允許設定任務模板、任務開始日、期限等（任務執行頻率從服務層級繼承）
- WHEN 員工配置服務任務時 THEN 系統 SHALL 允許關聯標準作業程序（SOP）
- WHEN 員工配置服務任務時 THEN 系統 SHALL 支援批量保存任務配置
- WHEN 員工在服務設定分頁點擊保存時 THEN 系統 SHALL 保存服務設定（客戶必須已存在，即已保存基本資訊）
- WHEN 員工保存服務設定後 THEN 系統 SHALL 允許切換到其他分頁（基本資訊、帳務設定）繼續填寫
- WHEN 員工未保存基本資訊就進入服務設定分頁時 THEN 系統 SHALL 提示先保存基本資訊

**業務規則**:
- 同一客戶不能重複新增相同服務（除非之前已刪除）
- 服務必須存在且為啟用狀態才能新增
- 任務配置用於自動生成任務（見 BR2.4）
- **服務類型（定期/一次性）**（見 BR1.3.2）:
  - **定期服務**：有固定執行頻率的服務（例如：記帳服務每月執行、營業稅申報服務奇數月執行）
    - 必須設定執行頻率（勾選執行月份）
    - 通常用於自動生成任務（`use_for_auto_generate = 1`）
  - **一次性服務**：執行時間不固定的服務（例如：工商設立服務、公司變更服務）
    - 不需要設定執行頻率（`execution_months = NULL`）
    - 通常不用於自動生成任務（`use_for_auto_generate = 0`）
    - 需要執行時，使用「執行服務」功能，一鍵完成收費計劃建立/更新和任務生成
- **服務執行頻率設定**（見 BR1.3.2）:
  - 執行頻率在服務層級設定（`ClientServices.execution_months`），不在任務層級設定
  - 任務的執行頻率從服務層級繼承
  - 定期服務必須設定執行頻率（至少勾選一個月份）
  - 一次性服務不需要設定執行頻率
  - 執行頻率設定方式：直接勾選執行月份（1-12 月），不需要預設選項（如奇數月、按季等）
- **是否用於自動生成任務**（見 BR1.3.2）:
  - 定期服務通常設為「是」（`use_for_auto_generate = 1`），系統會根據執行頻率自動生成任務
  - 一次性服務通常設為「否」（`use_for_auto_generate = 0`），不會自動生成任務，需要手動執行
- **執行一次性服務**（見 BR1.3.2）:
  - 在服務列表頁面，一次性服務會顯示「執行服務」按鈕
  - 點擊後彈出對話框：
    - 選擇執行月份（必填）
    - 填寫收費金額（必填）
    - 選擇服務月份（用於任務，預設為執行月份）
    - 付款期限（可選，預設使用收費計劃的付款期限）
  - 系統自動完成：
    1. 檢查該年度該服務的一次性服務收費計劃是否存在，如果不存在則建立新的收費計劃（`billing_type = 'one-time'`）
    2. 在一次性服務收費計劃中新增/更新該月份，金額為填寫的金額
    3. 關聯該服務到收費計劃（如果還沒關聯）
    4. 根據任務配置，自動生成該服務的所有任務（服務月份 = 選擇的服務月份）
  - 一次性服務收費計劃與定期服務收費計劃完全獨立，互不影響
- **服務類型預設值自動帶入**:
  - 在 `Services` 表中新增欄位：
    - `default_service_type`（TEXT）：預設服務類型（'recurring' 或 'one-time'）
    - `default_execution_months`（TEXT，JSON 格式）：預設執行月份陣列，例如 `[1,2,3,4,5,6,7,8,9,10,11,12]`
    - `default_use_for_auto_generate`（INTEGER）：預設是否用於自動生成任務（0 或 1）
  - 新增服務時，系統自動從服務類型帶入這些預設值
  - 用戶可以修改預設值，但不需要每次都重新設定
- **任務配置自動建立（使用任務模板）**:
  - 新增服務時，系統自動檢查是否有該服務類型的任務模板（優先使用客戶專屬模板，其次使用通用模板）
  - 如果找到任務模板，系統自動套用模板並建立任務配置
  - 自動建立的任務配置包含：
    - 任務名稱、描述、階段編號：從任務模板帶入
    - 任務開始日、期限：從任務模板帶入（如果模板有設定）
    - 執行頻率：從服務層級繼承（不需要單獨設定）
    - 負責人、預估工時：從任務模板帶入（如果模板有設定）
  - 用戶可以修改自動建立的任務配置，也可以刪除不需要的任務
  - 如果沒有找到任務模板，系統提示用戶手動配置或選擇模板
- **任務配置規則**（見 BR1.3.2）:
  - 任務名稱從服務類型下的任務類型列表下拉選擇（不是手動輸入）
  - 任務類型在系統設置中，每個服務類型下可以設置多個任務類型（ServiceItems）
  - 任務模板可以在系統設置中設置，可以關聯到服務類型和客戶
  - 配置任務時可以直接套用任務模板
  - 套用模板後可以根據需要修改細節，修改不會影響原始模板
  - **任務不再需要單獨設定執行頻率**，執行頻率從服務層級繼承
- **收費計劃建立提示**:
  - 新增定期服務並保存後，系統自動提示「是否立即建立收費計劃？」
  - 如果選擇「是」，系統自動跳轉到帳務設定分頁，並預選該服務
  - 如果選擇「稍後」，系統記錄該服務尚未建立收費計劃，在服務列表中顯示提示標記

---

#### BR1.2.3: 客戶新增 - 帳務設定分頁

**User Story**: 作為會計師事務所的員工，我需要在新增客戶時設定帳務資訊和收費計劃，以便確保財務記錄準確。

**頁面結構說明**:
- 客戶新增帳務設定分頁是客戶新增頁面（ClientAdd）的一個獨立分頁（Tab）
- 路由：`/clients/add/billing` → 帳務設定分頁（ClientAddBilling.vue）

**功能需求**:
- BR1.2.3.1: 設定付款方式 ✅ 已實現
- BR1.2.3.2: 新增收費計劃（選擇年度、勾選月份、填寫金額、關聯服務）✅ 已實現
- BR1.2.3.3: 編輯收費計劃（修改月份金額、關聯服務）✅ 已實現
- BR1.2.3.4: 刪除收費計劃 ✅ 已實現
- BR1.2.3.5: 批量刪除收費記錄 ✅ 已實現
- BR1.2.3.6: 關聯多個服務到收費計劃 ✅ 已實現
- BR1.2.3.7: 為每個勾選的月份填寫不同金額 ✅ 已實現
- BR1.2.3.8: 獨立保存帳務設定 ✅ 已實現

**驗收標準**:
- WHEN 員工在新增客戶帳務設定分頁時 THEN 系統 SHALL 允許設定收費計劃
- WHEN 員工查看收費計劃時 THEN 系統 SHALL 分別顯示定期服務收費計劃和一次性服務收費計劃（可以切換查看或合併顯示）
- WHEN 員工新增定期服務收費計劃時 THEN 系統 SHALL 要求選擇年度
- WHEN 員工新增定期服務收費計劃時 THEN 系統 SHALL 允許直接勾選要收費的月份（1-12 月）
- WHEN 員工勾選月份時 THEN 系統 SHALL 為每個勾選的月份顯示金額輸入欄位
- WHEN 員工填寫月份金額時 THEN 系統 SHALL 允許為每個月份填寫不同的金額
- WHEN 員工新增定期服務收費計劃時 THEN 系統 SHALL 允許從該客戶的服務列表中選擇多個**定期服務**進行關聯
- WHEN 員工關聯服務時 THEN 系統 SHALL 只顯示該客戶已建立的**定期服務**（從 ClientServices 表中讀取，service_type = 'recurring'）
- WHEN 員工編輯收費計劃時 THEN 系統 SHALL 允許修改月份金額、新增/刪除月份、新增/刪除關聯服務
- WHEN 員工刪除收費計劃時 THEN 系統 SHALL 支援單筆刪除和批量刪除
- WHEN 員工在帳務設定分頁點擊保存時 THEN 系統 SHALL 保存帳務設定（客戶必須已存在，即已保存基本資訊）
- WHEN 員工保存帳務設定後 THEN 系統 SHALL 允許切換到其他分頁（基本資訊、服務設定）繼續填寫
- WHEN 員工未保存基本資訊就進入帳務設定分頁時 THEN 系統 SHALL 提示先保存基本資訊

**業務規則**:
- 帳務資訊與客戶基本資訊關聯
- 收費計劃按年度管理，每個年度有獨立的收費計劃
- **收費計劃類型**（見 BR1.3.3）:
  - **定期服務收費計劃**（`billing_type = 'recurring'`）：用於定期服務的收費計劃
  - **一次性服務收費計劃**（`billing_type = 'one-time'`）：用於一次性服務的收費計劃
- 定期服務收費計劃必須關聯到客戶的定期服務項目（從 ClientServices 表中選擇，service_type = 'recurring'）
- **定期服務收費計劃的建立方式**（見 BR1.3.3）:
  - 直接勾選要收費的月份（1-12 月）
  - 為每個勾選的月份填寫金額（可以不同）
  - 關聯多個定期服務到收費計劃
- **一次性服務收費計劃的建立方式**（見 BR1.3.3）:
  - 通過「執行服務」功能自動建立/更新
  - 每個一次性服務有獨立的收費計劃
- 付款期限（payment_due_days）：收費日期後多少天內需付款，例如 30 天
  - 可以在收費計劃層級設定預設付款期限
  - 也可以在每個月份明細中設定特定的付款期限（可選，預設使用計劃的付款期限）
- 收費計劃可以按服務項目篩選查看
- **收入分攤規則**（見 BR1.3.3）:
  - **定期服務**：多個定期服務的收費混合在一起，按執行次數比例分攤
    - 計算定期服務總收費 = Σ(定期服務收費計劃中所有月份的金額)
    - 計算每個定期服務的執行次數 = execution_months 陣列的長度
    - 計算總執行次數 = Σ(所有關聯定期服務的執行次數)
    - 每個定期服務全年的分攤收入 = 定期服務總收費 × (該服務的執行次數 / 總執行次數)
    - 每個定期服務每個月的應計收入 = 該服務全年的分攤收入 ÷ 該服務的執行次數（如果該月在 execution_months 中，否則為 0）
  - **一次性服務**：每個一次性服務的收費獨立，直接使用實際金額，不分攤
    - 每個一次性服務有獨立的收費計劃（一次性服務收費計劃）
    - 每個一次性服務的應計收入 = 該服務的收費計劃中所有月份的金額總和
    - 每個一次性服務每個月的應計收入 = 該月份的金額（如果該月在收費計劃中，否則為 0）
  - 定期服務和一次性服務之間不互相影響
  - 應計收入按年度計算，跨年度不混亂

---

#### BR1.3: 客戶詳情頁

**User Story**: 作為會計師事務所的員工，我需要查看和編輯客戶的完整資訊，包括基本資訊、服務項目和帳務資訊。

**頁面結構說明**:
- 客戶詳情頁（`/clients/:id`）是一個獨立的頁面，使用 Tabs 導航的三個獨立分頁
- 路由結構：
  - `/clients/:id` → 客戶詳情主頁面（ClientDetail.vue），包含三個 Tabs
  - `/clients/:id` → 分頁1：基本資訊（ClientBasicInfo.vue）
  - `/clients/:id/services` → 分頁2：服務項目（ClientServices.vue）
  - `/clients/:id/billing` → 分頁3：收費設定（ClientBilling.vue）
- 三個分頁都是獨立的，可以分別查看和編輯

**功能需求**:
- BR1.3.0: 客戶詳情頁導航 ✅ 已實現
  - 分頁1：基本資訊（ClientBasicInfo）- 見 BR1.3.1
  - 分頁2：服務項目（ClientServices）- 見 BR1.3.2
  - 分頁3：收費設定（ClientBilling）- 見 BR1.3.3

---

#### BR1.3.1: 客戶詳情頁 - 基本資訊分頁

**User Story**: 作為會計師事務所的員工，我需要編輯和查看客戶基本資訊，以便維護客戶資料。

**頁面結構說明**:
- 客戶基本資訊管理是客戶詳情頁（ClientDetail）的一個獨立分頁（Tab）
- 路由：`/clients/:id` → 基本資訊分頁（ClientBasicInfo.vue）

**功能需求**:
- BR1.3.1.1: 編輯客戶資訊 ✅ 已實現
- BR1.3.1.2: 查看客戶詳情 ✅ 已實現
- BR1.3.1.3: 刪除客戶 ✅ 已實現
- BR1.3.1.4: 客戶標籤管理 ✅ 已實現
- BR1.3.1.5: 客戶協作者管理 ✅ 已實現
- BR1.3.1.6: 編輯公司負責人欄位 ✅ 已實現
- BR1.3.1.7: 編輯公司地址欄位 ✅ 已實現
- BR1.3.1.8: 編輯資本額欄位 ✅ 已實現
- BR1.3.1.9: 編輯股東持股資訊 ✅ 已實現
- BR1.3.1.10: 編輯董監事資訊 ✅ 已實現
- BR1.3.1.11: 編輯主要聯絡方式 ✅ 已實現
- BR1.3.1.12: 編輯 LINE ID ✅ 已實現

**驗收標準**:
- WHEN 員工編輯客戶資訊時 THEN 系統 SHALL 允許修改除統一編號外的所有欄位
- WHEN 員工編輯客戶資訊時 THEN 系統 SHALL 更新客戶資料並記錄修改時間（updated_at）
- WHEN 員工查看客戶詳情時 THEN 系統 SHALL 顯示客戶的所有相關資訊（基本資訊、服務項目、帳務資訊、任務記錄等）
- WHEN 員工刪除客戶時 THEN 系統 SHALL 執行軟刪除，保留歷史記錄
- WHEN 員工管理客戶標籤時 THEN 系統 SHALL 允許新增、移除標籤
- WHEN 員工管理客戶協作者時 THEN 系統 SHALL 允許新增、移除協作者（僅管理員或客戶負責人可見）
- WHEN 員工查看客戶基本資訊時 THEN 系統 SHALL 顯示統一編號欄位（只讀，不可修改）
- WHEN 員工編輯客戶資訊時 THEN 系統 SHALL 允許修改以下欄位：
  - 公司名稱（company_name）：必填
  - 公司負責人（company_owner）：可選
  - 公司地址（company_address）：可選
  - 資本額（capital_amount）：可選
  - 股東持股資訊（shareholders）：可選
  - 董監事資訊（directors_supervisors）：可選
  - 聯絡人（contact_person_1, contact_person_2）：可選
  - 負責人員（assignee_user_id）：必填
  - 主要聯絡方式（primary_contact_method）：可選
  - 聯絡電話（phone）：可選
  - Email（email）：可選
  - LINE ID（line_id）：可選
  - 客戶備註（client_notes）：可選
  - 收款備註（payment_notes）：可選
  - 標籤（tags）：可選

**業務規則**:
- 統一編號（tax_registration_number）作為客戶編號（client_id），一旦建立不可修改（只讀）
- 公司名稱（company_name）為必填欄位
- 負責人員（assignee_user_id）為必填欄位
- 刪除客戶時，相關的服務、任務等數據會保留（軟刪除）
- 只有管理員或客戶負責人可以管理客戶協作者
- 公司負責人（company_owner）：可選，記錄客戶公司的負責人姓名（與事務所內部負責人員不同）
- 公司地址（company_address）：可選，記錄客戶公司的地址
- 資本額（capital_amount）：可選，記錄公司資本額（數字，單位：新台幣元）
- 股東持股資訊（shareholders）：可選，記錄股東姓名及持股資訊（可記錄多筆，建議使用 JSON 格式或關聯表）
  - 股東姓名
  - 持股比例（%）
  - 持股數（股數）
  - 持股金額（新台幣元）
  - 持股類型（普通股、特別股等）
- 董監事資訊（directors_supervisors）：可選，記錄董事、監事姓名及任期（可記錄多筆，建議使用 JSON 格式或關聯表）
  - 姓名
  - 職務（董事、監事、董事長等）
  - 任期開始日期
  - 任期結束日期
  - 是否為現任
- 主要聯絡方式（primary_contact_method）：可選，標記客戶的主要聯絡方式類型（選項：LINE、電話、Email、其他）
- LINE ID（line_id）：可選，記錄客戶的 LINE ID
- **資料庫欄位狀態**（需新增的欄位）:
  - `company_owner`（公司負責人）：TEXT，可選
  - `company_address`（公司地址）：TEXT，可選
  - `capital_amount`（資本額）：REAL 或 INTEGER，可選，單位：新台幣元
  - `shareholders`（股東持股資訊）：TEXT（JSON 格式）或關聯表，可選
  - `directors_supervisors`（董監事資訊）：TEXT（JSON 格式）或關聯表，可選
  - `contact_person_1`（聯絡人1）：TEXT，可選（目前前端有顯示，但資料庫可能未存儲，需確認）
  - `contact_person_2`（聯絡人2）：TEXT，可選（目前前端有顯示，但資料庫可能未存儲，需確認）
  - `primary_contact_method`（主要聯絡方式）：TEXT，可選，選項值：'line'、'phone'、'email'、'other'
  - `line_id`（LINE ID）：TEXT，可選

---

#### BR1.3.2: 客戶詳情頁 - 服務項目分頁

**User Story**: 作為會計師事務所的員工，我需要管理客戶的服務項目和任務配置，以便追蹤服務狀態並自動生成任務。

**頁面結構說明**:
- 客戶服務項目管理是客戶詳情頁（ClientDetail）的一個獨立分頁（Tab）
- 路由：`/clients/:id/services` → 服務分頁（ClientServices.vue）
- 服務任務配置詳情頁：`/clients/:clientId/services/:clientServiceId/config` → 服務配置頁（ClientServiceConfig.vue）
- 包含服務列表、新增/編輯服務、刪除服務、任務配置等功能

**功能需求**:
- BR1.3.2.1: 查看客戶服務列表 ✅ 已實現
- BR1.3.2.2: 新增客戶服務 ✅ 已實現
- BR1.3.2.3: 編輯客戶服務 ✅ 已實現
- BR1.3.2.4: 刪除客戶服務 ✅ 已實現
- BR1.3.2.5: 查看服務任務配置數量 ✅ 已實現
- BR1.3.2.6: 進入服務任務配置詳情頁 ✅ 已實現
- BR1.3.2.7: 選擇服務類型（定期服務 / 一次性服務）⚠️ 需實現
- BR1.3.2.8: 設定服務執行頻率（勾選執行月份）⚠️ 需實現（服務層級設定，任務繼承）
- BR1.3.2.9: 設定是否用於自動生成任務 ⚠️ 需實現
- BR1.3.2.10: 執行一次性服務（一鍵完成收費計劃+任務生成）⚠️ 需實現
- BR1.3.2.11: 從服務類型下的任務類型下拉選擇任務名稱 ⚠️ 需實現（目前為手動輸入，需改為從當前服務類型下的任務類型列表下拉選擇）
- BR1.3.2.12: 套用任務模板 ✅ 已實現
- BR1.3.2.13: 設定任務階段編號 ✅ 已實現
- BR1.3.2.14: 設定任務開始日和期限 ⚠️ 需簡化（目前期限規則過於複雜，需改為：任務開始日 + 期限天數）
- BR1.3.2.15: 服務層級SOP自動綁定 ✅ 已實現（選擇服務時自動綁定）
- BR1.3.2.16: 任務相關SOP自動篩選 ✅ 已實現（根據服務類型篩選，只顯示未綁定客戶和屬於當前客戶的SOP）
- BR1.3.2.17: 服務任務配置管理 ✅ 已實現

**驗收標準**:
- WHEN 員工查看客戶服務列表時 THEN 系統 SHALL 顯示服務名稱、狀態、年度總額、任務配置數量、服務類型、執行次數等資訊
- WHEN 員工為客戶新增服務項目時 THEN 系統 SHALL 驗證服務是否已存在，避免重複新增
- WHEN 員工新增服務時 THEN 系統 SHALL 從系統設置的服務類型列表下拉選擇服務類型
- WHEN 員工新增服務時 THEN 系統 SHALL 驗證服務必須存在且為啟用狀態
- WHEN 員工新增服務時 THEN 系統 SHALL 允許選擇服務類型（定期服務 / 一次性服務）
- WHEN 員工新增服務時 THEN 系統 SHALL 自動從服務類型帶入預設執行頻率、服務類型、是否用於自動生成任務（從 Services 表的 default_service_type、default_execution_months、default_use_for_auto_generate）
- WHEN 系統帶入預設值時 THEN 系統 SHALL 允許用戶修改這些預設值
- WHEN 服務類型沒有設定預設值時 THEN 系統 SHALL 要求用戶手動設定
- WHEN 員工新增定期服務時 THEN 系統 SHALL 要求設定執行頻率（勾選執行月份）
- WHEN 員工新增一次性服務時 THEN 系統 SHALL 不要求設定執行頻率（執行月份為空）
- WHEN 員工設定服務執行頻率時 THEN 系統 SHALL 允許直接勾選執行月份（1-12 月），不需要預設選項
- WHEN 員工設定服務執行頻率時 THEN 系統 SHALL 驗證定期服務必須至少勾選一個月份
- WHEN 員工設定服務時 THEN 系統 SHALL 允許選擇是否用於自動生成任務
- WHEN 員工新增服務時 THEN 系統 SHALL 允許設定服務狀態（使用中、暫停、已到期、已取消）和開始日期
- WHEN 員工編輯服務配置時 THEN 系統 SHALL 允許修改服務狀態、開始日期、執行頻率、是否用於自動生成任務等
- WHEN 員工刪除服務時 THEN 系統 SHALL 執行軟刪除，保留歷史記錄
- WHEN 員工點擊「配置任務」時 THEN 系統 SHALL 跳轉至服務任務配置詳情頁
- WHEN 員工點擊「執行服務」按鈕（一次性服務）時 THEN 系統 SHALL 彈出對話框，允許選擇執行月份、填寫收費金額，並自動完成收費計劃建立/更新和任務生成
- WHEN 員工新增服務時 THEN 系統 SHALL 自動檢查是否有該服務類型的任務模板（優先使用客戶專屬模板，其次使用通用模板）
- WHEN 系統找到任務模板時 THEN 系統 SHALL 自動套用模板並建立任務配置
- WHEN 系統自動建立任務配置時 THEN 系統 SHALL 允許用戶修改或刪除這些任務配置
- WHEN 系統沒有找到任務模板時 THEN 系統 SHALL 提示用戶手動配置或選擇模板
- WHEN 員工新增定期服務並保存後 THEN 系統 SHALL 提示「是否立即建立收費計劃？」
- WHEN 員工選擇「是」時 THEN 系統 SHALL 跳轉到帳務設定分頁，並預選該服務
- WHEN 員工選擇「稍後」時 THEN 系統 SHALL 在服務列表中顯示「⚠️ 尚未建立收費計劃」標記
- WHEN 員工查看服務列表時 THEN 系統 SHALL 顯示未建立收費計劃的定期服務標記
- WHEN 員工在服務任務配置詳情頁時 THEN 系統 SHALL 允許從當前服務類型下的任務類型列表下拉選擇任務名稱、設定階段編號、負責人、預估工時、任務開始日、期限等
- WHEN 員工配置任務時 THEN 系統 SHALL 允許從系統設置的任務模板中選擇並套用模板
- WHEN 員工套用任務模板後 THEN 系統 SHALL 允許修改任務細節，且修改不會影響原始模板
- WHEN 員工選擇服務時 THEN 系統 SHALL 根據服務類型中設置的綁定SOP自動綁定服務層級SOP
- WHEN 員工選擇任務相關SOP時 THEN 系統 SHALL 只顯示任務層級的SOP（scope = 'task'）
- WHEN 員工選擇任務相關SOP時 THEN 系統 SHALL 只顯示未綁定客戶的任務層級SOP和屬於當前客戶的任務層級SOP
- WHEN 員工選擇任務相關SOP時 THEN 系統 SHALL 根據服務類型自動篩選可選的SOP
- WHEN 員工選擇任務相關SOP時 THEN 系統 SHALL 不顯示服務層級的SOP或其他客戶的SOP
- WHEN 員工配置任務階段時 THEN 系統 SHALL 允許設定階段編號（從 1 開始），多個任務可以使用相同階段編號實現同步進行
- WHEN 員工設定任務開始日時 THEN 系統 SHALL 允許輸入日期（1-31 日），例如設定為 15 日
- WHEN 員工設定期限時 THEN 系統 SHALL 允許輸入天數（例如 60 天），任務到期日為任務開始日加上期限天數
- WHEN 員工配置服務任務時 THEN 系統 SHALL 允許關聯標準作業程序（SOP）
- WHEN 員工配置服務任務時 THEN 系統 SHALL 支援批量保存任務配置
- WHEN 員工保存任務配置時 THEN 系統 SHALL 返回服務列表頁面

**業務規則**:
- 只有管理員或客戶負責人可以新增、編輯、刪除客戶服務
- 同一客戶不能重複新增相同服務（除非之前已刪除）
- 服務必須存在且為啟用狀態才能新增
- 如果之前刪除過相同服務，新增時會自動恢復該服務記錄
- 只有管理員或客戶負責人可以創建、編輯、刪除任務配置
- 任務配置用於自動生成任務（見 BR2.4）
- **服務類型選擇**:
  - 新增服務時，服務類型從系統設置中的服務類型列表下拉選擇
  - 服務類型在系統設置中統一管理
- **服務類型（定期/一次性）**:
  - **定期服務**：有固定執行頻率的服務（例如：記帳服務每月執行、營業稅申報服務奇數月執行）
    - 必須設定執行頻率（勾選執行月份）
    - 通常用於自動生成任務（`use_for_auto_generate = 1`）
  - **一次性服務**：執行時間不固定的服務（例如：工商設立服務、公司變更服務）
    - 不需要設定執行頻率（`execution_months = NULL`）
    - 通常不用於自動生成任務（`use_for_auto_generate = 0`）
    - 需要執行時，使用「執行服務」功能，一鍵完成收費計劃建立/更新和任務生成
- **服務執行頻率設定**:
  - 執行頻率在服務層級設定（`ClientServices.execution_months`），不在任務層級設定
  - 任務的執行頻率從服務層級繼承
  - 定期服務必須設定執行頻率（至少勾選一個月份）
  - 一次性服務不需要設定執行頻率
  - 執行頻率設定方式：直接勾選執行月份（1-12 月），不需要預設選項（如奇數月、按季等）
  - 例如：記帳服務勾選 [1,2,3,4,5,6,7,8,9,10,11,12]，營業稅申報服務勾選 [1,3,5,7,9,11]
- **是否用於自動生成任務**:
  - 定期服務通常設為「是」（`use_for_auto_generate = 1`），系統會根據執行頻率自動生成任務
  - 一次性服務通常設為「否」（`use_for_auto_generate = 0`），不會自動生成任務，需要手動執行
  - 一次性客戶的服務也可以設為「否」，即使有執行頻率也不會自動生成任務
- **執行一次性服務**:
  - 在服務列表頁面，一次性服務會顯示「執行服務」按鈕
  - 點擊後彈出對話框：
    - 選擇執行月份（必填）
    - 填寫收費金額（必填）
    - 選擇服務月份（用於任務，預設為執行月份）
    - 付款期限（可選，預設使用收費計劃的付款期限）
  - 系統自動完成：
    1. 檢查該年度該服務的一次性服務收費計劃是否存在，如果不存在則建立新的收費計劃（`billing_type = 'one-time'`）
    2. 在一次性服務收費計劃中新增/更新該月份，金額為填寫的金額
    3. 關聯該服務到收費計劃（如果還沒關聯）
    4. 根據任務配置，自動生成該服務的所有任務（服務月份 = 選擇的服務月份）
  - 一次性服務可以跨年度使用，每次執行時會自動建立/更新對應年度的一次性服務收費計劃
  - 一次性服務收費計劃與定期服務收費計劃完全獨立，互不影響
- **服務類型預設值自動帶入**:
  - 在 `Services` 表中新增欄位：
    - `default_service_type`（TEXT）：預設服務類型（'recurring' 或 'one-time'）
    - `default_execution_months`（TEXT，JSON 格式）：預設執行月份陣列，例如 `[1,2,3,4,5,6,7,8,9,10,11,12]`
    - `default_use_for_auto_generate`（INTEGER）：預設是否用於自動生成任務（0 或 1）
  - 新增服務時，系統自動從服務類型帶入這些預設值
  - 用戶可以修改預設值，但不需要每次都重新設定
- **任務配置自動建立（使用任務模板）**:
  - 新增服務時，系統自動檢查是否有該服務類型的任務模板（優先使用客戶專屬模板，其次使用通用模板）
  - 如果找到任務模板，系統自動套用模板並建立任務配置
  - 自動建立的任務配置包含：
    - 任務名稱、描述、階段編號：從任務模板帶入
    - 任務開始日、期限：從任務模板帶入（如果模板有設定）
    - 執行頻率：從服務層級繼承（不需要單獨設定）
    - 負責人、預估工時：從任務模板帶入（如果模板有設定）
  - 用戶可以修改自動建立的任務配置，也可以刪除不需要的任務
  - 如果沒有找到任務模板，系統提示用戶手動配置或選擇模板
- **任務配置規則**:
  - 任務名稱從服務類型下的任務類型列表下拉選擇（不是手動輸入）
  - 任務類型在系統設置中，每個服務類型下可以設置多個任務類型（ServiceItems）
  - 例如：在「記帳服務」下可以設置「收集憑證」、「掃描憑證」、「紀錄帳務」等任務類型
  - 任務模板可以在系統設置中設置，可以關聯到服務類型和客戶
  - 配置任務時可以直接套用任務模板
  - 套用模板後可以根據需要修改細節，修改不會影響原始模板
  - **任務不再需要單獨設定執行頻率**，執行頻率從服務層級繼承
- **收費計劃建立提示**:
  - 新增定期服務並保存後，系統自動提示「是否立即建立收費計劃？」
  - 如果選擇「是」，系統自動跳轉到帳務設定分頁，並預選該服務
  - 如果選擇「稍後」，系統記錄該服務尚未建立收費計劃，在服務列表中顯示提示標記

---

#### BR1.2.3: 客戶新增 - 帳務設定分頁

**User Story**: 作為會計師事務所的員工，我需要在新增客戶時設定帳務資訊和收費計劃，以便確保財務記錄準確。

**頁面結構說明**:
- 客戶新增帳務設定分頁是客戶新增頁面（ClientAdd）的一個獨立分頁（Tab）
- 路由：`/clients/add/billing` → 帳務設定分頁（ClientAddBilling.vue）

**功能需求**:
- BR1.2.3.1: 設定付款方式 ✅ 已實現
- BR1.2.3.2: 新增收費計劃（選擇年度、勾選月份、填寫金額、關聯服務）✅ 已實現
- BR1.2.3.3: 編輯收費計劃（修改月份金額、關聯服務）✅ 已實現
- BR1.2.3.4: 刪除收費計劃 ✅ 已實現
- BR1.2.3.5: 批量刪除收費記錄 ✅ 已實現
- BR1.2.3.6: 關聯多個服務到收費計劃 ✅ 已實現
- BR1.2.3.7: 為每個勾選的月份填寫不同金額 ✅ 已實現
- BR1.2.3.8: 獨立保存帳務設定 ✅ 已實現

**驗收標準**:
- WHEN 員工在新增客戶帳務設定分頁時 THEN 系統 SHALL 允許設定收費計劃
- WHEN 員工查看收費計劃時 THEN 系統 SHALL 分別顯示定期服務收費計劃和一次性服務收費計劃（可以切換查看或合併顯示）
- WHEN 員工新增定期服務收費計劃時 THEN 系統 SHALL 要求選擇年度
- WHEN 員工新增定期服務收費計劃時 THEN 系統 SHALL 允許直接勾選要收費的月份（1-12 月）
- WHEN 員工勾選月份時 THEN 系統 SHALL 為每個勾選的月份顯示金額輸入欄位
- WHEN 員工填寫月份金額時 THEN 系統 SHALL 允許為每個月份填寫不同的金額
- WHEN 員工新增定期服務收費計劃時 THEN 系統 SHALL 允許從該客戶的服務列表中選擇多個**定期服務**進行關聯
- WHEN 員工關聯服務時 THEN 系統 SHALL 只顯示該客戶已建立的**定期服務**（從 ClientServices 表中讀取，service_type = 'recurring'）
- WHEN 員工編輯收費計劃時 THEN 系統 SHALL 允許修改月份金額、新增/刪除月份、新增/刪除關聯服務
- WHEN 員工刪除收費計劃時 THEN 系統 SHALL 支援單筆刪除和批量刪除
- WHEN 員工在帳務設定分頁點擊保存時 THEN 系統 SHALL 保存帳務設定（客戶必須已存在，即已保存基本資訊）
- WHEN 員工保存帳務設定後 THEN 系統 SHALL 允許切換到其他分頁（基本資訊、服務設定）繼續填寫
- WHEN 員工未保存基本資訊就進入帳務設定分頁時 THEN 系統 SHALL 提示先保存基本資訊

**業務規則**:
- 帳務資訊與客戶基本資訊關聯
- 收費計劃按年度管理，每個年度有獨立的收費計劃
- **收費計劃類型**（見 BR1.3.3）:
  - **定期服務收費計劃**（`billing_type = 'recurring'`）：用於定期服務的收費計劃
  - **一次性服務收費計劃**（`billing_type = 'one-time'`）：用於一次性服務的收費計劃
- 定期服務收費計劃必須關聯到客戶的定期服務項目（從 ClientServices 表中選擇，service_type = 'recurring'）
- **定期服務收費計劃的建立方式**（見 BR1.3.3）:
  - 直接勾選要收費的月份（1-12 月）
  - 為每個勾選的月份填寫金額（可以不同）
  - 關聯多個定期服務到收費計劃
- **一次性服務收費計劃的建立方式**（見 BR1.3.3）:
  - 通過「執行服務」功能自動建立/更新
  - 每個一次性服務有獨立的收費計劃
  - 記錄該服務的收費月份和金額
- 付款期限（payment_due_days）：收費日期後多少天內需付款，例如 30 天
  - 可以在收費計劃層級設定預設付款期限
  - 也可以在每個月份明細中設定特定的付款期限（可選，預設使用計劃的付款期限）
- 收費計劃可以按服務項目篩選查看
- **收入分攤規則**（見 BR1.3.3）:
  - **定期服務**：多個定期服務的收費混合在一起，按執行次數比例分攤
    - 計算定期服務總收費 = Σ(定期服務收費計劃中所有月份的金額)
    - 計算每個定期服務的執行次數 = execution_months 陣列的長度
    - 計算總執行次數 = Σ(所有關聯定期服務的執行次數)
    - 每個定期服務全年的分攤收入 = 定期服務總收費 × (該服務的執行次數 / 總執行次數)
    - 每個定期服務每個月的應計收入 = 該服務全年的分攤收入 ÷ 該服務的執行次數（如果該月在 execution_months 中，則為 0）
  - **一次性服務**：每個一次性服務的收費獨立，直接使用實際金額，不分攤
    - 每個一次性服務有獨立的收費計劃（一次性服務收費計劃）
    - 每個一次性服務的應計收入 = 該服務的收費計劃中所有月份的金額總和
    - 每個一次性服務每個月的應計收入 = 該月份的金額（如果該月在收費計劃中，否則為 0）
  - 定期服務和一次性服務之間不互相影響
  - 應計收入按年度計算，跨年度不混亂

---

#### BR1.3.3: 客戶詳情頁 - 收費設定分頁

**User Story**: 作為會計師事務所的員工，我需要管理客戶帳務資訊和收費計劃，以便確保財務記錄準確並計算應計收入。

**頁面結構說明**:
- 客戶帳務資訊管理是客戶詳情頁（ClientDetail）的一個獨立分頁（Tab）
- 路由：`/clients/:id/billing` → 收費設定分頁（ClientBilling.vue）
- 包含收費計劃管理、帳務備註等功能

**功能需求**:
- BR1.3.3.1: 查看客戶收費計劃列表（按年度顯示）⚠️ 需修改（改為按年度管理）
- BR1.3.3.2: 按服務篩選收費計劃 ✅ 已實現
- BR1.3.3.3: 新增收費計劃（選擇年度、勾選月份、填寫金額、關聯服務）⚠️ 需修改（簡化為直接勾選月份）
- BR1.3.3.4: 編輯收費計劃（修改月份金額、關聯服務）⚠️ 需修改
- BR1.3.3.5: 刪除收費計劃 ✅ 已實現
- BR1.3.3.6: 批量刪除收費計劃 ✅ 已實現
- BR1.3.3.7: 關聯多個服務到收費計劃 ⚠️ 需實現（從客戶的服務列表中選擇）
- BR1.3.3.8: 為每個勾選的月份填寫不同金額 ⚠️ 需實現
- BR1.3.3.9: 查看應計收入分攤結果 ⚠️ 需實現

**驗收標準**:
- WHEN 員工查看客戶帳務資訊時 THEN 系統 SHALL 顯示收費計劃列表，包含年度、收費計劃類型、月份、金額、付款期限、關聯服務等資訊
- WHEN 員工查看收費計劃時 THEN 系統 SHALL 在頁面頂部顯示年度選擇器，預設顯示當前年度
- WHEN 員工查看收費計劃時 THEN 系統 SHALL 分別顯示定期服務收費計劃和一次性服務收費計劃（可以切換查看或合併顯示）
- WHEN 員工切換年度時 THEN 系統 SHALL 顯示該年度的收費計劃（如果存在）
- WHEN 員工切換到新年度時 THEN 系統 SHALL 自動建立該年度的**定期服務收費計劃**（如果不存在），自動複製上一年度定期服務收費計劃的月份、金額和關聯服務（不複製一次性服務收費計劃）
- WHEN 員工新增定期服務收費計劃時 THEN 系統 SHALL 要求選擇年度（如果該年度已有定期服務收費計劃，則進入編輯模式）
- WHEN 員工新增定期服務收費計劃時 THEN 系統 SHALL 允許直接勾選要收費的月份（1-12 月）
- WHEN 員工勾選月份時 THEN 系統 SHALL 為每個勾選的月份顯示金額輸入欄位
- WHEN 員工填寫月份金額時 THEN 系統 SHALL 允許為每個月份填寫不同的金額
- WHEN 員工新增定期服務收費計劃時 THEN 系統 SHALL 允許從該客戶的服務列表中選擇多個**定期服務**進行關聯
- WHEN 員工關聯服務時 THEN 系統 SHALL 只顯示該客戶已建立的**定期服務**（從 ClientServices 表中讀取，service_type = 'recurring'）
- WHEN 員工編輯收費計劃時 THEN 系統 SHALL 允許修改月份金額、新增/刪除月份、新增/刪除關聯服務
- WHEN 員工刪除收費計劃時 THEN 系統 SHALL 支援單筆刪除
- WHEN 員工選擇多筆收費計劃時 THEN 系統 SHALL 支援批量刪除
- WHEN 員工查看應計收入時 THEN 系統 SHALL 顯示每個服務的應計收入分攤結果

**業務規則**:
- 收費計劃按年度管理，每個年度有獨立的收費計劃
- **收費計劃類型**:
  - **定期服務收費計劃**（`billing_type = 'recurring'`）：用於定期服務的收費計劃
    - 可以關聯多個定期服務
    - 年度自動建立時，只複製定期服務收費計劃
  - **一次性服務收費計劃**（`billing_type = 'one-time'`）：用於一次性服務的收費計劃
    - 每個一次性服務有獨立的收費計劃
    - 不參與年度自動建立
- **新年度收費計劃自動建立**:
  - 當員工切換到新年度查看收費計劃時，如果該年度還沒有**定期服務收費計劃**，系統自動建立
  - 自動建立的收費計劃**只複製上一年度定期服務收費計劃的月份、金額和關聯服務**
  - 一次性服務收費計劃不會自動複製到新年度，因為一次性服務是臨時性的，不應該跨年度自動建立
  - 員工可以隨時修改自動建立的收費計劃（修改月份、金額、關聯服務）
  - 例如：2025 年 1 月 1 日，員工查看 2025 年收費計劃時，系統自動建立並複製 2024 年**定期服務收費計劃**（例如：記帳服務 1-12 月每月 20,000 元），但不會複製 2024 年的一次性服務收費計劃（例如：工商設立服務）
- 收費計劃必須關聯到客戶的服務項目（從 ClientServices 表中選擇）
- **定期服務收費計劃的建立方式**:
  - 直接勾選要收費的月份（1-12 月）
  - 為每個勾選的月份填寫金額（可以不同）
  - 關聯多個定期服務到收費計劃
- **一次性服務收費計劃的建立方式**:
  - 通過「執行服務」功能自動建立/更新
  - 每個一次性服務有獨立的收費計劃
  - 記錄該服務的收費月份和金額
- 付款期限（payment_due_days）：收費日期後多少天內需付款，例如 30 天
  - 可以在收費計劃層級設定預設付款期限
  - 也可以在每個月份明細中設定特定的付款期限（可選，預設使用計劃的付款期限）
- 收費計劃可以按服務項目篩選查看
- **執行一次性服務與收費計劃的協調**:
  - 執行一次性服務時，系統自動建立/更新該服務的**一次性服務收費計劃**
  - 如果該年度該服務已有一次性服務收費計劃，則更新該月份金額
  - 如果該年度該服務還沒有一次性服務收費計劃，則建立新的收費計劃並關聯該服務
  - 一次性服務收費計劃與定期服務收費計劃完全獨立，互不影響
- **收入分攤規則**:
  - **定期服務**：多個定期服務的收費混合在一起，按執行次數比例分攤
    - 計算定期服務總收費 = Σ(定期服務收費計劃中所有月份的金額)
    - 計算每個定期服務的執行次數 = execution_months 陣列的長度
    - 計算總執行次數 = Σ(所有關聯定期服務的執行次數)
    - 每個定期服務全年的分攤收入 = 定期服務總收費 × (該服務的執行次數 / 總執行次數)
    - 每個定期服務每個月的應計收入 = 該服務全年的分攤收入 ÷ 該服務的執行次數（如果該月在 execution_months 中，否則為 0）
  - **一次性服務**：每個一次性服務的收費獨立，直接使用實際金額，不分攤
    - 每個一次性服務有獨立的收費計劃（一次性服務收費計劃）
    - 每個一次性服務的應計收入 = 該服務的收費計劃中所有月份的金額總和
    - 每個一次性服務每個月的應計收入 = 該月份的金額（如果該月在收費計劃中，否則為 0）
  - 定期服務和一次性服務之間不互相影響
  - 應計收入按年度計算，跨年度不混亂

**收費計劃在其他頁面的使用**:
- **收據提醒功能**：
  - 系統會根據當月的收費計劃，檢查哪些客戶的服務已經完成所有任務，但還沒有開立收據
  - 系統會同時檢查定期服務收費計劃和一次性服務收費計劃
  - 如果該月份有收費計劃（定期服務或一次性服務），且所有任務已完成，系統會提醒開立收據
  - 提醒中會顯示收費計劃設定的金額作為建議金額（定期服務和一次性服務的金額會合併顯示）
  - 提醒條件：
    - 該月份有收費計劃（定期服務或一次性服務）
    - 該月份有任務且所有任務已完成
    - 該月份尚未開立收據（或收據已作廢）
    - 該提醒未被暫緩（postponed）
- **收據新增功能**：
  - 系統提供 API 可以根據 `client_id`、`billing_year` 和 `billing_month` 獲取建議金額
  - 建議金額來自收費計劃（定期服務收費計劃和一次性服務收費計劃的合計）
  - 如果該月份有收費計劃，系統會自動帶入建議金額和付款期限（payment_due_days）
  - 如果該月份沒有收費計劃，建議金額為 0，付款期限預設為 30 天
- **客戶詳情頁**：
  - 客戶詳情頁會顯示該客戶所有服務的收費計劃（定期服務和一次性服務）
  - 可以查看年度總收費金額（year_total，包含定期服務和一次性服務）
- **應計收入計算**：
  - 系統根據收費計劃和服務執行頻率自動計算應計收入
  - 定期服務按執行次數比例分攤定期服務收費計劃的總金額
  - 一次性服務直接使用一次性服務收費計劃的實際金額，不分攤
  - 應計收入用於成本核算和利潤分析


