# Implementation Log: Task 2.1.7

**Summary:** 创建了三个阶段管理 API 函数：1) fetchStages - 获取任务模板阶段列表，调用 GET /api/v2/settings/task-templates/:id/stages，返回阶段列表数组；2) updateStageNames - 批量更新阶段名称和顺序，调用 PUT /api/v2/settings/task-templates/:id/stages/batch，接受 stages 数组参数，返回更新结果；3) syncStages - 同步阶段变更到服务配置，调用 POST /api/v2/settings/task-templates/:id/stages/sync，接受 confirm 参数，如果未确认返回 428 错误（包含受影响的服务列表），如果已确认执行同步并返回结果。所有函数都包含完整的错误处理：验证模板 ID、捕获并记录错误、针对不同错误状态码保留原始错误信息。遵循现有 API 模式。

**Timestamp:** 2025-11-20T13:37:51.077Z
**Log ID:** 757544c0-02bd-4fd3-81a1-ea890b8f2262

---

## Statistics

- **Lines Added:** +120
- **Lines Removed:** -0
- **Files Changed:** 1
- **Net Change:** 120

## Files Modified
- src/api/task-templates.js

## Files Created
_No files created_

---

## Artifacts

### API Endpoints

#### GET /api/v2/settings/task-templates/:id/stages
- **Purpose:** 获取任务模板阶段列表
- **Location:** src/api/task-templates.js:283
- **Request Format:** Path parameter: id (number|string) - 模板ID
- **Response Format:** Success: { success: true, data: Array<{stage_id, template_id, stage_name, stage_order, description, estimated_hours, execution_frequency, execution_months, created_at, updated_at}>, message: string, request_id: string }

#### PUT /api/v2/settings/task-templates/:id/stages/batch
- **Purpose:** 批量更新阶段名称和顺序
- **Location:** src/api/task-templates.js:299
- **Request Format:** Path parameter: id (number|string) - 模板ID | Request body: { stages: Array<{stage_id: number, stage_name?: string, stage_order?: number}> }
- **Response Format:** Success: { success: true, data: { template_id, updated_count, stages }, message: string, request_id: string } | Error (422): { success: false, error: "VALIDATION_ERROR", message: string, data: { errors: Array<string> }, request_id: string }

#### POST /api/v2/settings/task-templates/:id/stages/sync
- **Purpose:** 同步阶段变更到服务配置，需要确认后才执行
- **Location:** src/api/task-templates.js:330
- **Request Format:** Path parameter: id (number|string) - 模板ID | Request body: { confirm: boolean }
- **Response Format:** Success: { success: true, data: { template_id, template_name, affected_services_count, synced_count, failed_count, stages_count, errors? }, message: string, request_id: string } | Error (428): { success: false, error: "SYNC_CONFIRMATION_REQUIRED", message: string, data: { requires_confirmation: true, template_id, template_name, affected_services_count, affected_services, stages_count, stages, message }, request_id: string }

### Functions

#### fetchStages
- **Purpose:** 获取任务模板阶段列表
- **Location:** src/api/task-templates.js:283
- **Signature:** async function fetchStages(templateId)
- **Exported:** Yes

#### updateStageNames
- **Purpose:** 批量更新阶段名称和顺序
- **Location:** src/api/task-templates.js:299
- **Signature:** async function updateStageNames(templateId, payload)
- **Exported:** Yes

#### syncStages
- **Purpose:** 同步阶段变更到使用该模板的服务配置，需要确认后才执行
- **Location:** src/api/task-templates.js:330
- **Signature:** async function syncStages(templateId, options)
- **Exported:** Yes

