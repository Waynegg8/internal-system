---
alwaysApply: true
---

# AI 自動化測試工作流程

## 核心原則

當你完成任何程式碼修改後，**必須**自動執行以下流程，不得停頓：

## 自動化流程

### 1. 修改完成後立即部署
```powershell
npm run deploy:test
```

或使用 MCP 工具：
- `deploy_pages` - 部署前端
- `deploy_worker` - 部署後端（如需要）

### 2. 部署後自動獲取 URL
- 從部署輸出中提取部署 URL
- 或使用 `get_deployment_status` MCP 工具獲取最新部署 URL

### 3. 自動執行 Playwright 測試
```powershell
$env:PLAYWRIGHT_BASE_URL="https://v2.horgoscpa.com"; $env:ENFORCE_PROD="1"; npm test
```

### 4. 測試結果處理

**如果測試通過：**
- 輸出成功訊息
- 記錄部署 URL
- 流程結束

**如果測試失敗：**
- 自動讀取測試報告（禁止啟動本地報表伺服器）
  - 讀取 `playwright-report/report.json` 分析錯誤
  - 如需人眼檢視，直接開啟靜態檔 `playwright-report/index.html`（不可使用 `npx playwright show-report` 以避免流程卡住）
- 分析失敗原因
- 創建 TODO 列表記錄問題
- 自動修復問題
- **立即返回步驟 1 重新部署**

### 4.1 失敗判定規則（務必同時滿足）
- 以指令退出碼為主：`npm test` 退出碼非 0 視為失敗
- 並行檢查報表檔案與日誌關鍵字：
  - 解析 `playwright-report/report.json`，若 `status !== 'passed'` 或存在任一測試案例失敗，視為失敗
  - 掃描標準輸出/錯誤輸出是否包含以下關鍵字，任一命中亦視為失敗：
    - `設置測試數據失敗`
    - `设置测试数据失败`
    - `Setup test data failed`
    - `setup test data failed`
    - `Test data setup failed`
    - `TimeoutError`
    - `locator.waitFor: Timeout`
    - `navigation timeout`
    - `等待逾時` / `超時`
    - `路由不存在` / `NOT_FOUND`
    - `Unauthorized` / `未授權` / `401`
    - `Forbidden` / `無權限` / `403`
    - `Internal Server Error` / `伺服器錯誤` / `500`
    - `Bad Request` / `400`
    - `Service Unavailable` / `503`
    - `NetworkError` / `net::ERR_` / `ECONNREFUSED` / `ECONNRESET` / `ETIMEDOUT` / `ENOTFOUND`
    - `SSR error` / `渲染錯誤`
    - `Playwright error` / `page.goto:`
  - 命中關鍵字時，須將其歸類為「前置數據準備失敗」並在 TODO 中單獨標記

### 4.2 失敗分類與後續動作
- 前置數據準備失敗（上述關鍵字命中）：
  - 檢查測試前置 API 路由、權限、測試帳號/Token、測試資料依賴
  - 先修復測試資料準備腳本或後端路由，再重跑全部測試
- 一般測試斷言失敗：
  - 從 `report.json` 抽取對應測試檔名、案例標題、錯誤訊息、截圖/追蹤檔路徑加入 TODO
  - 修復後立即重跑
- 逾時/元素不可見：
  - 標記為「UI 元素等待逾時」，檢查選擇器穩定性、等待條件、動畫/遮罩
  - 必要時在 UI 加入可觀測標記或顯式可見條件
- 路由不存在/404：
  - 標記為「後端路由缺失」，比對 `backend/src/router/**` 與對應 handler 是否正確綁定
  - 檢查部署分支與 API base URL
- 權限錯誤（401/403）：
  - 標記為「權限/登入問題」，檢查測試用帳號、權限種子資料、JWT/Session 與測試前置登入流程
- 伺服器錯誤（5xx）：
  - 標記為「後端例外」，優先查看 Worker logs 與對應 handler 的錯誤堆疊
- 網路錯誤（連線失敗/解析失敗）：
  - 標記為「部署/網路問題」，驗證部署 URL、DNS、服務是否可達，必要時重新部署

### 5. 額外驗證（可選）
- 使用 `get_worker_logs` MCP 工具檢查日誌
- 使用 Browser MCP 工具進行手動驗證（如需要）

## 重要提醒

1. **嚴禁停頓**：看到 "Deployment complete" 後必須立即執行測試
2. **自動循環**：測試失敗後必須自動修復並重新部署
3. **完整記錄**：所有步驟都要有清楚的輸出訊息
4. **錯誤處理**：任何步驟失敗都要有明確的錯誤訊息和後續動作

## 生產環境部署要求

### 部署到生產環境
完成測試並確認無誤後，**必須**部署到生產環境：

```powershell
# 建置前端
npm run build

# 部署到生產環境（production branch）
npx wrangler pages deploy dist --project-name=horgoscpa-internal-v2 --branch=production
```

或使用 MCP 工具：
- `deploy_pages` - 部署前端（確保使用 production branch）

### Spec Workflow Dashboard 要求

**每次啟動工作前，必須確保：**

1. **Dashboard 已啟動**：
   ```powershell
   npm run spec:dashboard
   ```
   - Dashboard 運行在 http://localhost:5000
   - 必須顯示項目已連接（不是 "No Projects Available"）

2. **MCP 服務器已註冊**：
   ```powershell
   npm run spec:server
   ```
   - 在另一個終端啟動 MCP 服務器（不帶 `--dashboard` 參數）
   - 確保 Dashboard 顯示 "已连接" 和項目名稱

3. **驗證連接狀態**：
   - 使用 Browser MCP 工具訪問 http://localhost:5000
   - 確認顯示項目名稱（如 "system-new"）
   - 確認連接狀態為 "已连接"（不是 "已断开连接"）

**如果 Dashboard 顯示 "No Projects Available"：**
1. 停止現有的 Dashboard 進程
2. 重新啟動 Dashboard：`npm run spec:dashboard`
3. 在另一個終端啟動 MCP 服務器：`npm run spec:server`
4. 等待 5-10 秒讓服務器註冊
5. 刷新 Dashboard 頁面驗證連接

## 範例工作流程

```
1. 修改程式碼
2. 執行: npm run deploy:test
3. 等待部署完成
4. 自動執行測試
5. 如果失敗 → 分析 → 修復 → 返回步驟 2
6. 如果成功 → 部署到生產環境
7. 確保 Spec Workflow Dashboard 正常運行
8. 完成
```
